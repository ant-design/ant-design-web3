"use strict";(self.webpackChunk_ant_design_web3_docs=self.webpackChunk_ant_design_web3_docs||[]).push([[1303],{31303:function(ab,Qh,se){se.d(Qh,{EthereumProvider:function(){return bg}});var At=se(72100),Er=se.n(At),d=se(71586),Yh=se(53070),wi=se(19994),te=se(56526),_i=se(36900);class Zh extends _i.q{constructor(r){super(),this.opts=r,this.protocol="wc",this.version=2}}class ob{constructor(r,s,a){this.core=r,this.logger=s}}class Xh extends _i.q{constructor(r,s){super(),this.core=r,this.logger=s,this.records=new Map}}class eu{constructor(r,s){this.logger=r,this.core=s}}class tu extends _i.q{constructor(r,s){super(),this.relayer=r,this.logger=s}}class iu extends _i.q{constructor(r){super()}}class su{constructor(r,s,a,o){this.core=r,this.logger=s,this.name=a}}class cb{constructor(){this.map=new Map}}class ru extends _i.q{constructor(r,s){super(),this.relayer=r,this.logger=s}}class hb{constructor(r,s){this.core=r,this.logger=s}}class nu extends _i.q{constructor(r,s){super(),this.core=r,this.logger=s}}class ub{constructor(r,s){this.logger=r,this.core=s}}class au{constructor(r,s,a){this.core=r,this.logger=s,this.store=a}}class ou{constructor(r,s){this.projectId=r,this.logger=s}}class cu{constructor(r,s,a){this.core=r,this.logger=s,this.telemetryEnabled=a}}class lb extends null{constructor(){super()}}class hu{constructor(r){this.opts=r,this.protocol="wc",this.version=2}}class pb extends null{constructor(){super()}}class uu{constructor(r){this.client=r}}var Ir=se(41926),bi=se(70083),lu=se(90032),F=se(46196),ct=se(56390),K=se(23700),pu=se(66865),du=se(5899),gu=se.n(du);function fu(y,r){if(y.length>=255)throw new TypeError("Alphabet too long");for(var s=new Uint8Array(256),a=0;a<s.length;a++)s[a]=255;for(var o=0;o<y.length;o++){var u=y.charAt(o),l=u.charCodeAt(0);if(s[l]!==255)throw new TypeError(u+" is ambiguous");s[l]=o}var m=y.length,_=y.charAt(0),I=Math.log(m)/Math.log(256),T=Math.log(256)/Math.log(m);function O(N){if(N instanceof Uint8Array||(ArrayBuffer.isView(N)?N=new Uint8Array(N.buffer,N.byteOffset,N.byteLength):Array.isArray(N)&&(N=Uint8Array.from(N))),!(N instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(N.length===0)return"";for(var j=0,M=0,$=0,G=N.length;$!==G&&N[$]===0;)$++,j++;for(var ae=(G-$)*T+1>>>0,B=new Uint8Array(ae);$!==G;){for(var J=N[$],fe=0,de=ae-1;(J!==0||fe<M)&&de!==-1;de--,fe++)J+=256*B[de]>>>0,B[de]=J%m>>>0,J=J/m>>>0;if(J!==0)throw new Error("Non-zero carry");M=fe,$++}for(var oe=ae-M;oe!==ae&&B[oe]===0;)oe++;for(var gt=_.repeat(j);oe<ae;++oe)gt+=y.charAt(B[oe]);return gt}function q(N){if(typeof N!="string")throw new TypeError("Expected String");if(N.length===0)return new Uint8Array;var j=0;if(N[j]!==" "){for(var M=0,$=0;N[j]===_;)M++,j++;for(var G=(N.length-j)*I+1>>>0,ae=new Uint8Array(G);N[j];){var B=s[N.charCodeAt(j)];if(B===255)return;for(var J=0,fe=G-1;(B!==0||J<$)&&fe!==-1;fe--,J++)B+=m*ae[fe]>>>0,ae[fe]=B%256>>>0,B=B/256>>>0;if(B!==0)throw new Error("Non-zero carry");$=J,j++}if(N[j]!==" "){for(var de=G-$;de!==G&&ae[de]===0;)de++;for(var oe=new Uint8Array(M+(G-de)),gt=M;de!==G;)oe[gt++]=ae[de++];return oe}}}function A(N){var j=q(N);if(j)return j;throw new Error(`Non-${r} character`)}return{encode:O,decodeUnsafe:q,decode:A}}var yu=fu,mu=yu;const da=y=>{if(y instanceof Uint8Array&&y.constructor.name==="Uint8Array")return y;if(y instanceof ArrayBuffer)return new Uint8Array(y);if(ArrayBuffer.isView(y))return new Uint8Array(y.buffer,y.byteOffset,y.byteLength);throw new Error("Unknown type, must be binary type")},vu=y=>new TextEncoder().encode(y),wu=y=>new TextDecoder().decode(y);class _u{constructor(r,s,a){this.name=r,this.prefix=s,this.baseEncode=a}encode(r){if(r instanceof Uint8Array)return`${this.prefix}${this.baseEncode(r)}`;throw Error("Unknown type, must be binary type")}}class bu{constructor(r,s,a){if(this.name=r,this.prefix=s,s.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s.codePointAt(0),this.baseDecode=a}decode(r){if(typeof r=="string"){if(r.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(r)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(r.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(r){return ga(this,r)}}class Eu{constructor(r){this.decoders=r}or(r){return ga(this,r)}decode(r){const s=r[0],a=this.decoders[s];if(a)return a.decode(r);throw RangeError(`Unable to decode multibase string ${JSON.stringify(r)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const ga=(y,r)=>new Eu({...y.decoders||{[y.prefix]:y},...r.decoders||{[r.prefix]:r}});class Iu{constructor(r,s,a,o){this.name=r,this.prefix=s,this.baseEncode=a,this.baseDecode=o,this.encoder=new _u(r,s,a),this.decoder=new bu(r,s,o)}encode(r){return this.encoder.encode(r)}decode(r){return this.decoder.decode(r)}}const Ps=({name:y,prefix:r,encode:s,decode:a})=>new Iu(y,r,s,a),Ji=({prefix:y,name:r,alphabet:s})=>{const{encode:a,decode:o}=mu(s,r);return Ps({prefix:y,name:r,encode:a,decode:u=>da(o(u))})},Pu=(y,r,s,a)=>{const o={};for(let T=0;T<r.length;++T)o[r[T]]=T;let u=y.length;for(;y[u-1]==="=";)--u;const l=new Uint8Array(u*s/8|0);let m=0,_=0,I=0;for(let T=0;T<u;++T){const O=o[y[T]];if(O===void 0)throw new SyntaxError(`Non-${a} character`);_=_<<s|O,m+=s,m>=8&&(m-=8,l[I++]=255&_>>m)}if(m>=s||255&_<<8-m)throw new SyntaxError("Unexpected end of data");return l},Cu=(y,r,s)=>{const a=r[r.length-1]==="=",o=(1<<s)-1;let u="",l=0,m=0;for(let _=0;_<y.length;++_)for(m=m<<8|y[_],l+=8;l>s;)l-=s,u+=r[o&m>>l];if(l&&(u+=r[o&m<<s-l]),a)for(;u.length*s&7;)u+="=";return u},Ae=({name:y,prefix:r,bitsPerChar:s,alphabet:a})=>Ps({prefix:r,name:y,encode(o){return Cu(o,a,s)},decode(o){return Pu(o,a,s,y)}}),Su=Ps({prefix:"\0",name:"identity",encode:y=>wu(y),decode:y=>vu(y)});var xu=Object.freeze({__proto__:null,identity:Su});const Ru=Ae({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Tu=Object.freeze({__proto__:null,base2:Ru});const Ou=Ae({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Au=Object.freeze({__proto__:null,base8:Ou});const qu=Ji({prefix:"9",name:"base10",alphabet:"0123456789"});var Du=Object.freeze({__proto__:null,base10:qu});const Nu=Ae({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Fu=Ae({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ku=Object.freeze({__proto__:null,base16:Nu,base16upper:Fu});const Mu=Ae({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),$u=Ae({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ju=Ae({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Lu=Ae({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),zu=Ae({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Uu=Ae({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Hu=Ae({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ku=Ae({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Vu=Ae({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Bu=Object.freeze({__proto__:null,base32:Mu,base32upper:$u,base32pad:ju,base32padupper:Lu,base32hex:zu,base32hexupper:Uu,base32hexpad:Hu,base32hexpadupper:Ku,base32z:Vu});const Ju=Ji({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Gu=Ji({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Wu=Object.freeze({__proto__:null,base36:Ju,base36upper:Gu});const Qu=Ji({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Yu=Ji({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Zu=Object.freeze({__proto__:null,base58btc:Qu,base58flickr:Yu});const Xu=Ae({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),el=Ae({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),tl=Ae({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),il=Ae({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var sl=Object.freeze({__proto__:null,base64:Xu,base64pad:el,base64url:tl,base64urlpad:il});const fa=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),rl=fa.reduce((y,r,s)=>(y[s]=r,y),[]),nl=fa.reduce((y,r,s)=>(y[r.codePointAt(0)]=s,y),[]);function al(y){return y.reduce((r,s)=>(r+=rl[s],r),"")}function ol(y){const r=[];for(const s of y){const a=nl[s.codePointAt(0)];if(a===void 0)throw new Error(`Non-base256emoji character: ${s}`);r.push(a)}return new Uint8Array(r)}const cl=Ps({prefix:"\u{1F680}",name:"base256emoji",encode:al,decode:ol});var hl=Object.freeze({__proto__:null,base256emoji:cl}),ul=ma,ya=128,ll=127,pl=~ll,dl=Math.pow(2,31);function ma(y,r,s){r=r||[],s=s||0;for(var a=s;y>=dl;)r[s++]=y&255|ya,y/=128;for(;y&pl;)r[s++]=y&255|ya,y>>>=7;return r[s]=y|0,ma.bytes=s-a+1,r}var gl=Pr,fl=128,va=127;function Pr(y,a){var s=0,a=a||0,o=0,u=a,l,m=y.length;do{if(u>=m)throw Pr.bytes=0,new RangeError("Could not decode varint");l=y[u++],s+=o<28?(l&va)<<o:(l&va)*Math.pow(2,o),o+=7}while(l>=fl);return Pr.bytes=u-a,s}var yl=Math.pow(2,7),ml=Math.pow(2,14),vl=Math.pow(2,21),wl=Math.pow(2,28),_l=Math.pow(2,35),bl=Math.pow(2,42),El=Math.pow(2,49),Il=Math.pow(2,56),Pl=Math.pow(2,63),Cl=function(y){return y<yl?1:y<ml?2:y<vl?3:y<wl?4:y<_l?5:y<bl?6:y<El?7:y<Il?8:y<Pl?9:10},Sl={encode:ul,decode:gl,encodingLength:Cl},wa=Sl;const _a=(y,r,s=0)=>(wa.encode(y,r,s),r),ba=y=>wa.encodingLength(y),Cr=(y,r)=>{const s=r.byteLength,a=ba(y),o=a+ba(s),u=new Uint8Array(o+s);return _a(y,u,0),_a(s,u,a),u.set(r,o),new xl(y,s,r,u)};class xl{constructor(r,s,a,o){this.code=r,this.size=s,this.digest=a,this.bytes=o}}const Ea=({name:y,code:r,encode:s})=>new Rl(y,r,s);class Rl{constructor(r,s,a){this.name=r,this.code=s,this.encode=a}digest(r){if(r instanceof Uint8Array){const s=this.encode(r);return s instanceof Uint8Array?Cr(this.code,s):s.then(a=>Cr(this.code,a))}else throw Error("Unknown type, must be binary type")}}const Ia=y=>async r=>new Uint8Array(await crypto.subtle.digest(y,r)),Tl=Ea({name:"sha2-256",code:18,encode:Ia("SHA-256")}),Ol=Ea({name:"sha2-512",code:19,encode:Ia("SHA-512")});var Al=Object.freeze({__proto__:null,sha256:Tl,sha512:Ol});const Pa=0,ql="identity",Ca=da;var Dl=Object.freeze({__proto__:null,identity:{code:Pa,name:ql,encode:Ca,digest:y=>Cr(Pa,Ca(y))}});new TextEncoder,new TextDecoder;const Sa={...xu,...Tu,...Au,...Du,...ku,...Bu,...Wu,...Zu,...sl,...hl};({...Al,...Dl});function Nl(y=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(y):new Uint8Array(y)}function xa(y,r,s,a){return{name:y,prefix:r,encoder:{name:y,prefix:r,encode:s},decoder:{decode:a}}}const Ra=xa("utf8","u",y=>"u"+new TextDecoder("utf8").decode(y),y=>new TextEncoder().encode(y.substring(1))),Sr=xa("ascii","a",y=>{let r="a";for(let s=0;s<y.length;s++)r+=String.fromCharCode(y[s]);return r},y=>{y=y.substring(1);const r=Nl(y.length);for(let s=0;s<y.length;s++)r[s]=y.charCodeAt(s);return r}),Fl={utf8:Ra,"utf-8":Ra,hex:Sa.base16,latin1:Sr,ascii:Sr,binary:Sr,...Sa};function kl(y,r="utf8"){const s=Fl[r];if(!s)throw new Error(`Unsupported encoding "${r}"`);return(r==="utf8"||r==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(y,"utf8"):s.decoder.decode(`${s.prefix}${y}`)}const Ta="wc",Oa=2,xr="core",bt=`${Ta}@2:${xr}:`,Ml={name:xr,logger:"error"},$l={database:":memory:"},jl="crypto",Aa="client_ed25519_seed",Ll=F.ONE_DAY,zl="keychain",Ul="0.3",Hl="messages",Kl="0.3",Vl=F.SIX_HOURS,Bl="publisher",qa="irn",Jl="error",Da="wss://relay.walletconnect.org",Gl="relayer",ke={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Wl="_subscription",Ze={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},Ql=.1,fb={database:":memory:"},Na="2.16.1",yb=1e4,pe={link_mode:"link_mode",relay:"relay"},Yl="0.3",Zl="WALLETCONNECT_CLIENT_ID",Fa="WALLETCONNECT_LINK_MODE_APPS",Et={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},mb=null,Xl="subscription",ep="0.3",tp=F.FIVE_SECONDS*1e3,ip="pairing",sp="0.3",vb=null,Gi={wc_pairingDelete:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:F.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:F.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:F.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:F.ONE_DAY,prompt:!1,tag:0},res:{ttl:F.ONE_DAY,prompt:!1,tag:0}}},Ei={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},ht={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},rp="history",np="0.3",ap="expirer",Xe={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},op="0.3",wb=null,cp="verify-api",hp="https://verify.walletconnect.com",ka="https://verify.walletconnect.org",Wi=ka,up=`${Wi}/v3`,lp=[hp,ka],pp="echo",dp="https://echo.walletconnect.com",_b="event-client",It={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},qt={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},ut={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},si={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},ri={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},Qi={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},gp=.1,fp="event-client",yp=86400,mp="https://pulse.walletconnect.com/batch";class vp{constructor(r,s){this.core=r,this.logger=s,this.keychain=new Map,this.name=zl,this.version=Ul,this.initialized=!1,this.storagePrefix=bt,this.init=async()=>{if(!this.initialized){const a=await this.getKeyChain();typeof a<"u"&&(this.keychain=a),this.initialized=!0}},this.has=a=>(this.isInitialized(),this.keychain.has(a)),this.set=async(a,o)=>{this.isInitialized(),this.keychain.set(a,o),await this.persist()},this.get=a=>{this.isInitialized();const o=this.keychain.get(a);if(typeof o>"u"){const{message:u}=(0,d.kCb)("NO_MATCHING_KEY",`${this.name}: ${a}`);throw new Error(u)}return o},this.del=async a=>{this.isInitialized(),this.keychain.delete(a),await this.persist()},this.core=r,this.logger=(0,te.Ep)(s,this.name)}get context(){return(0,te.Fd)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(r){await this.core.storage.setItem(this.storageKey,(0,d.KCv)(r))}async getKeyChain(){const r=await this.core.storage.getItem(this.storageKey);return typeof r<"u"?(0,d.IPd)(r):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}}class wp{constructor(r,s,a){this.core=r,this.logger=s,this.name=jl,this.randomSessionIdentifier=(0,d.jdp)(),this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=o=>(this.isInitialized(),this.keychain.has(o)),this.getClientId=async()=>{this.isInitialized();const o=await this.getClientSeed(),u=bi.generateKeyPair(o);return bi.encodeIss(u.publicKey)},this.generateKeyPair=()=>{this.isInitialized();const o=(0,d.Au2)();return this.setPrivateKey(o.publicKey,o.privateKey)},this.signJWT=async o=>{this.isInitialized();const u=await this.getClientSeed(),l=bi.generateKeyPair(u),m=this.randomSessionIdentifier,_=Ll;return await bi.signJWT(m,o,_,l)},this.generateSharedKey=(o,u,l)=>{this.isInitialized();const m=this.getPrivateKey(o),_=(0,d.m$A)(m,u);return this.setSymKey(_,l)},this.setSymKey=async(o,u)=>{this.isInitialized();const l=u||(0,d.YmJ)(o);return await this.keychain.set(l,o),l},this.deleteKeyPair=async o=>{this.isInitialized(),await this.keychain.del(o)},this.deleteSymKey=async o=>{this.isInitialized(),await this.keychain.del(o)},this.encode=async(o,u,l)=>{this.isInitialized();const m=(0,d.ENt)(l),_=(0,Ir.u)(u);if((0,d.Hs$)(m))return(0,d.Spz)(_,l==null?void 0:l.encoding);if((0,d.Q8x)(m)){const q=m.senderPublicKey,A=m.receiverPublicKey;o=await this.generateSharedKey(q,A)}const I=this.getSymKey(o),{type:T,senderPublicKey:O}=m;return(0,d.HIp)({type:T,symKey:I,message:_,senderPublicKey:O,encoding:l==null?void 0:l.encoding})},this.decode=async(o,u,l)=>{this.isInitialized();const m=(0,d.Llj)(u,l);if((0,d.Hs$)(m)){const _=(0,d.xQU)(u,l==null?void 0:l.encoding);return(0,Ir.D)(_)}if((0,d.Q8x)(m)){const _=m.receiverPublicKey,I=m.senderPublicKey;o=await this.generateSharedKey(_,I)}try{const _=this.getSymKey(o),I=(0,d.peR)({symKey:_,encoded:u,encoding:l==null?void 0:l.encoding});return(0,Ir.D)(I)}catch(_){this.logger.error(`Failed to decode message from topic: '${o}', clientId: '${await this.getClientId()}'`),this.logger.error(_)}},this.getPayloadType=(o,u=d.$dT)=>{const l=(0,d.vBi)({encoded:o,encoding:u});return(0,d.WGe)(l.type)},this.getPayloadSenderPublicKey=(o,u=d.$dT)=>{const l=(0,d.vBi)({encoded:o,encoding:u});return l.senderPublicKey?(0,lu.BB)(l.senderPublicKey,d.AWt):void 0},this.core=r,this.logger=(0,te.Ep)(s,this.name),this.keychain=a||new vp(this.core,this.logger)}get context(){return(0,te.Fd)(this.logger)}async setPrivateKey(r,s){return await this.keychain.set(r,s),r}getPrivateKey(r){return this.keychain.get(r)}async getClientSeed(){let r="";try{r=this.keychain.get(Aa)}catch{r=(0,d.jdp)(),await this.keychain.set(Aa,r)}return kl(r,"base16")}getSymKey(r){return this.keychain.get(r)}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}}class _p extends eu{constructor(r,s){super(r,s),this.logger=r,this.core=s,this.messages=new Map,this.name=Hl,this.version=Kl,this.initialized=!1,this.storagePrefix=bt,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const a=await this.getRelayerMessages();typeof a<"u"&&(this.messages=a),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(a){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(a)}finally{this.initialized=!0}}},this.set=async(a,o)=>{this.isInitialized();const u=(0,d.rjm)(o);let l=this.messages.get(a);return typeof l>"u"&&(l={}),typeof l[u]<"u"||(l[u]=o,this.messages.set(a,l),await this.persist()),u},this.get=a=>{this.isInitialized();let o=this.messages.get(a);return typeof o>"u"&&(o={}),o},this.has=(a,o)=>{this.isInitialized();const u=this.get(a),l=(0,d.rjm)(o);return typeof u[l]<"u"},this.del=async a=>{this.isInitialized(),this.messages.delete(a),await this.persist()},this.logger=(0,te.Ep)(r,this.name),this.core=s}get context(){return(0,te.Fd)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setRelayerMessages(r){await this.core.storage.setItem(this.storageKey,(0,d.KCv)(r))}async getRelayerMessages(){const r=await this.core.storage.getItem(this.storageKey);return typeof r<"u"?(0,d.IPd)(r):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}}class bp extends tu{constructor(r,s){super(r,s),this.relayer=r,this.logger=s,this.events=new At.EventEmitter,this.name=Bl,this.queue=new Map,this.publishTimeout=(0,F.toMiliseconds)(F.ONE_MINUTE),this.failedPublishTimeout=(0,F.toMiliseconds)(F.ONE_SECOND),this.needsTransportRestart=!1,this.publish=async(a,o,u)=>{var l;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:a,message:o,opts:u}});const m=(u==null?void 0:u.ttl)||Vl,_=(0,d._HE)(u),I=(u==null?void 0:u.prompt)||!1,T=(u==null?void 0:u.tag)||0,O=(u==null?void 0:u.id)||(0,K.getBigIntRpcId)().toString(),q={topic:a,message:o,opts:{ttl:m,relay:_,prompt:I,tag:T,id:O,attestation:u==null?void 0:u.attestation}},A=`Failed to publish payload, please try again. id:${O} tag:${T}`,N=Date.now();let j,M=1;try{for(;j===void 0;){if(Date.now()-N>this.publishTimeout)throw new Error(A);this.logger.trace({id:O,attempts:M},`publisher.publish - attempt ${M}`),j=await await(0,d.hFY)(this.rpcPublish(a,o,m,_,I,T,O,u==null?void 0:u.attestation).catch($=>this.logger.warn($)),this.publishTimeout,A),M++,j||await new Promise($=>setTimeout($,this.failedPublishTimeout))}this.relayer.events.emit(ke.publish,q),this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{id:O,topic:a,message:o,opts:u}})}catch($){if(this.logger.debug("Failed to Publish Payload"),this.logger.error($),(l=u==null?void 0:u.internal)!=null&&l.throwOnFailedPublish)throw $;this.queue.set(O,q)}},this.on=(a,o)=>{this.events.on(a,o)},this.once=(a,o)=>{this.events.once(a,o)},this.off=(a,o)=>{this.events.off(a,o)},this.removeListener=(a,o)=>{this.events.removeListener(a,o)},this.relayer=r,this.logger=(0,te.Ep)(s,this.name),this.registerEventListeners()}get context(){return(0,te.Fd)(this.logger)}rpcPublish(r,s,a,o,u,l,m,_){var I,T,O,q;const A={method:(0,d.cOS)(o.protocol).publish,params:{topic:r,message:s,ttl:a,prompt:u,tag:l,attestation:_},id:m};return(0,d.o8e)((I=A.params)==null?void 0:I.prompt)&&((T=A.params)==null||delete T.prompt),(0,d.o8e)((O=A.params)==null?void 0:O.tag)&&((q=A.params)==null||delete q.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:A}),this.relayer.request(A)}removeRequestFromQueue(r){this.queue.delete(r)}checkQueue(){this.queue.forEach(async r=>{const{topic:s,message:a,opts:o}=r;await this.publish(s,a,o)})}registerEventListeners(){this.relayer.core.heartbeat.on(wi.Lx.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(ke.connection_stalled);return}this.checkQueue()}),this.relayer.on(ke.message_ack,r=>{this.removeRequestFromQueue(r.id.toString())})}}class Ep{constructor(){this.map=new Map,this.set=(r,s)=>{const a=this.get(r);this.exists(r,s)||this.map.set(r,[...a,s])},this.get=r=>this.map.get(r)||[],this.exists=(r,s)=>this.get(r).includes(s),this.delete=(r,s)=>{if(typeof s>"u"){this.map.delete(r);return}if(!this.map.has(r))return;const a=this.get(r);if(!this.exists(r,s))return;const o=a.filter(u=>u!==s);if(!o.length){this.map.delete(r);return}this.map.set(r,o)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var Ip=Object.defineProperty,Pp=Object.defineProperties,Cp=Object.getOwnPropertyDescriptors,Ma=Object.getOwnPropertySymbols,Sp=Object.prototype.hasOwnProperty,xp=Object.prototype.propertyIsEnumerable,$a=(y,r,s)=>r in y?Ip(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Yi=(y,r)=>{for(var s in r||(r={}))Sp.call(r,s)&&$a(y,s,r[s]);if(Ma)for(var s of Ma(r))xp.call(r,s)&&$a(y,s,r[s]);return y},Rr=(y,r)=>Pp(y,Cp(r));class Rp extends ru{constructor(r,s){super(r,s),this.relayer=r,this.logger=s,this.subscriptions=new Map,this.topicMap=new Ep,this.events=new At.EventEmitter,this.name=Xl,this.version=ep,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=bt,this.subscribeTimeout=(0,F.toMiliseconds)(F.ONE_MINUTE),this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.pendingBatchMessages=[],this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),this.clientId=await this.relayer.core.crypto.getClientId(),await this.restore()),this.initialized=!0},this.subscribe=async(a,o)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:a,opts:o}});try{const u=(0,d._HE)(o),l={topic:a,relay:u,transportType:o==null?void 0:o.transportType};this.pending.set(a,l);const m=await this.rpcSubscribe(a,u,o==null?void 0:o.transportType);return typeof m=="string"&&(this.onSubscribe(m,l),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:a,opts:o}})),m}catch(u){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(u),u}},this.unsubscribe=async(a,o)=>{await this.restartToComplete(),this.isInitialized(),typeof(o==null?void 0:o.id)<"u"?await this.unsubscribeById(a,o.id,o):await this.unsubscribeByTopic(a,o)},this.isSubscribed=async a=>{if(this.topics.includes(a))return!0;const o=`${this.pendingSubscriptionWatchLabel}_${a}`;return await new Promise((u,l)=>{const m=new F.Watch;m.start(o);const _=setInterval(()=>{!this.pending.has(a)&&this.topics.includes(a)&&(clearInterval(_),m.stop(o),u(!0)),m.elapsed(o)>=tp&&(clearInterval(_),m.stop(o),l(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1)},this.on=(a,o)=>{this.events.on(a,o)},this.once=(a,o)=>{this.events.once(a,o)},this.off=(a,o)=>{this.events.off(a,o)},this.removeListener=(a,o)=>{this.events.removeListener(a,o)},this.start=async()=>{await this.onConnect()},this.stop=async()=>{await this.onDisconnect()},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=r,this.logger=(0,te.Ep)(s,this.name),this.clientId=""}get context(){return(0,te.Fd)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(r,s){let a=!1;try{a=this.getSubscription(r).topic===s}catch{}return a}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(r,s){const a=this.topicMap.get(r);await Promise.all(a.map(async o=>await this.unsubscribeById(r,o,s)))}async unsubscribeById(r,s,a){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:r,id:s,opts:a}});try{const o=(0,d._HE)(a);await this.rpcUnsubscribe(r,s,o);const u=(0,d.D6H)("USER_DISCONNECTED",`${this.name}, ${r}`);await this.onUnsubscribe(r,s,u),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:r,id:s,opts:a}})}catch(o){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(o),o}}async rpcSubscribe(r,s,a=pe.relay){a===pe.relay&&await this.restartToComplete();const o={method:(0,d.cOS)(s.protocol).subscribe,params:{topic:r}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:o});try{const u=(0,d.rjm)(r+this.clientId);return a===pe.link_mode?(setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(o).catch(l=>this.logger.warn(l))},(0,F.toMiliseconds)(F.ONE_SECOND)),u):await await(0,d.hFY)(this.relayer.request(o).catch(l=>this.logger.warn(l)),this.subscribeTimeout)?u:null}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(ke.connection_stalled)}return null}async rpcBatchSubscribe(r){if(!r.length)return;const s=r[0].relay,a={method:(0,d.cOS)(s.protocol).batchSubscribe,params:{topics:r.map(o=>o.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:a});try{return await await(0,d.hFY)(this.relayer.request(a).catch(o=>this.logger.warn(o)),this.subscribeTimeout)}catch{this.relayer.events.emit(ke.connection_stalled)}}async rpcBatchFetchMessages(r){if(!r.length)return;const s=r[0].relay,a={method:(0,d.cOS)(s.protocol).batchFetchMessages,params:{topics:r.map(u=>u.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:a});let o;try{o=await await(0,d.hFY)(this.relayer.request(a).catch(u=>this.logger.warn(u)),this.subscribeTimeout)}catch{this.relayer.events.emit(ke.connection_stalled)}return o}rpcUnsubscribe(r,s,a){const o={method:(0,d.cOS)(a.protocol).unsubscribe,params:{topic:r,id:s}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:o}),this.relayer.request(o)}onSubscribe(r,s){this.setSubscription(r,Rr(Yi({},s),{id:r})),this.pending.delete(s.topic)}onBatchSubscribe(r){r.length&&r.forEach(s=>{this.setSubscription(s.id,Yi({},s)),this.pending.delete(s.topic)})}async onUnsubscribe(r,s,a){this.events.removeAllListeners(s),this.hasSubscription(s,r)&&this.deleteSubscription(s,a),await this.relayer.messages.del(r)}async setRelayerSubscriptions(r){await this.relayer.core.storage.setItem(this.storageKey,r)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(r,s){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:r,subscription:s}),this.addSubscription(r,s)}addSubscription(r,s){this.subscriptions.set(r,Yi({},s)),this.topicMap.set(s.topic,r),this.events.emit(Et.created,s)}getSubscription(r){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:r});const s=this.subscriptions.get(r);if(!s){const{message:a}=(0,d.kCb)("NO_MATCHING_KEY",`${this.name}: ${r}`);throw new Error(a)}return s}deleteSubscription(r,s){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:r,reason:s});const a=this.getSubscription(r);this.subscriptions.delete(r),this.topicMap.delete(a.topic,r),this.events.emit(Et.deleted,Rr(Yi({},a),{reason:s}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Et.sync)}async reset(){if(this.cached.length){const r=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let s=0;s<r;s++){const a=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchFetchMessages(a),await this.batchSubscribe(a)}}this.events.emit(Et.resubscribed)}async restore(){try{const r=await this.getRelayerSubscriptions();if(typeof r>"u"||!r.length)return;if(this.subscriptions.size){const{message:s}=(0,d.kCb)("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(s)}this.cached=r,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(r){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(r)}}async batchSubscribe(r){if(!r.length)return;const s=await this.rpcBatchSubscribe(r);(0,d.qt8)(s)&&this.onBatchSubscribe(s.map((a,o)=>Rr(Yi({},r[o]),{id:a})))}async batchFetchMessages(r){if(!r.length)return;this.logger.trace(`Fetching batch messages for ${r.length} subscriptions`);const s=await this.rpcBatchFetchMessages(r);s&&s.messages&&(this.pendingBatchMessages=this.pendingBatchMessages.concat(s.messages))}async onConnect(){await this.restart(),this.onEnable()}onDisconnect(){this.onDisable()}async checkPending(){if(!this.initialized||!this.relayer.connected)return;const r=[];this.pending.forEach(s=>{r.push(s)}),await this.batchSubscribe(r),this.pendingBatchMessages.length&&(await this.relayer.handleBatchMessageEvents(this.pendingBatchMessages),this.pendingBatchMessages=[])}registerEventListeners(){this.relayer.core.heartbeat.on(wi.Lx.pulse,async()=>{await this.checkPending()}),this.events.on(Et.created,async r=>{const s=Et.created;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),await this.persist()}),this.events.on(Et.deleted,async r=>{const s=Et.deleted;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}async restartToComplete(){!this.relayer.connected&&!this.relayer.connecting&&await this.relayer.transportOpen(),this.restartInProgress&&await new Promise(r=>{const s=setInterval(()=>{this.restartInProgress||(clearInterval(s),r())},this.pollingInterval)})}}var Tp=Object.defineProperty,ja=Object.getOwnPropertySymbols,Op=Object.prototype.hasOwnProperty,Ap=Object.prototype.propertyIsEnumerable,La=(y,r,s)=>r in y?Tp(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,qp=(y,r)=>{for(var s in r||(r={}))Op.call(r,s)&&La(y,s,r[s]);if(ja)for(var s of ja(r))Ap.call(r,s)&&La(y,s,r[s]);return y};class Dp extends iu{constructor(r){super(r),this.protocol="wc",this.version=2,this.events=new At.EventEmitter,this.name=Gl,this.transportExplicitlyClosed=!1,this.initialized=!1,this.connectionAttemptInProgress=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","stalled","interrupted"],this.hasExperiencedNetworkDisruption=!1,this.requestsInFlight=new Map,this.heartBeatTimeout=(0,F.toMiliseconds)(F.THIRTY_SECONDS+F.ONE_SECOND),this.request=async s=>{var a,o;this.logger.debug("Publishing Request Payload");const u=s.id||(0,K.getBigIntRpcId)().toString();await this.toEstablishConnection();try{const l=this.provider.request(s);this.requestsInFlight.set(u,{promise:l,request:s}),this.logger.trace({id:u,method:s.method,topic:(a=s.params)==null?void 0:a.topic},"relayer.request - attempt to publish...");const m=await new Promise(async(_,I)=>{const T=()=>{I(new Error(`relayer.request - publish interrupted, id: ${u}`))};this.provider.on(Ze.disconnect,T);const O=await l;this.provider.off(Ze.disconnect,T),_(O)});return this.logger.trace({id:u,method:s.method,topic:(o=s.params)==null?void 0:o.topic},"relayer.request - published"),m}catch(l){throw this.logger.debug(`Failed to Publish Request: ${u}`),l}finally{this.requestsInFlight.delete(u)}},this.resetPingTimeout=()=>{if((0,d.UGU)())try{clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var s,a,o;(o=(a=(s=this.provider)==null?void 0:s.connection)==null?void 0:a.socket)==null||o.terminate()},this.heartBeatTimeout)}catch(s){this.logger.warn(s)}},this.onPayloadHandler=s=>{this.onProviderPayload(s),this.resetPingTimeout()},this.onConnectHandler=()=>{this.logger.trace("relayer connected"),this.startPingTimeout(),this.events.emit(ke.connect)},this.onDisconnectHandler=()=>{this.logger.trace("relayer disconnected"),this.onProviderDisconnect()},this.onProviderErrorHandler=s=>{this.logger.error(s),this.events.emit(ke.error,s),this.logger.info("Fatal socket error received, closing transport"),this.transportClose()},this.registerProviderListeners=()=>{this.provider.on(Ze.payload,this.onPayloadHandler),this.provider.on(Ze.connect,this.onConnectHandler),this.provider.on(Ze.disconnect,this.onDisconnectHandler),this.provider.on(Ze.error,this.onProviderErrorHandler)},this.core=r.core,this.logger=typeof r.logger<"u"&&typeof r.logger!="string"?(0,te.Ep)(r.logger,this.name):(0,te.gw)((0,te.jI)({level:r.logger||Jl})),this.messages=new _p(this.logger,r.core),this.subscriber=new Rp(this,this.logger),this.publisher=new bp(this,this.logger),this.relayUrl=(r==null?void 0:r.relayUrl)||Da,this.projectId=r.projectId,this.bundleId=(0,d.X_B)(),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.cached.length>0)try{await this.transportOpen()}catch(r){this.logger.warn(r)}}get context(){return(0,te.Fd)(this.logger)}get connected(){var r,s,a;return((a=(s=(r=this.provider)==null?void 0:r.connection)==null?void 0:s.socket)==null?void 0:a.readyState)===1}get connecting(){var r,s,a;return((a=(s=(r=this.provider)==null?void 0:r.connection)==null?void 0:s.socket)==null?void 0:a.readyState)===0}async publish(r,s,a){this.isInitialized(),await this.publisher.publish(r,s,a),await this.recordMessageEvent({topic:r,message:s,publishedAt:Date.now(),transportType:pe.relay})}async subscribe(r,s){var a;this.isInitialized(),(s==null?void 0:s.transportType)==="relay"&&await this.toEstablishConnection();let o=((a=this.subscriber.topicMap.get(r))==null?void 0:a[0])||"",u;const l=m=>{m.topic===r&&(this.subscriber.off(Et.created,l),u())};return await Promise.all([new Promise(m=>{u=m,this.subscriber.on(Et.created,l)}),new Promise(async m=>{o=await this.subscriber.subscribe(r,s)||o,m()})]),o}async unsubscribe(r,s){this.isInitialized(),await this.subscriber.unsubscribe(r,s)}on(r,s){this.events.on(r,s)}once(r,s){this.events.once(r,s)}off(r,s){this.events.off(r,s)}removeListener(r,s){this.events.removeListener(r,s)}async transportDisconnect(){if(!this.hasExperiencedNetworkDisruption&&this.connected&&this.requestsInFlight.size>0)try{await Promise.all(Array.from(this.requestsInFlight.values()).map(r=>r.promise))}catch(r){this.logger.warn(r)}this.hasExperiencedNetworkDisruption||this.connected?await(0,d.hFY)(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(r){await this.confirmOnlineStateOrThrow(),r&&r!==this.relayUrl&&(this.relayUrl=r,await this.transportDisconnect()),await this.createProvider(),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;try{await new Promise(async(s,a)=>{const o=()=>{this.provider.off(Ze.disconnect,o),a(new Error("Connection interrupted while trying to subscribe"))};this.provider.on(Ze.disconnect,o),await(0,d.hFY)(this.provider.connect(),(0,F.toMiliseconds)(F.ONE_MINUTE),`Socket stalled when trying to connect to ${this.relayUrl}`).catch(u=>{a(u)}).finally(()=>{clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}),this.subscriber.start().catch(u=>{this.logger.error(u),this.onDisconnectHandler()}),this.hasExperiencedNetworkDisruption=!1,s()})}catch(s){this.logger.error(s);const a=s;if(this.hasExperiencedNetworkDisruption=!0,!this.isConnectionStalled(a.message))throw s}finally{this.connectionAttemptInProgress=!1}}async restartTransport(r){this.connectionAttemptInProgress||(this.relayUrl=r||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await(0,d.Ggh)())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(r){if((r==null?void 0:r.length)===0){this.logger.trace("Batch message events is empty. Ignoring...");return}const s=r.sort((a,o)=>a.publishedAt-o.publishedAt);this.logger.trace(`Batch of ${s.length} message events sorted`);for(const a of s)try{await this.onMessageEvent(a)}catch(o){this.logger.warn(o)}this.logger.trace(`Batch of ${s.length} message events processed`)}async onLinkMessageEvent(r,s){const{topic:a}=r;if(!s.sessionExists){const o=(0,d.gn4)(F.FIVE_MINUTES),u={topic:a,expiry:o,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(a,u)}this.events.emit(ke.message,r),await this.recordMessageEvent(r)}startPingTimeout(){var r,s,a,o,u;if((0,d.UGU)())try{(s=(r=this.provider)==null?void 0:r.connection)!=null&&s.socket&&((u=(o=(a=this.provider)==null?void 0:a.connection)==null?void 0:o.socket)==null||u.once("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(l){this.logger.warn(l)}}isConnectionStalled(r){return this.staleConnectionErrors.some(s=>r.includes(s))}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();const r=await this.core.crypto.signJWT(this.relayUrl);this.provider=new ct.r(new pu.Z((0,d.$0m)({sdkVersion:Na,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:r,useOnCloseEvent:!0,bundleId:this.bundleId}))),this.registerProviderListeners()}async recordMessageEvent(r){const{topic:s,message:a}=r;await this.messages.set(s,a)}async shouldIgnoreMessageEvent(r){const{topic:s,message:a}=r;if(!a||a.length===0)return this.logger.debug(`Ignoring invalid/empty message: ${a}`),!0;if(!await this.subscriber.isSubscribed(s))return this.logger.debug(`Ignoring message for non-subscribed topic ${s}`),!0;const o=this.messages.has(s,a);return o&&this.logger.debug(`Ignoring duplicate message: ${a}`),o}async onProviderPayload(r){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:r}),(0,K.isJsonRpcRequest)(r)){if(!r.method.endsWith(Wl))return;const s=r.params,{topic:a,message:o,publishedAt:u,attestation:l}=s.data,m={topic:a,message:o,publishedAt:u,transportType:pe.relay,attestation:l};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(qp({type:"event",event:s.id},m)),this.events.emit(s.id,m),await this.acknowledgePayload(r),await this.onMessageEvent(m)}else(0,K.isJsonRpcResponse)(r)&&this.events.emit(ke.message_ack,r)}async onMessageEvent(r){await this.shouldIgnoreMessageEvent(r)||(this.events.emit(ke.message,r),await this.recordMessageEvent(r))}async acknowledgePayload(r){const s=(0,K.formatJsonRpcResult)(r.id,!0);await this.provider.connection.send(s)}unregisterProviderListeners(){this.provider.off(Ze.payload,this.onPayloadHandler),this.provider.off(Ze.connect,this.onConnectHandler),this.provider.off(Ze.disconnect,this.onDisconnectHandler),this.provider.off(Ze.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let r=await(0,d.Ggh)();(0,d.uwg)(async s=>{r!==s&&(r=s,s?await this.restartTransport().catch(a=>this.logger.error(a)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))})}async onProviderDisconnect(){await this.subscriber.stop(),this.requestsInFlight.clear(),clearTimeout(this.pingTimeout),this.events.emit(ke.disconnect),this.connectionAttemptInProgress=!1,!this.transportExplicitlyClosed&&(this.reconnectTimeout||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(r=>this.logger.error(r))},(0,F.toMiliseconds)(Ql))))}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}async toEstablishConnection(){await this.confirmOnlineStateOrThrow(),!this.connected&&(this.connectionAttemptInProgress&&await new Promise(r=>{const s=setInterval(()=>{this.connected&&(clearInterval(s),r())},this.connectionStatusPollingInterval)}),await this.transportOpen())}}var Np=Object.defineProperty,za=Object.getOwnPropertySymbols,Fp=Object.prototype.hasOwnProperty,kp=Object.prototype.propertyIsEnumerable,Ua=(y,r,s)=>r in y?Np(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Ha=(y,r)=>{for(var s in r||(r={}))Fp.call(r,s)&&Ua(y,s,r[s]);if(za)for(var s of za(r))kp.call(r,s)&&Ua(y,s,r[s]);return y};class ni extends su{constructor(r,s,a,o=bt,u=void 0){super(r,s,a,o),this.core=r,this.logger=s,this.name=a,this.map=new Map,this.version=Yl,this.cached=[],this.initialized=!1,this.storagePrefix=bt,this.recentlyDeleted=[],this.recentlyDeletedLimit=200,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(l=>{this.getKey&&l!==null&&!(0,d.o8e)(l)?this.map.set(this.getKey(l),l):(0,d.xWS)(l)?this.map.set(l.id,l):(0,d.h1R)(l)&&this.map.set(l.topic,l)}),this.cached=[],this.initialized=!0)},this.set=async(l,m)=>{this.isInitialized(),this.map.has(l)?await this.update(l,m):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:l,value:m}),this.map.set(l,m),await this.persist())},this.get=l=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:l}),this.getData(l)),this.getAll=l=>(this.isInitialized(),l?this.values.filter(m=>Object.keys(l).every(_=>gu()(m[_],l[_]))):this.values),this.update=async(l,m)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:l,update:m});const _=Ha(Ha({},this.getData(l)),m);this.map.set(l,_),await this.persist()},this.delete=async(l,m)=>{this.isInitialized(),this.map.has(l)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:l,reason:m}),this.map.delete(l),this.addToRecentlyDeleted(l),await this.persist())},this.logger=(0,te.Ep)(s,this.name),this.storagePrefix=o,this.getKey=u}get context(){return(0,te.Fd)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(r){this.recentlyDeleted.push(r),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(r){await this.core.storage.setItem(this.storageKey,r)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(r){const s=this.map.get(r);if(!s){if(this.recentlyDeleted.includes(r)){const{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${r}`);throw this.logger.error(o),new Error(o)}const{message:a}=(0,d.kCb)("NO_MATCHING_KEY",`${this.name}: ${r}`);throw this.logger.error(a),new Error(a)}return s}async persist(){await this.setDataStore(this.values)}async restore(){try{const r=await this.getDataStore();if(typeof r>"u"||!r.length)return;if(this.map.size){const{message:s}=(0,d.kCb)("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),new Error(s)}this.cached=r,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(r){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(r)}}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}}class Mp{constructor(r,s){this.core=r,this.logger=s,this.name=ip,this.version=sp,this.events=new(Er()),this.initialized=!1,this.storagePrefix=bt,this.ignoredPayloadTypes=[d.rVF],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:a})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...a])]},this.create=async a=>{this.isInitialized();const o=(0,d.jdp)(),u=await this.core.crypto.setSymKey(o),l=(0,d.gn4)(F.FIVE_MINUTES),m={protocol:qa},_={topic:u,expiry:l,relay:m,active:!1},I=(0,d.Bvr)({protocol:this.core.protocol,version:this.core.version,topic:u,symKey:o,relay:m,expiryTimestamp:l,methods:a==null?void 0:a.methods});return this.core.expirer.set(u,l),await this.pairings.set(u,_),await this.core.relayer.subscribe(u,{transportType:a==null?void 0:a.transportType}),{topic:u,uri:I}},this.pair=async a=>{this.isInitialized();const o=this.core.eventClient.createEvent({properties:{topic:a==null?void 0:a.uri,trace:[It.pairing_started]}});this.isValidPair(a,o);const{topic:u,symKey:l,relay:m,expiryTimestamp:_,methods:I}=(0,d.heJ)(a.uri);o.props.properties.topic=u,o.addTrace(It.pairing_uri_validation_success),o.addTrace(It.pairing_uri_not_expired);let T;if(this.pairings.keys.includes(u)){if(T=this.pairings.get(u),o.addTrace(It.existing_pairing),T.active)throw o.setError(qt.active_pairing_already_exists),new Error(`Pairing already exists: ${u}. Please try again with a new connection URI.`);o.addTrace(It.pairing_not_expired)}const O=_||(0,d.gn4)(F.FIVE_MINUTES),q={topic:u,relay:m,expiry:O,active:!1,methods:I};this.core.expirer.set(u,O),await this.pairings.set(u,q),o.addTrace(It.store_new_pairing),a.activatePairing&&await this.activate({topic:u}),this.events.emit(Ei.create,q),o.addTrace(It.emit_inactive_pairing),this.core.crypto.keychain.has(u)||await this.core.crypto.setSymKey(l,u),o.addTrace(It.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{o.setError(qt.no_internet_connection)}try{await this.core.relayer.subscribe(u,{relay:m})}catch(A){throw o.setError(qt.subscribe_pairing_topic_failure),A}return o.addTrace(It.subscribe_pairing_topic_success),q},this.activate=async({topic:a})=>{this.isInitialized();const o=(0,d.gn4)(F.THIRTY_DAYS);this.core.expirer.set(a,o),await this.pairings.update(a,{active:!0,expiry:o})},this.ping=async a=>{this.isInitialized(),await this.isValidPing(a);const{topic:o}=a;if(this.pairings.keys.includes(o)){const u=await this.sendRequest(o,"wc_pairingPing",{}),{done:l,resolve:m,reject:_}=(0,d.H1S)();this.events.once((0,d.E0T)("pairing_ping",u),({error:I})=>{I?_(I):m()}),await l()}},this.updateExpiry=async({topic:a,expiry:o})=>{this.isInitialized(),await this.pairings.update(a,{expiry:o})},this.updateMetadata=async({topic:a,metadata:o})=>{this.isInitialized(),await this.pairings.update(a,{peerMetadata:o})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async a=>{this.isInitialized(),await this.isValidDisconnect(a);const{topic:o}=a;this.pairings.keys.includes(o)&&(await this.sendRequest(o,"wc_pairingDelete",(0,d.D6H)("USER_DISCONNECTED")),await this.deletePairing(o))},this.sendRequest=async(a,o,u)=>{const l=(0,K.formatJsonRpcRequest)(o,u),m=await this.core.crypto.encode(a,l),_=Gi[o].req;return this.core.history.set(a,l),this.core.relayer.publish(a,m,_),l.id},this.sendResult=async(a,o,u)=>{const l=(0,K.formatJsonRpcResult)(a,u),m=await this.core.crypto.encode(o,l),_=await this.core.history.get(o,a),I=Gi[_.request.method].res;await this.core.relayer.publish(o,m,I),await this.core.history.resolve(l)},this.sendError=async(a,o,u)=>{const l=(0,K.formatJsonRpcError)(a,u),m=await this.core.crypto.encode(o,l),_=await this.core.history.get(o,a),I=Gi[_.request.method]?Gi[_.request.method].res:Gi.unregistered_method.res;await this.core.relayer.publish(o,m,I),await this.core.history.resolve(l)},this.deletePairing=async(a,o)=>{await this.core.relayer.unsubscribe(a),await Promise.all([this.pairings.delete(a,(0,d.D6H)("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(a),o?Promise.resolve():this.core.expirer.del(a)])},this.cleanup=async()=>{const a=this.pairings.getAll().filter(o=>(0,d.BwD)(o.expiry));await Promise.all(a.map(o=>this.deletePairing(o.topic)))},this.onRelayEventRequest=a=>{const{topic:o,payload:u}=a;switch(u.method){case"wc_pairingPing":return this.onPairingPingRequest(o,u);case"wc_pairingDelete":return this.onPairingDeleteRequest(o,u);default:return this.onUnknownRpcMethodRequest(o,u)}},this.onRelayEventResponse=async a=>{const{topic:o,payload:u}=a,l=(await this.core.history.get(o,u.id)).request.method;switch(l){case"wc_pairingPing":return this.onPairingPingResponse(o,u);default:return this.onUnknownRpcMethodResponse(l)}},this.onPairingPingRequest=async(a,o)=>{const{id:u}=o;try{this.isValidPing({topic:a}),await this.sendResult(u,a,!0),this.events.emit(Ei.ping,{id:u,topic:a})}catch(l){await this.sendError(u,a,l),this.logger.error(l)}},this.onPairingPingResponse=(a,o)=>{const{id:u}=o;setTimeout(()=>{(0,K.isJsonRpcResult)(o)?this.events.emit((0,d.E0T)("pairing_ping",u),{}):(0,K.isJsonRpcError)(o)&&this.events.emit((0,d.E0T)("pairing_ping",u),{error:o.error})},500)},this.onPairingDeleteRequest=async(a,o)=>{const{id:u}=o;try{this.isValidDisconnect({topic:a}),await this.deletePairing(a),this.events.emit(Ei.delete,{id:u,topic:a})}catch(l){await this.sendError(u,a,l),this.logger.error(l)}},this.onUnknownRpcMethodRequest=async(a,o)=>{const{id:u,method:l}=o;try{if(this.registeredMethods.includes(l))return;const m=(0,d.D6H)("WC_METHOD_UNSUPPORTED",l);await this.sendError(u,a,m),this.logger.error(m)}catch(m){await this.sendError(u,a,m),this.logger.error(m)}},this.onUnknownRpcMethodResponse=a=>{this.registeredMethods.includes(a)||this.logger.error((0,d.D6H)("WC_METHOD_UNSUPPORTED",a))},this.isValidPair=(a,o)=>{var u;if(!(0,d.EJd)(a)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID",`pair() params: ${a}`);throw o.setError(qt.malformed_pairing_uri),new Error(m)}if(!(0,d.jvJ)(a.uri)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID",`pair() uri: ${a.uri}`);throw o.setError(qt.malformed_pairing_uri),new Error(m)}const l=(0,d.heJ)(a==null?void 0:a.uri);if(!((u=l==null?void 0:l.relay)!=null&&u.protocol)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID","pair() uri#relay-protocol");throw o.setError(qt.malformed_pairing_uri),new Error(m)}if(!(l!=null&&l.symKey)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID","pair() uri#symKey");throw o.setError(qt.malformed_pairing_uri),new Error(m)}if(l!=null&&l.expiryTimestamp&&(0,F.toMiliseconds)(l==null?void 0:l.expiryTimestamp)<Date.now()){o.setError(qt.pairing_expired);const{message:m}=(0,d.kCb)("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(m)}},this.isValidPing=async a=>{if(!(0,d.EJd)(a)){const{message:u}=(0,d.kCb)("MISSING_OR_INVALID",`ping() params: ${a}`);throw new Error(u)}const{topic:o}=a;await this.isValidPairingTopic(o)},this.isValidDisconnect=async a=>{if(!(0,d.EJd)(a)){const{message:u}=(0,d.kCb)("MISSING_OR_INVALID",`disconnect() params: ${a}`);throw new Error(u)}const{topic:o}=a;await this.isValidPairingTopic(o)},this.isValidPairingTopic=async a=>{if(!(0,d.M_r)(a,!1)){const{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`pairing topic should be a string: ${a}`);throw new Error(o)}if(!this.pairings.keys.includes(a)){const{message:o}=(0,d.kCb)("NO_MATCHING_KEY",`pairing topic doesn't exist: ${a}`);throw new Error(o)}if((0,d.BwD)(this.pairings.get(a).expiry)){await this.deletePairing(a);const{message:o}=(0,d.kCb)("EXPIRED",`pairing topic: ${a}`);throw new Error(o)}},this.core=r,this.logger=(0,te.Ep)(s,this.name),this.pairings=new ni(this.core,this.logger,this.name,this.storagePrefix)}get context(){return(0,te.Fd)(this.logger)}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}registerRelayerEvents(){this.core.relayer.on(ke.message,async r=>{const{topic:s,message:a,transportType:o}=r;if(!this.pairings.keys.includes(s)||o===pe.link_mode||this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(a)))return;const u=await this.core.crypto.decode(s,a);try{(0,K.isJsonRpcRequest)(u)?(this.core.history.set(s,u),this.onRelayEventRequest({topic:s,payload:u})):(0,K.isJsonRpcResponse)(u)&&(await this.core.history.resolve(u),await this.onRelayEventResponse({topic:s,payload:u}),this.core.history.delete(s,u.id))}catch(l){this.logger.error(l)}})}registerExpirerEvents(){this.core.expirer.on(Xe.expired,async r=>{const{topic:s}=(0,d.iPz)(r.target);s&&this.pairings.keys.includes(s)&&(await this.deletePairing(s,!0),this.events.emit(Ei.expire,{topic:s}))})}}class $p extends Xh{constructor(r,s){super(r,s),this.core=r,this.logger=s,this.records=new Map,this.events=new At.EventEmitter,this.name=rp,this.version=np,this.cached=[],this.initialized=!1,this.storagePrefix=bt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>this.records.set(a.id,a)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(a,o,u)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:a,request:o,chainId:u}),this.records.has(o.id))return;const l={id:o.id,topic:a,request:{method:o.method,params:o.params||null},chainId:u,expiry:(0,d.gn4)(F.THIRTY_DAYS)};this.records.set(l.id,l),this.persist(),this.events.emit(ht.created,l)},this.resolve=async a=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:a}),!this.records.has(a.id))return;const o=await this.getRecord(a.id);typeof o.response>"u"&&(o.response=(0,K.isJsonRpcError)(a)?{error:a.error}:{result:a.result},this.records.set(o.id,o),this.persist(),this.events.emit(ht.updated,o))},this.get=async(a,o)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:a,id:o}),await this.getRecord(o)),this.delete=(a,o)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:o}),this.values.forEach(u=>{if(u.topic===a){if(typeof o<"u"&&u.id!==o)return;this.records.delete(u.id),this.events.emit(ht.deleted,u)}}),this.persist()},this.exists=async(a,o)=>(this.isInitialized(),this.records.has(o)?(await this.getRecord(o)).topic===a:!1),this.on=(a,o)=>{this.events.on(a,o)},this.once=(a,o)=>{this.events.once(a,o)},this.off=(a,o)=>{this.events.off(a,o)},this.removeListener=(a,o)=>{this.events.removeListener(a,o)},this.logger=(0,te.Ep)(s,this.name)}get context(){return(0,te.Fd)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const r=[];return this.values.forEach(s=>{if(typeof s.response<"u")return;const a={topic:s.topic,request:(0,K.formatJsonRpcRequest)(s.request.method,s.request.params,s.id),chainId:s.chainId};return r.push(a)}),r}async setJsonRpcRecords(r){await this.core.storage.setItem(this.storageKey,r)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(r){this.isInitialized();const s=this.records.get(r);if(!s){const{message:a}=(0,d.kCb)("NO_MATCHING_KEY",`${this.name}: ${r}`);throw new Error(a)}return s}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(ht.sync)}async restore(){try{const r=await this.getJsonRpcRecords();if(typeof r>"u"||!r.length)return;if(this.records.size){const{message:s}=(0,d.kCb)("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),new Error(s)}this.cached=r,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(r){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(r)}}registerEventListeners(){this.events.on(ht.created,r=>{const s=ht.created;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,record:r})}),this.events.on(ht.updated,r=>{const s=ht.updated;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,record:r})}),this.events.on(ht.deleted,r=>{const s=ht.deleted;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,record:r})}),this.core.heartbeat.on(wi.Lx.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let r=!1;this.records.forEach(s=>{(0,F.toMiliseconds)(s.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${s.id}`),this.records.delete(s.id),this.events.emit(ht.deleted,s,!1),r=!0)}),r&&this.persist()}catch(r){this.logger.warn(r)}}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}}class jp extends nu{constructor(r,s){super(r,s),this.core=r,this.logger=s,this.expirations=new Map,this.events=new At.EventEmitter,this.name=ap,this.version=op,this.cached=[],this.initialized=!1,this.storagePrefix=bt,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>this.expirations.set(a.target,a)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=a=>{try{const o=this.formatTarget(a);return typeof this.getExpiration(o)<"u"}catch{return!1}},this.set=(a,o)=>{this.isInitialized();const u=this.formatTarget(a),l={target:u,expiry:o};this.expirations.set(u,l),this.checkExpiry(u,l),this.events.emit(Xe.created,{target:u,expiration:l})},this.get=a=>{this.isInitialized();const o=this.formatTarget(a);return this.getExpiration(o)},this.del=a=>{if(this.isInitialized(),this.has(a)){const o=this.formatTarget(a),u=this.getExpiration(o);this.expirations.delete(o),this.events.emit(Xe.deleted,{target:o,expiration:u})}},this.on=(a,o)=>{this.events.on(a,o)},this.once=(a,o)=>{this.events.once(a,o)},this.off=(a,o)=>{this.events.off(a,o)},this.removeListener=(a,o)=>{this.events.removeListener(a,o)},this.logger=(0,te.Ep)(s,this.name)}get context(){return(0,te.Fd)(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(r){if(typeof r=="string")return(0,d.Z42)(r);if(typeof r=="number")return(0,d.GqV)(r);const{message:s}=(0,d.kCb)("UNKNOWN_TYPE",`Target type: ${typeof r}`);throw new Error(s)}async setExpirations(r){await this.core.storage.setItem(this.storageKey,r)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(Xe.sync)}async restore(){try{const r=await this.getExpirations();if(typeof r>"u"||!r.length)return;if(this.expirations.size){const{message:s}=(0,d.kCb)("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(s),new Error(s)}this.cached=r,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(r){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(r)}}getExpiration(r){const s=this.expirations.get(r);if(!s){const{message:a}=(0,d.kCb)("NO_MATCHING_KEY",`${this.name}: ${r}`);throw this.logger.warn(a),new Error(a)}return s}checkExpiry(r,s){const{expiry:a}=s;(0,F.toMiliseconds)(a)-Date.now()<=0&&this.expire(r,s)}expire(r,s){this.expirations.delete(r),this.events.emit(Xe.expired,{target:r,expiration:s})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((r,s)=>this.checkExpiry(s,r))}registerEventListeners(){this.core.heartbeat.on(wi.Lx.pulse,()=>this.checkExpirations()),this.events.on(Xe.created,r=>{const s=Xe.created;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),this.persist()}),this.events.on(Xe.expired,r=>{const s=Xe.expired;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),this.persist()}),this.events.on(Xe.deleted,r=>{const s=Xe.deleted;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),this.persist()})}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}}var me={};Object.defineProperty(me,"__esModule",{value:!0}),me.getLocalStorage=me.getLocalStorageOrThrow=me.getCrypto=me.getCryptoOrThrow=me.getLocation=me.getLocationOrThrow=me.getNavigator=me.getNavigatorOrThrow=Ka=me.getDocument=me.getDocumentOrThrow=me.getFromWindowOrThrow=me.getFromWindow=void 0;function ai(y){let r;return typeof window<"u"&&typeof window[y]<"u"&&(r=window[y]),r}me.getFromWindow=ai;function Ii(y){const r=ai(y);if(!r)throw new Error(`${y} is not defined in Window`);return r}me.getFromWindowOrThrow=Ii;function Lp(){return Ii("document")}me.getDocumentOrThrow=Lp;function zp(){return ai("document")}var Ka=me.getDocument=zp;function Up(){return Ii("navigator")}me.getNavigatorOrThrow=Up;function Hp(){return ai("navigator")}me.getNavigator=Hp;function Kp(){return Ii("location")}me.getLocationOrThrow=Kp;function Vp(){return ai("location")}me.getLocation=Vp;function Bp(){return Ii("crypto")}me.getCryptoOrThrow=Bp;function Jp(){return ai("crypto")}me.getCrypto=Jp;function Gp(){return Ii("localStorage")}me.getLocalStorageOrThrow=Gp;function Wp(){return ai("localStorage")}me.getLocalStorage=Wp;class Qp extends au{constructor(r,s,a){super(r,s,a),this.core=r,this.logger=s,this.store=a,this.name=cp,this.verifyUrlV3=up,this.storagePrefix=bt,this.version=Oa,this.init=async()=>{var o;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,F.toMiliseconds)((o=this.publicKey)==null?void 0:o.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))},this.register=async o=>{if(!(0,d.jUY)()||this.isDevEnv)return;const u=window.location.origin,{id:l,decryptedId:m}=o,_=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${u}&id=${l}&decryptedId=${m}`;try{const I=Ka(),T=this.startAbortTimer(F.ONE_SECOND*5),O=await new Promise((q,A)=>{const N=()=>{window.removeEventListener("message",M),I.body.removeChild(j),A("attestation aborted")};this.abortController.signal.addEventListener("abort",N);const j=I.createElement("iframe");j.src=_,j.style.display="none",j.addEventListener("error",N,{signal:this.abortController.signal});const M=$=>{if(!$.data)return;const G=JSON.parse($.data);if(G.type==="verify_attestation"){if((0,bi.decodeJWT)(G.attestation).payload.id!==l)return;clearInterval(T),I.body.removeChild(j),this.abortController.signal.removeEventListener("abort",N),window.removeEventListener("message",M),q(G.attestation===null?"":G.attestation)}};I.body.appendChild(j),window.addEventListener("message",M,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",O),O}catch(I){this.logger.warn(I)}return""},this.resolve=async o=>{if(this.isDevEnv)return"";const{attestationId:u,hash:l,encryptedId:m}=o;if(u===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(u){if((0,bi.decodeJWT)(u).payload.id!==m)return;const I=await this.isValidJwtAttestation(u);if(I){if(!I.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return I}}if(!l)return;const _=this.getVerifyUrl(o==null?void 0:o.verifyUrl);return this.fetchAttestation(l,_)},this.fetchAttestation=async(o,u)=>{this.logger.debug(`resolving attestation: ${o} from url: ${u}`);const l=this.startAbortTimer(F.ONE_SECOND*5),m=await fetch(`${u}/attestation/${o}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(l),m.status===200?await m.json():void 0},this.getVerifyUrl=o=>{let u=o||Wi;return lp.includes(u)||(this.logger.info(`verify url: ${u}, not included in trusted list, assigning default: ${Wi}`),u=Wi),u},this.fetchPublicKey=async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);const o=this.startAbortTimer(F.FIVE_SECONDS),u=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(o),await u.json()}catch(o){this.logger.warn(o)}},this.persistPublicKey=async o=>{this.logger.debug("persisting public key to local storage",o),await this.store.setItem(this.storeKey,o),this.publicKey=o},this.removePublicKey=async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0},this.isValidJwtAttestation=async o=>{const u=await this.getPublicKey();try{if(u)return this.validateAttestation(o,u)}catch(m){this.logger.error(m),this.logger.warn("error validating attestation")}const l=await this.fetchAndPersistPublicKey();try{if(l)return this.validateAttestation(o,l)}catch(m){this.logger.error(m),this.logger.warn("error validating attestation")}},this.getPublicKey=async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey(),this.fetchAndPersistPublicKey=async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async u=>{const l=await this.fetchPublicKey();l&&(await this.persistPublicKey(l),u(l))});const o=await this.fetchPromise;return this.fetchPromise=void 0,o},this.validateAttestation=(o,u)=>{const l=(0,d.NbI)(o,u.publicKey),m={hasExpired:(0,F.toMiliseconds)(l.exp)<Date.now(),payload:l};if(m.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:m.payload.origin,isScam:m.payload.isScam,isVerified:m.payload.isVerified}},this.logger=(0,te.Ep)(s,this.name),this.abortController=new AbortController,this.isDevEnv=(0,d.UGU)()&&{NODE_ENV:"production",PUBLIC_PATH:"/"}.IS_VITEST,this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return(0,te.Fd)(this.logger)}startAbortTimer(r){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,F.toMiliseconds)(r))}}class Yp extends ou{constructor(r,s){super(r,s),this.projectId=r,this.logger=s,this.context=pp,this.registerDeviceToken=async a=>{const{clientId:o,token:u,notificationType:l,enableEncrypted:m=!1}=a,_=`${dp}/${this.projectId}/clients`;await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:o,type:l,token:u,always_raw:m})})},this.logger=(0,te.Ep)(s,this.context)}}var Zp=Object.defineProperty,Va=Object.getOwnPropertySymbols,Xp=Object.prototype.hasOwnProperty,ed=Object.prototype.propertyIsEnumerable,Ba=(y,r,s)=>r in y?Zp(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Zi=(y,r)=>{for(var s in r||(r={}))Xp.call(r,s)&&Ba(y,s,r[s]);if(Va)for(var s of Va(r))ed.call(r,s)&&Ba(y,s,r[s]);return y};class td extends cu{constructor(r,s,a=!0){super(r,s,a),this.core=r,this.logger=s,this.context=fp,this.storagePrefix=bt,this.storageVersion=gp,this.events=new Map,this.shouldPersist=!1,this.createEvent=o=>{const{event:u="ERROR",type:l="",properties:{topic:m,trace:_}}=o,I=(0,d.k$y)(),T=this.core.projectId||"",O=Date.now(),q=Zi({eventId:I,bundleId:T,timestamp:O,props:{event:u,type:l,properties:{topic:m,trace:_}}},this.setMethods(I));return this.telemetryEnabled&&(this.events.set(I,q),this.shouldPersist=!0),q},this.getEvent=o=>{const{eventId:u,topic:l}=o;if(u)return this.events.get(u);const m=Array.from(this.events.values()).find(_=>_.props.properties.topic===l);if(m)return Zi(Zi({},m),this.setMethods(m.eventId))},this.deleteEvent=o=>{const{eventId:u}=o;this.events.delete(u),this.shouldPersist=!0},this.setEventListeners=()=>{this.core.heartbeat.on(wi.Lx.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(o=>{(0,F.fromMiliseconds)(Date.now())-(0,F.fromMiliseconds)(o.timestamp)>yp&&(this.events.delete(o.eventId),this.shouldPersist=!0)})})},this.setMethods=o=>({addTrace:u=>this.addTrace(o,u),setError:u=>this.setError(o,u)}),this.addTrace=(o,u)=>{const l=this.events.get(o);l&&(l.props.properties.trace.push(u),this.events.set(o,l),this.shouldPersist=!0)},this.setError=(o,u)=>{const l=this.events.get(o);l&&(l.props.type=u,l.timestamp=Date.now(),this.events.set(o,l),this.shouldPersist=!0)},this.persist=async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1},this.restore=async()=>{try{const o=await this.core.storage.getItem(this.storageKey)||[];if(!o.length)return;o.forEach(u=>{this.events.set(u.eventId,Zi(Zi({},u),this.setMethods(u.eventId)))})}catch(o){this.logger.warn(o)}},this.submit=async()=>{if(!this.telemetryEnabled||this.events.size===0)return;const o=[];for(const[u,l]of this.events)l.props.type&&o.push(l);if(o.length!==0)try{if((await fetch(`${mp}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${Na}`,{method:"POST",body:JSON.stringify(o)})).ok)for(const u of o)this.events.delete(u.eventId),this.shouldPersist=!0}catch(u){this.logger.warn(u)}},this.logger=(0,te.Ep)(s,this.context),a?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}}var id=Object.defineProperty,Ja=Object.getOwnPropertySymbols,sd=Object.prototype.hasOwnProperty,rd=Object.prototype.propertyIsEnumerable,Ga=(y,r,s)=>r in y?id(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Wa=(y,r)=>{for(var s in r||(r={}))sd.call(r,s)&&Ga(y,s,r[s]);if(Ja)for(var s of Ja(r))rd.call(r,s)&&Ga(y,s,r[s]);return y};class Tr extends Zh{constructor(r){var s;super(r),this.protocol=Ta,this.version=Oa,this.name=xr,this.events=new At.EventEmitter,this.initialized=!1,this.on=(l,m)=>this.events.on(l,m),this.once=(l,m)=>this.events.once(l,m),this.off=(l,m)=>this.events.off(l,m),this.removeListener=(l,m)=>this.events.removeListener(l,m),this.dispatchEnvelope=({topic:l,message:m,sessionExists:_})=>{if(!l||!m)return;const I={topic:l,message:m,publishedAt:Date.now(),transportType:pe.link_mode};this.relayer.onLinkMessageEvent(I,{sessionExists:_})},this.projectId=r==null?void 0:r.projectId,this.relayUrl=(r==null?void 0:r.relayUrl)||Da,this.customStoragePrefix=r!=null&&r.customStoragePrefix?`:${r.customStoragePrefix}`:"";const a=(0,te.jI)({level:typeof(r==null?void 0:r.logger)=="string"&&r.logger?r.logger:Ml.logger}),{logger:o,chunkLoggerController:u}=(0,te.Rt)({opts:a,maxSizeInBytes:r==null?void 0:r.maxLogBlobSizeInBytes,loggerOverride:r==null?void 0:r.logger});this.logChunkController=u,(s=this.logChunkController)!=null&&s.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var l,m;(l=this.logChunkController)!=null&&l.downloadLogsBlobInBrowser&&((m=this.logChunkController)==null||m.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=(0,te.Ep)(o,this.name),this.heartbeat=new wi.C$,this.crypto=new wp(this,this.logger,r==null?void 0:r.keychain),this.history=new $p(this,this.logger),this.expirer=new jp(this,this.logger),this.storage=r!=null&&r.storage?r.storage:new Yh.Z(Wa(Wa({},$l),r==null?void 0:r.storageOptions)),this.relayer=new Dp({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new Mp(this,this.logger),this.verify=new Qp(this,this.logger,this.storage),this.echoClient=new Yp(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new td(this,this.logger,r==null?void 0:r.telemetryEnabled)}static async init(r){const s=new Tr(r);await s.initialize();const a=await s.crypto.getClientId();return await s.storage.setItem(Zl,a),s}get context(){return(0,te.Fd)(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var r;return(r=this.logChunkController)==null?void 0:r.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(r){this.linkModeSupportedApps.includes(r)||(this.linkModeSupportedApps.push(r),await this.storage.setItem(Fa,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(Fa)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(r){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,r),this.logger.error(r.message),r}}}const nd=Tr;var ad=se(14224);const Qa="wc",Ya=2,Za="client",Or=`${Qa}@${Ya}:${Za}:`,Ar={name:Za,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.com"},bb={session_proposal:"session_proposal",session_update:"session_update",session_extend:"session_extend",session_ping:"session_ping",session_delete:"session_delete",session_expire:"session_expire",session_request:"session_request",session_request_sent:"session_request_sent",session_event:"session_event",proposal_expire:"proposal_expire",session_authenticate:"session_authenticate",session_request_expire:"session_request_expire"},Eb={database:":memory:"},Xa="WALLETCONNECT_DEEPLINK_CHOICE",Ib={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Pb="history",Cb="0.3",od="proposal",Sb=null,eo="Proposal expired",cd="session",Pi=F.SEVEN_DAYS,hd="engine",Te={wc_sessionPropose:{req:{ttl:F.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1104},res:{ttl:F.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1106},res:{ttl:F.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:F.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:F.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1112},res:{ttl:F.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:F.ONE_DAY,prompt:!1,tag:1114},res:{ttl:F.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:F.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:F.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:F.FIVE_MINUTES,prompt:!1,tag:1119}}},qr={min:F.FIVE_MINUTES,max:F.SEVEN_DAYS},Pt={idle:"IDLE",active:"ACTIVE"},ud="request",ld=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],pd="wc",xb=1.5,dd="auth",gd="authKeys",fd="pairingTopics",yd="requests",Cs=`${pd}@${1.5}:${dd}:`,Ss=`${Cs}:PUB_KEY`;var md=Object.defineProperty,vd=Object.defineProperties,wd=Object.getOwnPropertyDescriptors,to=Object.getOwnPropertySymbols,_d=Object.prototype.hasOwnProperty,bd=Object.prototype.propertyIsEnumerable,io=(y,r,s)=>r in y?md(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Ee=(y,r)=>{for(var s in r||(r={}))_d.call(r,s)&&io(y,s,r[s]);if(to)for(var s of to(r))bd.call(r,s)&&io(y,s,r[s]);return y},lt=(y,r)=>vd(y,wd(r));class Ed extends uu{constructor(r){super(r),this.name=hd,this.events=new(Er()),this.initialized=!1,this.requestQueue={state:Pt.idle,queue:[]},this.sessionRequestQueue={state:Pt.idle,queue:[]},this.requestQueueDelay=F.ONE_SECOND,this.expectedPairingMethodMap=new Map,this.recentlyDeletedMap=new Map,this.recentlyDeletedLimit=200,this.relayMessageCache=[],this.init=async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(Te)}),this.initialized=!0,setTimeout(()=>{this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,F.toMiliseconds)(this.requestQueueDelay)))},this.connect=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();const a=lt(Ee({},s),{requiredNamespaces:s.requiredNamespaces||{},optionalNamespaces:s.optionalNamespaces||{}});await this.isValidConnect(a);const{pairingTopic:o,requiredNamespaces:u,optionalNamespaces:l,sessionProperties:m,relays:_}=a;let I=o,T,O=!1;try{I&&(O=this.client.core.pairing.pairings.get(I).active)}catch(B){throw this.client.logger.error(`connect() -> pairing.get(${I}) failed`),B}if(!I||!O){const{topic:B,uri:J}=await this.client.core.pairing.create();I=B,T=J}if(!I){const{message:B}=(0,d.kCb)("NO_MATCHING_KEY",`connect() pairing topic: ${I}`);throw new Error(B)}const q=await this.client.core.crypto.generateKeyPair(),A=Te.wc_sessionPropose.req.ttl||F.FIVE_MINUTES,N=(0,d.gn4)(A),j=Ee({requiredNamespaces:u,optionalNamespaces:l,relays:_??[{protocol:qa}],proposer:{publicKey:q,metadata:this.client.metadata},expiryTimestamp:N,pairingTopic:I},m&&{sessionProperties:m}),{reject:M,resolve:$,done:G}=(0,d.H1S)(A,eo);this.events.once((0,d.E0T)("session_connect"),async({error:B,session:J})=>{if(B)M(B);else if(J){J.self.publicKey=q;const fe=lt(Ee({},J),{pairingTopic:j.pairingTopic,requiredNamespaces:j.requiredNamespaces,optionalNamespaces:j.optionalNamespaces,transportType:pe.relay});await this.client.session.set(J.topic,fe),await this.setExpiry(J.topic,J.expiry),I&&await this.client.core.pairing.updateMetadata({topic:I,metadata:J.peer.metadata}),this.cleanupDuplicatePairings(fe),$(fe)}});const ae=await this.sendRequest({topic:I,method:"wc_sessionPropose",params:j,throwOnFailedPublish:!0});return await this.setProposal(ae,Ee({id:ae},j)),{uri:T,approval:G}},this.pair=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(s)}catch(a){throw this.client.logger.error("pair() failed"),a}},this.approve=async s=>{var a,o,u;const l=this.client.core.eventClient.createEvent({properties:{topic:(a=s==null?void 0:s.id)==null?void 0:a.toString(),trace:[ut.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(oe){throw l.setError(si.no_internet_connection),oe}try{await this.isValidProposalId(s==null?void 0:s.id)}catch(oe){throw this.client.logger.error(`approve() -> proposal.get(${s==null?void 0:s.id}) failed`),l.setError(si.proposal_not_found),oe}try{await this.isValidApprove(s)}catch(oe){throw this.client.logger.error("approve() -> isValidApprove() failed"),l.setError(si.session_approve_namespace_validation_failure),oe}const{id:m,relayProtocol:_,namespaces:I,sessionProperties:T,sessionConfig:O}=s,q=this.client.proposal.get(m);this.client.core.eventClient.deleteEvent({eventId:l.eventId});const{pairingTopic:A,proposer:N,requiredNamespaces:j,optionalNamespaces:M}=q;let $=(o=this.client.core.eventClient)==null?void 0:o.getEvent({topic:A});$||($=(u=this.client.core.eventClient)==null?void 0:u.createEvent({type:ut.session_approve_started,properties:{topic:A,trace:[ut.session_approve_started,ut.session_namespaces_validation_success]}}));const G=await this.client.core.crypto.generateKeyPair(),ae=N.publicKey,B=await this.client.core.crypto.generateSharedKey(G,ae),J=Ee(Ee({relay:{protocol:_??"irn"},namespaces:I,controller:{publicKey:G,metadata:this.client.metadata},expiry:(0,d.gn4)(Pi)},T&&{sessionProperties:T}),O&&{sessionConfig:O}),fe=pe.relay;$.addTrace(ut.subscribing_session_topic);try{await this.client.core.relayer.subscribe(B,{transportType:fe})}catch(oe){throw $.setError(si.subscribe_session_topic_failure),oe}$.addTrace(ut.subscribe_session_topic_success);const de=lt(Ee({},J),{topic:B,requiredNamespaces:j,optionalNamespaces:M,pairingTopic:A,acknowledged:!1,self:J.controller,peer:{publicKey:N.publicKey,metadata:N.metadata},controller:G,transportType:pe.relay});await this.client.session.set(B,de),$.addTrace(ut.store_session);try{$.addTrace(ut.publishing_session_settle),await this.sendRequest({topic:B,method:"wc_sessionSettle",params:J,throwOnFailedPublish:!0}).catch(oe=>{throw $==null||$.setError(si.session_settle_publish_failure),oe}),$.addTrace(ut.session_settle_publish_success),$.addTrace(ut.publishing_session_approve),await this.sendResult({id:m,topic:A,result:{relay:{protocol:_??"irn"},responderPublicKey:G},throwOnFailedPublish:!0}).catch(oe=>{throw $==null||$.setError(si.session_approve_publish_failure),oe}),$.addTrace(ut.session_approve_publish_success)}catch(oe){throw this.client.logger.error(oe),this.client.session.delete(B,(0,d.D6H)("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(B),oe}return this.client.core.eventClient.deleteEvent({eventId:$.eventId}),await this.client.core.pairing.updateMetadata({topic:A,metadata:N.metadata}),await this.client.proposal.delete(m,(0,d.D6H)("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:A}),await this.setExpiry(B,(0,d.gn4)(Pi)),{topic:B,acknowledged:()=>Promise.resolve(this.client.session.get(B))}},this.reject=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(s)}catch(l){throw this.client.logger.error("reject() -> isValidReject() failed"),l}const{id:a,reason:o}=s;let u;try{u=this.client.proposal.get(a).pairingTopic}catch(l){throw this.client.logger.error(`reject() -> proposal.get(${a}) failed`),l}u&&(await this.sendError({id:a,topic:u,error:o,rpcOpts:Te.wc_sessionPropose.reject}),await this.client.proposal.delete(a,(0,d.D6H)("USER_DISCONNECTED")))},this.update=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(s)}catch(O){throw this.client.logger.error("update() -> isValidUpdate() failed"),O}const{topic:a,namespaces:o}=s,{done:u,resolve:l,reject:m}=(0,d.H1S)(),_=(0,K.payloadId)(),I=(0,K.getBigIntRpcId)().toString(),T=this.client.session.get(a).namespaces;return this.events.once((0,d.E0T)("session_update",_),({error:O})=>{O?m(O):l()}),await this.client.session.update(a,{namespaces:o}),await this.sendRequest({topic:a,method:"wc_sessionUpdate",params:{namespaces:o},throwOnFailedPublish:!0,clientRpcId:_,relayRpcId:I}).catch(O=>{this.client.logger.error(O),this.client.session.update(a,{namespaces:T}),m(O)}),{acknowledged:u}},this.extend=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(s)}catch(_){throw this.client.logger.error("extend() -> isValidExtend() failed"),_}const{topic:a}=s,o=(0,K.payloadId)(),{done:u,resolve:l,reject:m}=(0,d.H1S)();return this.events.once((0,d.E0T)("session_extend",o),({error:_})=>{_?m(_):l()}),await this.setExpiry(a,(0,d.gn4)(Pi)),this.sendRequest({topic:a,method:"wc_sessionExtend",params:{},clientRpcId:o,throwOnFailedPublish:!0}).catch(_=>{m(_)}),{acknowledged:u}},this.request=async s=>{this.isInitialized();try{await this.isValidRequest(s)}catch(N){throw this.client.logger.error("request() -> isValidRequest() failed"),N}const{chainId:a,request:o,topic:u,expiry:l=Te.wc_sessionRequest.req.ttl}=s,m=this.client.session.get(u);(m==null?void 0:m.transportType)===pe.relay&&await this.confirmOnlineStateOrThrow();const _=(0,K.payloadId)(),I=(0,K.getBigIntRpcId)().toString(),{done:T,resolve:O,reject:q}=(0,d.H1S)(l,"Request expired. Please try again.");this.events.once((0,d.E0T)("session_request",_),({error:N,result:j})=>{N?q(N):O(j)});const A=this.getAppLinkIfEnabled(m.peer.metadata,m.transportType);return A?(await this.sendRequest({clientRpcId:_,relayRpcId:I,topic:u,method:"wc_sessionRequest",params:{request:lt(Ee({},o),{expiryTimestamp:(0,d.gn4)(l)}),chainId:a},expiry:l,throwOnFailedPublish:!0,appLink:A}).catch(N=>q(N)),this.client.events.emit("session_request_sent",{topic:u,request:o,chainId:a,id:_}),await T()):await Promise.all([new Promise(async N=>{await this.sendRequest({clientRpcId:_,relayRpcId:I,topic:u,method:"wc_sessionRequest",params:{request:lt(Ee({},o),{expiryTimestamp:(0,d.gn4)(l)}),chainId:a},expiry:l,throwOnFailedPublish:!0}).catch(j=>q(j)),this.client.events.emit("session_request_sent",{topic:u,request:o,chainId:a,id:_}),N()}),new Promise(async N=>{var j;if(!((j=m.sessionConfig)!=null&&j.disableDeepLink)){const M=await(0,d.bW6)(this.client.core.storage,Xa);(0,d.HhN)({id:_,topic:u,wcDeepLink:M})}N()}),T()]).then(N=>N[2])},this.respond=async s=>{this.isInitialized(),await this.isValidRespond(s);const{topic:a,response:o}=s,{id:u}=o,l=this.client.session.get(a);l.transportType===pe.relay&&await this.confirmOnlineStateOrThrow();const m=this.getAppLinkIfEnabled(l.peer.metadata,l.transportType);(0,K.isJsonRpcResult)(o)?await this.sendResult({id:u,topic:a,result:o.result,throwOnFailedPublish:!0,appLink:m}):(0,K.isJsonRpcError)(o)&&await this.sendError({id:u,topic:a,error:o.error,appLink:m}),this.cleanupAfterResponse(s)},this.ping=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(s)}catch(o){throw this.client.logger.error("ping() -> isValidPing() failed"),o}const{topic:a}=s;if(this.client.session.keys.includes(a)){const o=(0,K.payloadId)(),u=(0,K.getBigIntRpcId)().toString(),{done:l,resolve:m,reject:_}=(0,d.H1S)();this.events.once((0,d.E0T)("session_ping",o),({error:I})=>{I?_(I):m()}),await Promise.all([this.sendRequest({topic:a,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:o,relayRpcId:u}),l()])}else this.client.core.pairing.pairings.keys.includes(a)&&await this.client.core.pairing.ping({topic:a})},this.emit=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(s);const{topic:a,event:o,chainId:u}=s,l=(0,K.getBigIntRpcId)().toString();await this.sendRequest({topic:a,method:"wc_sessionEvent",params:{event:o,chainId:u},throwOnFailedPublish:!0,relayRpcId:l})},this.disconnect=async s=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(s);const{topic:a}=s;if(this.client.session.keys.includes(a))await this.sendRequest({topic:a,method:"wc_sessionDelete",params:(0,d.D6H)("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:a,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(a))await this.client.core.pairing.disconnect({topic:a});else{const{message:o}=(0,d.kCb)("MISMATCHED_TOPIC",`Session or pairing topic not found: ${a}`);throw new Error(o)}},this.find=s=>(this.isInitialized(),this.client.session.getAll().filter(a=>(0,d.Ih8)(a,s))),this.getPendingSessionRequests=()=>this.client.pendingRequest.getAll(),this.authenticate=async(s,a)=>{var o;this.isInitialized(),this.isValidAuthenticate(s);const u=a&&this.client.core.linkModeSupportedApps.includes(a)&&((o=this.client.metadata.redirect)==null?void 0:o.linkMode),l=u?pe.link_mode:pe.relay;l===pe.relay&&await this.confirmOnlineStateOrThrow();const{chains:m,statement:_="",uri:I,domain:T,nonce:O,type:q,exp:A,nbf:N,methods:j=[],expiry:M}=s,$=[...s.resources||[]],{topic:G,uri:ae}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:l});this.client.logger.info({message:"Generated new pairing",pairing:{topic:G,uri:ae}});const B=await this.client.core.crypto.generateKeyPair(),J=(0,d.YmJ)(B);if(await Promise.all([this.client.auth.authKeys.set(Ss,{responseTopic:J,publicKey:B}),this.client.auth.pairingTopics.set(J,{topic:J,pairingTopic:G})]),await this.client.core.relayer.subscribe(J,{transportType:l}),this.client.logger.info(`sending request to new pairing topic: ${G}`),j.length>0){const{namespace:_e}=(0,d.DQe)(m[0]);let Se=(0,d.IkP)(_e,"request",j);(0,d.hA9)($)&&(Se=(0,d.qJM)(Se,$.pop())),$.push(Se)}const fe=M&&M>Te.wc_sessionAuthenticate.req.ttl?M:Te.wc_sessionAuthenticate.req.ttl,de={authPayload:{type:q??"caip122",chains:m,statement:_,aud:I,domain:T,version:"1",nonce:O,iat:new Date().toISOString(),exp:A,nbf:N,resources:$},requester:{publicKey:B,metadata:this.client.metadata},expiryTimestamp:(0,d.gn4)(fe)},oe={eip155:{chains:m,methods:[...new Set(["personal_sign",...j])],events:["chainChanged","accountsChanged"]}},gt={requiredNamespaces:{},optionalNamespaces:oe,relays:[{protocol:"irn"}],pairingTopic:G,proposer:{publicKey:B,metadata:this.client.metadata},expiryTimestamp:(0,d.gn4)(Te.wc_sessionPropose.req.ttl)},{done:Kr,resolve:As,reject:es}=(0,d.H1S)(fe,"Request expired"),xi=async({error:_e,session:Se})=>{if(this.events.off((0,d.E0T)("session_request",Dt),Ri),_e)es(_e);else if(Se){Se.self.publicKey=B,await this.client.session.set(Se.topic,Se),await this.setExpiry(Se.topic,Se.expiry),G&&await this.client.core.pairing.updateMetadata({topic:G,metadata:Se.peer.metadata});const Nt=this.client.session.get(Se.topic);await this.deleteProposal(ci),As({session:Nt})}},Ri=async _e=>{var Se,Nt,Ke;if(await this.deletePendingAuthRequest(Dt,{message:"fulfilled",code:0}),_e.error){const ft=(0,d.D6H)("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return _e.error.code===ft.code?void 0:(this.events.off((0,d.E0T)("session_connect"),xi),es(_e.error.message))}await this.deleteProposal(ci),this.events.off((0,d.E0T)("session_connect"),xi);const{cacaos:qs,responder:Ft}=_e.result,is=[],kt=[];for(const ft of qs){await(0,d.c4l)({cacao:ft,projectId:this.client.core.projectId})||(this.client.logger.error(ft,"Signature verification failed"),es((0,d.D6H)("SESSION_SETTLEMENT_FAILED","Signature verification failed")));const{p:Mt}=ft,ss=(0,d.hA9)(Mt.resources),hi=[(0,d.DJo)(Mt.iss)],Oi=(0,d.NmC)(Mt.iss);if(ss){const Ai=(0,d.Y31)(ss),Ve=(0,d.ouN)(ss);is.push(...Ai),hi.push(...Ve)}for(const Ai of hi)kt.push(`${Ai}:${Oi}`)}const xt=await this.client.core.crypto.generateSharedKey(B,Ft.publicKey);let Ti;is.length>0&&(Ti={topic:xt,acknowledged:!0,self:{publicKey:B,metadata:this.client.metadata},peer:Ft,controller:Ft.publicKey,expiry:(0,d.gn4)(Pi),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:G,namespaces:(0,d.E12)([...new Set(is)],[...new Set(kt)]),transportType:l},await this.client.core.relayer.subscribe(xt,{transportType:l}),await this.client.session.set(xt,Ti),G&&await this.client.core.pairing.updateMetadata({topic:G,metadata:Ft.metadata}),Ti=this.client.session.get(xt)),(Se=this.client.metadata.redirect)!=null&&Se.linkMode&&(Nt=Ft.metadata.redirect)!=null&&Nt.linkMode&&(Ke=Ft.metadata.redirect)!=null&&Ke.universal&&a&&(this.client.core.addLinkModeSupportedApp(Ft.metadata.redirect.universal),this.client.session.update(xt,{transportType:pe.link_mode})),As({auths:qs,session:Ti})},Dt=(0,K.payloadId)(),ci=(0,K.payloadId)();this.events.once((0,d.E0T)("session_connect"),xi),this.events.once((0,d.E0T)("session_request",Dt),Ri);let St;try{if(u){const _e=(0,K.formatJsonRpcRequest)("wc_sessionAuthenticate",de,Dt);this.client.core.history.set(G,_e);const Se=await this.client.core.crypto.encode("",_e,{type:d.FpL,encoding:d.zl_});St=(0,d.L9d)(a,G,Se)}else await Promise.all([this.sendRequest({topic:G,method:"wc_sessionAuthenticate",params:de,expiry:s.expiry,throwOnFailedPublish:!0,clientRpcId:Dt}),this.sendRequest({topic:G,method:"wc_sessionPropose",params:gt,expiry:Te.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:ci})])}catch(_e){throw this.events.off((0,d.E0T)("session_connect"),xi),this.events.off((0,d.E0T)("session_request",Dt),Ri),_e}return await this.setProposal(ci,Ee({id:ci},gt)),await this.setAuthRequest(Dt,{request:lt(Ee({},de),{verifyContext:{}}),pairingTopic:G,transportType:l}),{uri:St??ae,response:Kr}},this.approveSessionAuthenticate=async s=>{const{id:a,auths:o}=s,u=this.client.core.eventClient.createEvent({properties:{topic:a.toString(),trace:[ri.authenticated_session_approve_started]}});try{this.isInitialized()}catch(M){throw u.setError(Qi.no_internet_connection),M}const l=this.getPendingAuthRequest(a);if(!l)throw u.setError(Qi.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${a}`);const m=l.transportType||pe.relay;m===pe.relay&&await this.confirmOnlineStateOrThrow();const _=l.requester.publicKey,I=await this.client.core.crypto.generateKeyPair(),T=(0,d.YmJ)(_),O={type:d.rVF,receiverPublicKey:_,senderPublicKey:I},q=[],A=[];for(const M of o){if(!await(0,d.c4l)({cacao:M,projectId:this.client.core.projectId})){u.setError(Qi.invalid_cacao);const J=(0,d.D6H)("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:a,topic:T,error:J,encodeOpts:O}),new Error(J.message)}u.addTrace(ri.cacaos_verified);const{p:$}=M,G=(0,d.hA9)($.resources),ae=[(0,d.DJo)($.iss)],B=(0,d.NmC)($.iss);if(G){const J=(0,d.Y31)(G),fe=(0,d.ouN)(G);q.push(...J),ae.push(...fe)}for(const J of ae)A.push(`${J}:${B}`)}const N=await this.client.core.crypto.generateSharedKey(I,_);u.addTrace(ri.create_authenticated_session_topic);let j;if((q==null?void 0:q.length)>0){j={topic:N,acknowledged:!0,self:{publicKey:I,metadata:this.client.metadata},peer:{publicKey:_,metadata:l.requester.metadata},controller:_,expiry:(0,d.gn4)(Pi),authentication:o,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:l.pairingTopic,namespaces:(0,d.E12)([...new Set(q)],[...new Set(A)]),transportType:m},u.addTrace(ri.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(N,{transportType:m})}catch(M){throw u.setError(Qi.subscribe_authenticated_session_topic_failure),M}u.addTrace(ri.subscribe_authenticated_session_topic_success),await this.client.session.set(N,j),u.addTrace(ri.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:l.pairingTopic,metadata:l.requester.metadata})}u.addTrace(ri.publishing_authenticated_session_approve);try{await this.sendResult({topic:T,id:a,result:{cacaos:o,responder:{publicKey:I,metadata:this.client.metadata}},encodeOpts:O,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(l.requester.metadata,m)})}catch(M){throw u.setError(Qi.authenticated_session_approve_publish_failure),M}return await this.client.auth.requests.delete(a,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:l.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:u.eventId}),{session:j}},this.rejectSessionAuthenticate=async s=>{this.isInitialized();const{id:a,reason:o}=s,u=this.getPendingAuthRequest(a);if(!u)throw new Error(`Could not find pending auth request with id ${a}`);u.transportType===pe.relay&&await this.confirmOnlineStateOrThrow();const l=u.requester.publicKey,m=await this.client.core.crypto.generateKeyPair(),_=(0,d.YmJ)(l),I={type:d.rVF,receiverPublicKey:l,senderPublicKey:m};await this.sendError({id:a,topic:_,error:o,encodeOpts:I,rpcOpts:Te.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(u.requester.metadata,u.transportType)}),await this.client.auth.requests.delete(a,{message:"rejected",code:0}),await this.client.proposal.delete(a,(0,d.D6H)("USER_DISCONNECTED"))},this.formatAuthMessage=s=>{this.isInitialized();const{request:a,iss:o}=s;return(0,d.wvx)(a,o)},this.processRelayMessageCache=()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{const s=this.relayMessageCache.shift();s&&await this.onRelayMessage(s)}catch(s){this.client.logger.error(s)}},50)},this.cleanupDuplicatePairings=async s=>{if(s.pairingTopic)try{const a=this.client.core.pairing.pairings.get(s.pairingTopic),o=this.client.core.pairing.pairings.getAll().filter(u=>{var l,m;return((l=u.peerMetadata)==null?void 0:l.url)&&((m=u.peerMetadata)==null?void 0:m.url)===s.peer.metadata.url&&u.topic&&u.topic!==a.topic});if(o.length===0)return;this.client.logger.info(`Cleaning up ${o.length} duplicate pairing(s)`),await Promise.all(o.map(u=>this.client.core.pairing.disconnect({topic:u.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(a){this.client.logger.error(a)}},this.deleteSession=async s=>{var a;const{topic:o,expirerHasDeleted:u=!1,emitEvent:l=!0,id:m=0}=s,{self:_}=this.client.session.get(o);await this.client.core.relayer.unsubscribe(o),await this.client.session.delete(o,(0,d.D6H)("USER_DISCONNECTED")),this.addToRecentlyDeleted(o,"session"),this.client.core.crypto.keychain.has(_.publicKey)&&await this.client.core.crypto.deleteKeyPair(_.publicKey),this.client.core.crypto.keychain.has(o)&&await this.client.core.crypto.deleteSymKey(o),u||this.client.core.expirer.del(o),this.client.core.storage.removeItem(Xa).catch(I=>this.client.logger.warn(I)),this.getPendingSessionRequests().forEach(I=>{I.topic===o&&this.deletePendingSessionRequest(I.id,(0,d.D6H)("USER_DISCONNECTED"))}),o===((a=this.sessionRequestQueue.queue[0])==null?void 0:a.topic)&&(this.sessionRequestQueue.state=Pt.idle),l&&this.client.events.emit("session_delete",{id:m,topic:o})},this.deleteProposal=async(s,a)=>{if(a)try{const o=this.client.proposal.get(s),u=this.client.core.eventClient.getEvent({topic:o.pairingTopic});u==null||u.setError(si.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(s,(0,d.D6H)("USER_DISCONNECTED")),a?Promise.resolve():this.client.core.expirer.del(s)]),this.addToRecentlyDeleted(s,"proposal")},this.deletePendingSessionRequest=async(s,a,o=!1)=>{await Promise.all([this.client.pendingRequest.delete(s,a),o?Promise.resolve():this.client.core.expirer.del(s)]),this.addToRecentlyDeleted(s,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(u=>u.id!==s),o&&(this.sessionRequestQueue.state=Pt.idle,this.client.events.emit("session_request_expire",{id:s}))},this.deletePendingAuthRequest=async(s,a,o=!1)=>{await Promise.all([this.client.auth.requests.delete(s,a),o?Promise.resolve():this.client.core.expirer.del(s)])},this.setExpiry=async(s,a)=>{this.client.session.keys.includes(s)&&(this.client.core.expirer.set(s,a),await this.client.session.update(s,{expiry:a}))},this.setProposal=async(s,a)=>{this.client.core.expirer.set(s,(0,d.gn4)(Te.wc_sessionPropose.req.ttl)),await this.client.proposal.set(s,a)},this.setAuthRequest=async(s,a)=>{const{request:o,pairingTopic:u,transportType:l=pe.relay}=a;this.client.core.expirer.set(s,o.expiryTimestamp),await this.client.auth.requests.set(s,{authPayload:o.authPayload,requester:o.requester,expiryTimestamp:o.expiryTimestamp,id:s,pairingTopic:u,verifyContext:o.verifyContext,transportType:l})},this.setPendingSessionRequest=async s=>{const{id:a,topic:o,params:u,verifyContext:l}=s,m=u.request.expiryTimestamp||(0,d.gn4)(Te.wc_sessionRequest.req.ttl);this.client.core.expirer.set(a,m),await this.client.pendingRequest.set(a,{id:a,topic:o,params:u,verifyContext:l})},this.sendRequest=async s=>{const{topic:a,method:o,params:u,expiry:l,relayRpcId:m,clientRpcId:_,throwOnFailedPublish:I,appLink:T}=s,O=(0,K.formatJsonRpcRequest)(o,u,_);let q;const A=!!T;try{const M=A?d.zl_:d.$dT;q=await this.client.core.crypto.encode(a,O,{encoding:M})}catch(M){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${a} failed`),M}let N;if(ld.includes(o)){const M=(0,d.rjm)(JSON.stringify(O)),$=(0,d.rjm)(q);N=await this.client.core.verify.register({id:$,decryptedId:M})}const j=Te[o].req;if(j.attestation=N,l&&(j.ttl=l),m&&(j.id=m),this.client.core.history.set(a,O),A){const M=(0,d.L9d)(T,a,q);await se.g.Linking.openURL(M,this.client.name)}else{const M=Te[o].req;l&&(M.ttl=l),m&&(M.id=m),I?(M.internal=lt(Ee({},M.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(a,q,M)):this.client.core.relayer.publish(a,q,M).catch($=>this.client.logger.error($))}return O.id},this.sendResult=async s=>{const{id:a,topic:o,result:u,throwOnFailedPublish:l,encodeOpts:m,appLink:_}=s,I=(0,K.formatJsonRpcResult)(a,u);let T;const O=_&&typeof(se.g==null?void 0:se.g.Linking)<"u";try{const A=O?d.zl_:d.$dT;T=await this.client.core.crypto.encode(o,I,lt(Ee({},m||{}),{encoding:A}))}catch(A){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${o} failed`),A}let q;try{q=await this.client.core.history.get(o,a)}catch(A){throw this.client.logger.error(`sendResult() -> history.get(${o}, ${a}) failed`),A}if(O){const A=(0,d.L9d)(_,o,T);await se.g.Linking.openURL(A,this.client.name)}else{const A=Te[q.request.method].res;l?(A.internal=lt(Ee({},A.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(o,T,A)):this.client.core.relayer.publish(o,T,A).catch(N=>this.client.logger.error(N))}await this.client.core.history.resolve(I)},this.sendError=async s=>{const{id:a,topic:o,error:u,encodeOpts:l,rpcOpts:m,appLink:_}=s,I=(0,K.formatJsonRpcError)(a,u);let T;const O=_&&typeof(se.g==null?void 0:se.g.Linking)<"u";try{const A=O?d.zl_:d.$dT;T=await this.client.core.crypto.encode(o,I,lt(Ee({},l||{}),{encoding:A}))}catch(A){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${o} failed`),A}let q;try{q=await this.client.core.history.get(o,a)}catch(A){throw this.client.logger.error(`sendError() -> history.get(${o}, ${a}) failed`),A}if(O){const A=(0,d.L9d)(_,o,T);await se.g.Linking.openURL(A,this.client.name)}else{const A=m||Te[q.request.method].res;this.client.core.relayer.publish(o,T,A)}await this.client.core.history.resolve(I)},this.cleanup=async()=>{const s=[],a=[];this.client.session.getAll().forEach(o=>{let u=!1;(0,d.BwD)(o.expiry)&&(u=!0),this.client.core.crypto.keychain.has(o.topic)||(u=!0),u&&s.push(o.topic)}),this.client.proposal.getAll().forEach(o=>{(0,d.BwD)(o.expiryTimestamp)&&a.push(o.id)}),await Promise.all([...s.map(o=>this.deleteSession({topic:o})),...a.map(o=>this.deleteProposal(o))])},this.onRelayEventRequest=async s=>{this.requestQueue.queue.push(s),await this.processRequestsQueue()},this.processRequestsQueue=async()=>{if(this.requestQueue.state===Pt.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=Pt.active;const s=this.requestQueue.queue.shift();if(s)try{await this.processRequest(s)}catch(a){this.client.logger.warn(a)}}this.requestQueue.state=Pt.idle},this.processRequest=async s=>{const{topic:a,payload:o,attestation:u,transportType:l,encryptedId:m}=s,_=o.method;if(!this.shouldIgnorePairingRequest({topic:a,requestMethod:_}))switch(_){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:a,payload:o,attestation:u,encryptedId:m});case"wc_sessionSettle":return await this.onSessionSettleRequest(a,o);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(a,o);case"wc_sessionExtend":return await this.onSessionExtendRequest(a,o);case"wc_sessionPing":return await this.onSessionPingRequest(a,o);case"wc_sessionDelete":return await this.onSessionDeleteRequest(a,o);case"wc_sessionRequest":return await this.onSessionRequest({topic:a,payload:o,attestation:u,encryptedId:m,transportType:l});case"wc_sessionEvent":return await this.onSessionEventRequest(a,o);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:a,payload:o,attestation:u,encryptedId:m,transportType:l});default:return this.client.logger.info(`Unsupported request method ${_}`)}},this.onRelayEventResponse=async s=>{const{topic:a,payload:o,transportType:u}=s,l=(await this.client.core.history.get(a,o.id)).request.method;switch(l){case"wc_sessionPropose":return this.onSessionProposeResponse(a,o,u);case"wc_sessionSettle":return this.onSessionSettleResponse(a,o);case"wc_sessionUpdate":return this.onSessionUpdateResponse(a,o);case"wc_sessionExtend":return this.onSessionExtendResponse(a,o);case"wc_sessionPing":return this.onSessionPingResponse(a,o);case"wc_sessionRequest":return this.onSessionRequestResponse(a,o);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(a,o);default:return this.client.logger.info(`Unsupported response method ${l}`)}},this.onRelayEventUnknownPayload=s=>{const{topic:a}=s,{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`Decoded payload on topic ${a} is not identifiable as a JSON-RPC request or a response.`);throw new Error(o)},this.shouldIgnorePairingRequest=s=>{const{topic:a,requestMethod:o}=s,u=this.expectedPairingMethodMap.get(a);return!u||u.includes(o)?!1:!!(u.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)},this.onSessionProposeRequest=async s=>{const{topic:a,payload:o,attestation:u,encryptedId:l}=s,{params:m,id:_}=o;try{const I=this.client.core.eventClient.getEvent({topic:a});this.isValidConnect(Ee({},o.params));const T=m.expiryTimestamp||(0,d.gn4)(Te.wc_sessionPropose.req.ttl),O=Ee({id:_,pairingTopic:a,expiryTimestamp:T},m);await this.setProposal(_,O);const q=await this.getVerifyContext({attestationId:u,hash:(0,d.rjm)(JSON.stringify(o)),encryptedId:l,metadata:O.proposer.metadata});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),I==null||I.setError(qt.proposal_listener_not_found)),I==null||I.addTrace(It.emit_session_proposal),this.client.events.emit("session_proposal",{id:_,params:O,verifyContext:q})}catch(I){await this.sendError({id:_,topic:a,error:I,rpcOpts:Te.wc_sessionPropose.autoReject}),this.client.logger.error(I)}},this.onSessionProposeResponse=async(s,a,o)=>{const{id:u}=a;if((0,K.isJsonRpcResult)(a)){const{result:l}=a;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:l});const m=this.client.proposal.get(u);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:m});const _=m.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:_});const I=l.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:I});const T=await this.client.core.crypto.generateSharedKey(_,I);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",sessionTopic:T});const O=await this.client.core.relayer.subscribe(T,{transportType:o});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:O}),await this.client.core.pairing.activate({topic:s})}else if((0,K.isJsonRpcError)(a)){await this.client.proposal.delete(u,(0,d.D6H)("USER_DISCONNECTED"));const l=(0,d.E0T)("session_connect");if(this.events.listenerCount(l)===0)throw new Error(`emitting ${l} without any listeners, 954`);this.events.emit((0,d.E0T)("session_connect"),{error:a.error})}},this.onSessionSettleRequest=async(s,a)=>{const{id:o,params:u}=a;try{this.isValidSessionSettleRequest(u);const{relay:l,controller:m,expiry:_,namespaces:I,sessionProperties:T,sessionConfig:O}=a.params,q=lt(Ee(Ee({topic:s,relay:l,expiry:_,namespaces:I,acknowledged:!0,pairingTopic:"",requiredNamespaces:{},optionalNamespaces:{},controller:m.publicKey,self:{publicKey:"",metadata:this.client.metadata},peer:{publicKey:m.publicKey,metadata:m.metadata}},T&&{sessionProperties:T}),O&&{sessionConfig:O}),{transportType:pe.relay}),A=(0,d.E0T)("session_connect");if(this.events.listenerCount(A)===0)throw new Error(`emitting ${A} without any listeners 997`);this.events.emit((0,d.E0T)("session_connect"),{session:q}),await this.sendResult({id:a.id,topic:s,result:!0,throwOnFailedPublish:!0})}catch(l){await this.sendError({id:o,topic:s,error:l}),this.client.logger.error(l)}},this.onSessionSettleResponse=async(s,a)=>{const{id:o}=a;(0,K.isJsonRpcResult)(a)?(await this.client.session.update(s,{acknowledged:!0}),this.events.emit((0,d.E0T)("session_approve",o),{})):(0,K.isJsonRpcError)(a)&&(await this.client.session.delete(s,(0,d.D6H)("USER_DISCONNECTED")),this.events.emit((0,d.E0T)("session_approve",o),{error:a.error}))},this.onSessionUpdateRequest=async(s,a)=>{const{params:o,id:u}=a;try{const l=`${s}_session_update`,m=d.O6B.get(l);if(m&&this.isRequestOutOfSync(m,u)){this.client.logger.info(`Discarding out of sync request - ${u}`),this.sendError({id:u,topic:s,error:(0,d.D6H)("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(Ee({topic:s},o));try{d.O6B.set(l,u),await this.client.session.update(s,{namespaces:o.namespaces}),await this.sendResult({id:u,topic:s,result:!0,throwOnFailedPublish:!0})}catch(_){throw d.O6B.delete(l),_}this.client.events.emit("session_update",{id:u,topic:s,params:o})}catch(l){await this.sendError({id:u,topic:s,error:l}),this.client.logger.error(l)}},this.isRequestOutOfSync=(s,a)=>parseInt(a.toString().slice(0,-3))<=parseInt(s.toString().slice(0,-3)),this.onSessionUpdateResponse=(s,a)=>{const{id:o}=a,u=(0,d.E0T)("session_update",o);if(this.events.listenerCount(u)===0)throw new Error(`emitting ${u} without any listeners`);(0,K.isJsonRpcResult)(a)?this.events.emit((0,d.E0T)("session_update",o),{}):(0,K.isJsonRpcError)(a)&&this.events.emit((0,d.E0T)("session_update",o),{error:a.error})},this.onSessionExtendRequest=async(s,a)=>{const{id:o}=a;try{this.isValidExtend({topic:s}),await this.setExpiry(s,(0,d.gn4)(Pi)),await this.sendResult({id:o,topic:s,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_extend",{id:o,topic:s})}catch(u){await this.sendError({id:o,topic:s,error:u}),this.client.logger.error(u)}},this.onSessionExtendResponse=(s,a)=>{const{id:o}=a,u=(0,d.E0T)("session_extend",o);if(this.events.listenerCount(u)===0)throw new Error(`emitting ${u} without any listeners`);(0,K.isJsonRpcResult)(a)?this.events.emit((0,d.E0T)("session_extend",o),{}):(0,K.isJsonRpcError)(a)&&this.events.emit((0,d.E0T)("session_extend",o),{error:a.error})},this.onSessionPingRequest=async(s,a)=>{const{id:o}=a;try{this.isValidPing({topic:s}),await this.sendResult({id:o,topic:s,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:o,topic:s})}catch(u){await this.sendError({id:o,topic:s,error:u}),this.client.logger.error(u)}},this.onSessionPingResponse=(s,a)=>{const{id:o}=a,u=(0,d.E0T)("session_ping",o);if(this.events.listenerCount(u)===0)throw new Error(`emitting ${u} without any listeners`);setTimeout(()=>{(0,K.isJsonRpcResult)(a)?this.events.emit((0,d.E0T)("session_ping",o),{}):(0,K.isJsonRpcError)(a)&&this.events.emit((0,d.E0T)("session_ping",o),{error:a.error})},500)},this.onSessionDeleteRequest=async(s,a)=>{const{id:o}=a;try{this.isValidDisconnect({topic:s,reason:a.params}),Promise.all([new Promise(u=>{this.client.core.relayer.once(ke.publish,async()=>{u(await this.deleteSession({topic:s,id:o}))})}),this.sendResult({id:o,topic:s,result:!0,throwOnFailedPublish:!0}),this.cleanupPendingSentRequestsForTopic({topic:s,error:(0,d.D6H)("USER_DISCONNECTED")})]).catch(u=>this.client.logger.error(u))}catch(u){this.client.logger.error(u)}},this.onSessionRequest=async s=>{var a,o,u;const{topic:l,payload:m,attestation:_,encryptedId:I,transportType:T}=s,{id:O,params:q}=m;try{await this.isValidRequest(Ee({topic:l},q));const A=this.client.session.get(l),N=await this.getVerifyContext({attestationId:_,hash:(0,d.rjm)(JSON.stringify((0,K.formatJsonRpcRequest)("wc_sessionRequest",q,O))),encryptedId:I,metadata:A.peer.metadata,transportType:T}),j={id:O,topic:l,params:q,verifyContext:N};await this.setPendingSessionRequest(j),T===pe.link_mode&&(a=A.peer.metadata.redirect)!=null&&a.universal&&this.client.core.addLinkModeSupportedApp((o=A.peer.metadata.redirect)==null?void 0:o.universal),(u=this.client.signConfig)!=null&&u.disableRequestQueue?this.emitSessionRequest(j):(this.addSessionRequestToSessionRequestQueue(j),this.processSessionRequestQueue())}catch(A){await this.sendError({id:O,topic:l,error:A}),this.client.logger.error(A)}},this.onSessionRequestResponse=(s,a)=>{const{id:o}=a,u=(0,d.E0T)("session_request",o);if(this.events.listenerCount(u)===0)throw new Error(`emitting ${u} without any listeners`);(0,K.isJsonRpcResult)(a)?this.events.emit((0,d.E0T)("session_request",o),{result:a.result}):(0,K.isJsonRpcError)(a)&&this.events.emit((0,d.E0T)("session_request",o),{error:a.error})},this.onSessionEventRequest=async(s,a)=>{const{id:o,params:u}=a;try{const l=`${s}_session_event_${u.event.name}`,m=d.O6B.get(l);if(m&&this.isRequestOutOfSync(m,o)){this.client.logger.info(`Discarding out of sync request - ${o}`);return}this.isValidEmit(Ee({topic:s},u)),this.client.events.emit("session_event",{id:o,topic:s,params:u}),d.O6B.set(l,o)}catch(l){await this.sendError({id:o,topic:s,error:l}),this.client.logger.error(l)}},this.onSessionAuthenticateResponse=(s,a)=>{const{id:o}=a;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:s,payload:a}),(0,K.isJsonRpcResult)(a)?this.events.emit((0,d.E0T)("session_request",o),{result:a.result}):(0,K.isJsonRpcError)(a)&&this.events.emit((0,d.E0T)("session_request",o),{error:a.error})},this.onSessionAuthenticateRequest=async s=>{var a;const{topic:o,payload:u,attestation:l,encryptedId:m,transportType:_}=s;try{const{requester:I,authPayload:T,expiryTimestamp:O}=u.params,q=await this.getVerifyContext({attestationId:l,hash:(0,d.rjm)(JSON.stringify(u)),encryptedId:m,metadata:I.metadata,transportType:_}),A={requester:I,pairingTopic:o,id:u.id,authPayload:T,verifyContext:q,expiryTimestamp:O};await this.setAuthRequest(u.id,{request:A,pairingTopic:o,transportType:_}),_===pe.link_mode&&(a=I.metadata.redirect)!=null&&a.universal&&this.client.core.addLinkModeSupportedApp(I.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:o,params:u.params,id:u.id,verifyContext:q})}catch(I){this.client.logger.error(I);const T=u.params.requester.publicKey,O=await this.client.core.crypto.generateKeyPair(),q=this.getAppLinkIfEnabled(u.params.requester.metadata,_),A={type:d.rVF,receiverPublicKey:T,senderPublicKey:O};await this.sendError({id:u.id,topic:o,error:I,encodeOpts:A,rpcOpts:Te.wc_sessionAuthenticate.autoReject,appLink:q})}},this.addSessionRequestToSessionRequestQueue=s=>{this.sessionRequestQueue.queue.push(s)},this.cleanupAfterResponse=s=>{this.deletePendingSessionRequest(s.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=Pt.idle,this.processSessionRequestQueue()},(0,F.toMiliseconds)(this.requestQueueDelay))},this.cleanupPendingSentRequestsForTopic=({topic:s,error:a})=>{const o=this.client.core.history.pending;o.length>0&&o.filter(u=>u.topic===s&&u.request.method==="wc_sessionRequest").forEach(u=>{const l=u.request.id,m=(0,d.E0T)("session_request",l);if(this.events.listenerCount(m)===0)throw new Error(`emitting ${m} without any listeners`);this.events.emit((0,d.E0T)("session_request",u.request.id),{error:a})})},this.processSessionRequestQueue=()=>{if(this.sessionRequestQueue.state===Pt.active){this.client.logger.info("session request queue is already active.");return}const s=this.sessionRequestQueue.queue[0];if(!s){this.client.logger.info("session request queue is empty.");return}try{this.sessionRequestQueue.state=Pt.active,this.emitSessionRequest(s)}catch(a){this.client.logger.error(a)}},this.emitSessionRequest=s=>{this.client.events.emit("session_request",s)},this.onPairingCreated=s=>{if(s.methods&&this.expectedPairingMethodMap.set(s.topic,s.methods),s.active)return;const a=this.client.proposal.getAll().find(o=>o.pairingTopic===s.topic);a&&this.onSessionProposeRequest({topic:s.topic,payload:(0,K.formatJsonRpcRequest)("wc_sessionPropose",{requiredNamespaces:a.requiredNamespaces,optionalNamespaces:a.optionalNamespaces,relays:a.relays,proposer:a.proposer,sessionProperties:a.sessionProperties},a.id)})},this.isValidConnect=async s=>{if(!(0,d.EJd)(s)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(s)}`);throw new Error(_)}const{pairingTopic:a,requiredNamespaces:o,optionalNamespaces:u,sessionProperties:l,relays:m}=s;if((0,d.o8e)(a)||await this.isValidPairingTopic(a),!(0,d.PMr)(m,!0)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`connect() relays: ${m}`);throw new Error(_)}!(0,d.o8e)(o)&&(0,d.L5o)(o)!==0&&this.validateNamespaces(o,"requiredNamespaces"),!(0,d.o8e)(u)&&(0,d.L5o)(u)!==0&&this.validateNamespaces(u,"optionalNamespaces"),(0,d.o8e)(l)||this.validateSessionProps(l,"sessionProperties")},this.validateNamespaces=(s,a)=>{const o=(0,d.naP)(s,"connect()",a);if(o)throw new Error(o.message)},this.isValidApprove=async s=>{if(!(0,d.EJd)(s))throw new Error((0,d.kCb)("MISSING_OR_INVALID",`approve() params: ${s}`).message);const{id:a,namespaces:o,relayProtocol:u,sessionProperties:l}=s;this.checkRecentlyDeleted(a),await this.isValidProposalId(a);const m=this.client.proposal.get(a),_=(0,d.ing)(o,"approve()");if(_)throw new Error(_.message);const I=(0,d.rFo)(m.requiredNamespaces,o,"approve()");if(I)throw new Error(I.message);if(!(0,d.M_r)(u,!0)){const{message:T}=(0,d.kCb)("MISSING_OR_INVALID",`approve() relayProtocol: ${u}`);throw new Error(T)}(0,d.o8e)(l)||this.validateSessionProps(l,"sessionProperties")},this.isValidReject=async s=>{if(!(0,d.EJd)(s)){const{message:u}=(0,d.kCb)("MISSING_OR_INVALID",`reject() params: ${s}`);throw new Error(u)}const{id:a,reason:o}=s;if(this.checkRecentlyDeleted(a),await this.isValidProposalId(a),!(0,d.H4H)(o)){const{message:u}=(0,d.kCb)("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(o)}`);throw new Error(u)}},this.isValidSessionSettleRequest=s=>{if(!(0,d.EJd)(s)){const{message:I}=(0,d.kCb)("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${s}`);throw new Error(I)}const{relay:a,controller:o,namespaces:u,expiry:l}=s;if(!(0,d.Z26)(a)){const{message:I}=(0,d.kCb)("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(I)}const m=(0,d.DdM)(o,"onSessionSettleRequest()");if(m)throw new Error(m.message);const _=(0,d.ing)(u,"onSessionSettleRequest()");if(_)throw new Error(_.message);if((0,d.BwD)(l)){const{message:I}=(0,d.kCb)("EXPIRED","onSessionSettleRequest()");throw new Error(I)}},this.isValidUpdate=async s=>{if(!(0,d.EJd)(s)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`update() params: ${s}`);throw new Error(_)}const{topic:a,namespaces:o}=s;this.checkRecentlyDeleted(a),await this.isValidSessionTopic(a);const u=this.client.session.get(a),l=(0,d.ing)(o,"update()");if(l)throw new Error(l.message);const m=(0,d.rFo)(u.requiredNamespaces,o,"update()");if(m)throw new Error(m.message)},this.isValidExtend=async s=>{if(!(0,d.EJd)(s)){const{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`extend() params: ${s}`);throw new Error(o)}const{topic:a}=s;this.checkRecentlyDeleted(a),await this.isValidSessionTopic(a)},this.isValidRequest=async s=>{if(!(0,d.EJd)(s)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`request() params: ${s}`);throw new Error(_)}const{topic:a,request:o,chainId:u,expiry:l}=s;this.checkRecentlyDeleted(a),await this.isValidSessionTopic(a);const{namespaces:m}=this.client.session.get(a);if(!(0,d.p8o)(m,u)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`request() chainId: ${u}`);throw new Error(_)}if(!(0,d.hHR)(o)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`request() ${JSON.stringify(o)}`);throw new Error(_)}if(!(0,d.alS)(m,u,o.method)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`request() method: ${o.method}`);throw new Error(_)}if(l&&!(0,d.ONw)(l,qr)){const{message:_}=(0,d.kCb)("MISSING_OR_INVALID",`request() expiry: ${l}. Expiry must be a number (in seconds) between ${qr.min} and ${qr.max}`);throw new Error(_)}},this.isValidRespond=async s=>{var a;if(!(0,d.EJd)(s)){const{message:l}=(0,d.kCb)("MISSING_OR_INVALID",`respond() params: ${s}`);throw new Error(l)}const{topic:o,response:u}=s;try{await this.isValidSessionTopic(o)}catch(l){throw(a=s==null?void 0:s.response)!=null&&a.id&&this.cleanupAfterResponse(s),l}if(!(0,d.JTI)(u)){const{message:l}=(0,d.kCb)("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(u)}`);throw new Error(l)}},this.isValidPing=async s=>{if(!(0,d.EJd)(s)){const{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`ping() params: ${s}`);throw new Error(o)}const{topic:a}=s;await this.isValidSessionOrPairingTopic(a)},this.isValidEmit=async s=>{if(!(0,d.EJd)(s)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID",`emit() params: ${s}`);throw new Error(m)}const{topic:a,event:o,chainId:u}=s;await this.isValidSessionTopic(a);const{namespaces:l}=this.client.session.get(a);if(!(0,d.p8o)(l,u)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID",`emit() chainId: ${u}`);throw new Error(m)}if(!(0,d.nfW)(o)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(o)}`);throw new Error(m)}if(!(0,d.B95)(l,u,o.name)){const{message:m}=(0,d.kCb)("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(o)}`);throw new Error(m)}},this.isValidDisconnect=async s=>{if(!(0,d.EJd)(s)){const{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`disconnect() params: ${s}`);throw new Error(o)}const{topic:a}=s;await this.isValidSessionOrPairingTopic(a)},this.isValidAuthenticate=s=>{const{chains:a,uri:o,domain:u,nonce:l}=s;if(!Array.isArray(a)||a.length===0)throw new Error("chains is required and must be a non-empty array");if(!(0,d.M_r)(o,!1))throw new Error("uri is required parameter");if(!(0,d.M_r)(u,!1))throw new Error("domain is required parameter");if(!(0,d.M_r)(l,!1))throw new Error("nonce is required parameter");if([...new Set(a.map(_=>(0,d.DQe)(_).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");const{namespace:m}=(0,d.DQe)(a[0]);if(m!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")},this.getVerifyContext=async s=>{const{attestationId:a,hash:o,encryptedId:u,metadata:l,transportType:m}=s,_={verified:{verifyUrl:l.verifyUrl||Wi,validation:"UNKNOWN",origin:l.url||""}};try{if(m===pe.link_mode){const T=this.getAppLinkIfEnabled(l,m);return _.verified.validation=T&&new URL(T).origin===new URL(l.url).origin?"VALID":"INVALID",_}const I=await this.client.core.verify.resolve({attestationId:a,hash:o,encryptedId:u,verifyUrl:l.verifyUrl});I&&(_.verified.origin=I.origin,_.verified.isScam=I.isScam,_.verified.validation=I.origin===new URL(l.url).origin?"VALID":"INVALID")}catch(I){this.client.logger.warn(I)}return this.client.logger.debug(`Verify context: ${JSON.stringify(_)}`),_},this.validateSessionProps=(s,a)=>{Object.values(s).forEach(o=>{if(!(0,d.M_r)(o,!1)){const{message:u}=(0,d.kCb)("MISSING_OR_INVALID",`${a} must be in Record<string, string> format. Received: ${JSON.stringify(o)}`);throw new Error(u)}})},this.getPendingAuthRequest=s=>{const a=this.client.auth.requests.get(s);return typeof a=="object"?a:void 0},this.addToRecentlyDeleted=(s,a)=>{if(this.recentlyDeletedMap.set(s,a),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let o=0;const u=this.recentlyDeletedLimit/2;for(const l of this.recentlyDeletedMap.keys()){if(o++>=u)break;this.recentlyDeletedMap.delete(l)}}},this.checkRecentlyDeleted=s=>{const a=this.recentlyDeletedMap.get(s);if(a){const{message:o}=(0,d.kCb)("MISSING_OR_INVALID",`Record was recently deleted - ${a}: ${s}`);throw new Error(o)}},this.isLinkModeEnabled=(s,a)=>{var o,u,l,m,_,I,T,O,q;return!s||a!==pe.link_mode?!1:((u=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:u.linkMode)===!0&&((m=(l=this.client.metadata)==null?void 0:l.redirect)==null?void 0:m.universal)!==void 0&&((I=(_=this.client.metadata)==null?void 0:_.redirect)==null?void 0:I.universal)!==""&&((T=s==null?void 0:s.redirect)==null?void 0:T.universal)!==void 0&&((O=s==null?void 0:s.redirect)==null?void 0:O.universal)!==""&&((q=s==null?void 0:s.redirect)==null?void 0:q.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(s.redirect.universal)&&typeof(se.g==null?void 0:se.g.Linking)<"u"},this.getAppLinkIfEnabled=(s,a)=>{var o;return this.isLinkModeEnabled(s,a)?(o=s==null?void 0:s.redirect)==null?void 0:o.universal:void 0},this.handleLinkModeMessage=({url:s})=>{if(!s||!s.includes("wc_ev")||!s.includes("topic"))return;const a=(0,d.waw)(s,"topic")||"",o=decodeURIComponent((0,d.waw)(s,"wc_ev")||""),u=this.client.session.keys.includes(a);u&&this.client.session.update(a,{transportType:pe.link_mode}),this.client.core.dispatchEnvelope({topic:a,message:o,sessionExists:u})},this.registerLinkModeListeners=async()=>{var s;if(typeof ad<"u"&&{NODE_ENV:"production",PUBLIC_PATH:"/"}.IS_VITEST||(0,d.b$m)()&&(s=this.client.metadata.redirect)!=null&&s.linkMode){const a=se.g==null?void 0:se.g.Linking;if(typeof a<"u"){a.addEventListener("url",this.handleLinkModeMessage,this.client.name);const o=await a.getInitialURL();o&&setTimeout(()=>{this.handleLinkModeMessage({url:o})},50)}}}}isInitialized(){if(!this.initialized){const{message:r}=(0,d.kCb)("NOT_INITIALIZED",this.name);throw new Error(r)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(ke.message,r=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(r):this.onRelayMessage(r)})}async onRelayMessage(r){const{topic:s,message:a,attestation:o,transportType:u}=r,{publicKey:l}=this.client.auth.authKeys.keys.includes(Ss)?this.client.auth.authKeys.get(Ss):{responseTopic:void 0,publicKey:void 0},m=await this.client.core.crypto.decode(s,a,{receiverPublicKey:l,encoding:u===pe.link_mode?d.zl_:d.$dT});try{(0,K.isJsonRpcRequest)(m)?(this.client.core.history.set(s,m),this.onRelayEventRequest({topic:s,payload:m,attestation:o,transportType:u,encryptedId:(0,d.rjm)(a)})):(0,K.isJsonRpcResponse)(m)?(await this.client.core.history.resolve(m),await this.onRelayEventResponse({topic:s,payload:m,transportType:u}),this.client.core.history.delete(s,m.id)):this.onRelayEventUnknownPayload({topic:s,payload:m,transportType:u})}catch(_){this.client.logger.error(_)}}registerExpirerEvents(){this.client.core.expirer.on(Xe.expired,async r=>{const{topic:s,id:a}=(0,d.iPz)(r.target);if(a&&this.client.pendingRequest.keys.includes(a))return await this.deletePendingSessionRequest(a,(0,d.kCb)("EXPIRED"),!0);if(a&&this.client.auth.requests.keys.includes(a))return await this.deletePendingAuthRequest(a,(0,d.kCb)("EXPIRED"),!0);s?this.client.session.keys.includes(s)&&(await this.deleteSession({topic:s,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:s})):a&&(await this.deleteProposal(a,!0),this.client.events.emit("proposal_expire",{id:a}))})}registerPairingEvents(){this.client.core.pairing.events.on(Ei.create,r=>this.onPairingCreated(r)),this.client.core.pairing.events.on(Ei.delete,r=>{this.addToRecentlyDeleted(r.topic,"pairing")})}isValidPairingTopic(r){if(!(0,d.M_r)(r,!1)){const{message:s}=(0,d.kCb)("MISSING_OR_INVALID",`pairing topic should be a string: ${r}`);throw new Error(s)}if(!this.client.core.pairing.pairings.keys.includes(r)){const{message:s}=(0,d.kCb)("NO_MATCHING_KEY",`pairing topic doesn't exist: ${r}`);throw new Error(s)}if((0,d.BwD)(this.client.core.pairing.pairings.get(r).expiry)){const{message:s}=(0,d.kCb)("EXPIRED",`pairing topic: ${r}`);throw new Error(s)}}async isValidSessionTopic(r){if(!(0,d.M_r)(r,!1)){const{message:s}=(0,d.kCb)("MISSING_OR_INVALID",`session topic should be a string: ${r}`);throw new Error(s)}if(this.checkRecentlyDeleted(r),!this.client.session.keys.includes(r)){const{message:s}=(0,d.kCb)("NO_MATCHING_KEY",`session topic doesn't exist: ${r}`);throw new Error(s)}if((0,d.BwD)(this.client.session.get(r).expiry)){await this.deleteSession({topic:r});const{message:s}=(0,d.kCb)("EXPIRED",`session topic: ${r}`);throw new Error(s)}if(!this.client.core.crypto.keychain.has(r)){const{message:s}=(0,d.kCb)("MISSING_OR_INVALID",`session topic does not exist in keychain: ${r}`);throw await this.deleteSession({topic:r}),new Error(s)}}async isValidSessionOrPairingTopic(r){if(this.checkRecentlyDeleted(r),this.client.session.keys.includes(r))await this.isValidSessionTopic(r);else if(this.client.core.pairing.pairings.keys.includes(r))this.isValidPairingTopic(r);else if((0,d.M_r)(r,!1)){const{message:s}=(0,d.kCb)("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${r}`);throw new Error(s)}else{const{message:s}=(0,d.kCb)("MISSING_OR_INVALID",`session or pairing topic should be a string: ${r}`);throw new Error(s)}}async isValidProposalId(r){if(!(0,d.Q01)(r)){const{message:s}=(0,d.kCb)("MISSING_OR_INVALID",`proposal id should be a number: ${r}`);throw new Error(s)}if(!this.client.proposal.keys.includes(r)){const{message:s}=(0,d.kCb)("NO_MATCHING_KEY",`proposal id doesn't exist: ${r}`);throw new Error(s)}if((0,d.BwD)(this.client.proposal.get(r).expiryTimestamp)){await this.deleteProposal(r);const{message:s}=(0,d.kCb)("EXPIRED",`proposal id: ${r}`);throw new Error(s)}}}class Id extends ni{constructor(r,s){super(r,s,od,Or),this.core=r,this.logger=s}}class Pd extends ni{constructor(r,s){super(r,s,cd,Or),this.core=r,this.logger=s}}class Cd extends ni{constructor(r,s){super(r,s,ud,Or,a=>a.id),this.core=r,this.logger=s}}class Sd extends ni{constructor(r,s){super(r,s,gd,Cs,()=>Ss),this.core=r,this.logger=s}}class xd extends ni{constructor(r,s){super(r,s,fd,Cs),this.core=r,this.logger=s}}class Rd extends ni{constructor(r,s){super(r,s,yd,Cs,a=>a.id),this.core=r,this.logger=s}}class Td{constructor(r,s){this.core=r,this.logger=s,this.authKeys=new Sd(this.core,this.logger),this.pairingTopics=new xd(this.core,this.logger),this.requests=new Rd(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}}class Dr extends hu{constructor(r){super(r),this.protocol=Qa,this.version=Ya,this.name=Ar.name,this.events=new At.EventEmitter,this.on=(a,o)=>this.events.on(a,o),this.once=(a,o)=>this.events.once(a,o),this.off=(a,o)=>this.events.off(a,o),this.removeListener=(a,o)=>this.events.removeListener(a,o),this.removeAllListeners=a=>this.events.removeAllListeners(a),this.connect=async a=>{try{return await this.engine.connect(a)}catch(o){throw this.logger.error(o.message),o}},this.pair=async a=>{try{return await this.engine.pair(a)}catch(o){throw this.logger.error(o.message),o}},this.approve=async a=>{try{return await this.engine.approve(a)}catch(o){throw this.logger.error(o.message),o}},this.reject=async a=>{try{return await this.engine.reject(a)}catch(o){throw this.logger.error(o.message),o}},this.update=async a=>{try{return await this.engine.update(a)}catch(o){throw this.logger.error(o.message),o}},this.extend=async a=>{try{return await this.engine.extend(a)}catch(o){throw this.logger.error(o.message),o}},this.request=async a=>{try{return await this.engine.request(a)}catch(o){throw this.logger.error(o.message),o}},this.respond=async a=>{try{return await this.engine.respond(a)}catch(o){throw this.logger.error(o.message),o}},this.ping=async a=>{try{return await this.engine.ping(a)}catch(o){throw this.logger.error(o.message),o}},this.emit=async a=>{try{return await this.engine.emit(a)}catch(o){throw this.logger.error(o.message),o}},this.disconnect=async a=>{try{return await this.engine.disconnect(a)}catch(o){throw this.logger.error(o.message),o}},this.find=a=>{try{return this.engine.find(a)}catch(o){throw this.logger.error(o.message),o}},this.getPendingSessionRequests=()=>{try{return this.engine.getPendingSessionRequests()}catch(a){throw this.logger.error(a.message),a}},this.authenticate=async(a,o)=>{try{return await this.engine.authenticate(a,o)}catch(u){throw this.logger.error(u.message),u}},this.formatAuthMessage=a=>{try{return this.engine.formatAuthMessage(a)}catch(o){throw this.logger.error(o.message),o}},this.approveSessionAuthenticate=async a=>{try{return await this.engine.approveSessionAuthenticate(a)}catch(o){throw this.logger.error(o.message),o}},this.rejectSessionAuthenticate=async a=>{try{return await this.engine.rejectSessionAuthenticate(a)}catch(o){throw this.logger.error(o.message),o}},this.name=(r==null?void 0:r.name)||Ar.name,this.metadata=(r==null?void 0:r.metadata)||(0,d.DaH)(),this.signConfig=r==null?void 0:r.signConfig;const s=typeof(r==null?void 0:r.logger)<"u"&&typeof(r==null?void 0:r.logger)!="string"?r.logger:(0,te.gw)((0,te.jI)({level:(r==null?void 0:r.logger)||Ar.logger}));this.core=(r==null?void 0:r.core)||new nd(r),this.logger=(0,te.Ep)(s,this.name),this.session=new Pd(this.core,this.logger),this.proposal=new Id(this.core,this.logger),this.pendingRequest=new Cd(this.core,this.logger),this.engine=new Ed(this),this.auth=new Td(this.core,this.logger)}static async init(r){const s=new Dr(r);return await s.initialize(),s}get context(){return(0,te.Fd)(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success"),this.engine.processRelayMessageCache()}catch(r){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(r.message),r}}}const Rb=null,Tb=null;var Ct=se(51916);const so="error",Od="wss://relay.walletconnect.com",Ad="wc",qd="universal_provider",ro=`${Ad}@2:${qd}:`,Dd="https://rpc.walletconnect.com/v1/",Ci="generic",pt={DEFAULT_CHAIN_CHANGED:"default_chain_changed"};var Xi=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof se.g<"u"?se.g:typeof self<"u"?self:{},Nr={exports:{}};(function(y,r){(function(){var s,a="4.17.21",o=200,u="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",l="Expected a function",m="Invalid `variable` option passed into `_.template`",_="__lodash_hash_undefined__",I=500,T="__lodash_placeholder__",O=1,q=2,A=4,N=1,j=2,M=1,$=2,G=4,ae=8,B=16,J=32,fe=64,de=128,oe=256,gt=512,Kr=30,As="...",es=800,xi=16,Ri=1,Dt=2,ci=3,St=1/0,_e=9007199254740991,Se=17976931348623157e292,Nt=NaN,Ke=4294967295,qs=Ke-1,Ft=Ke>>>1,is=[["ary",de],["bind",M],["bindKey",$],["curry",ae],["curryRight",B],["flip",gt],["partial",J],["partialRight",fe],["rearg",oe]],kt="[object Arguments]",xt="[object Array]",Ti="[object AsyncFunction]",ft="[object Boolean]",Mt="[object Date]",ss="[object DOMException]",hi="[object Error]",Oi="[object Function]",Ai="[object GeneratorFunction]",Ve="[object Map]",rs="[object Number]",Eg="[object Null]",$t="[object Object]",_o="[object Promise]",Ig="[object Proxy]",ns="[object RegExp]",yt="[object Set]",as="[object String]",Ds="[object Symbol]",Pg="[object Undefined]",os="[object WeakMap]",Cg="[object WeakSet]",cs="[object ArrayBuffer]",qi="[object DataView]",Vr="[object Float32Array]",Br="[object Float64Array]",Jr="[object Int8Array]",Gr="[object Int16Array]",Wr="[object Int32Array]",Qr="[object Uint8Array]",Yr="[object Uint8ClampedArray]",Zr="[object Uint16Array]",Xr="[object Uint32Array]",Sg=/\b__p \+= '';/g,xg=/\b(__p \+=) '' \+/g,Rg=/(__e\(.*?\)|\b__t\)) \+\n'';/g,bo=/&(?:amp|lt|gt|quot|#39);/g,Eo=/[&<>"']/g,Tg=RegExp(bo.source),Og=RegExp(Eo.source),Ag=/<%-([\s\S]+?)%>/g,qg=/<%([\s\S]+?)%>/g,Io=/<%=([\s\S]+?)%>/g,Dg=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ng=/^\w*$/,Fg=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,en=/[\\^$.*+?()[\]{}|]/g,kg=RegExp(en.source),tn=/^\s+/,Mg=/\s/,$g=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,jg=/\{\n\/\* \[wrapped with (.+)\] \*/,Lg=/,? & /,zg=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Ug=/[()=,{}\[\]\/\s]/,Hg=/\\(\\)?/g,Kg=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Po=/\w*$/,Vg=/^[-+]0x[0-9a-f]+$/i,Bg=/^0b[01]+$/i,Jg=/^\[object .+?Constructor\]$/,Gg=/^0o[0-7]+$/i,Wg=/^(?:0|[1-9]\d*)$/,Qg=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Ns=/($^)/,Yg=/['\n\r\u2028\u2029\\]/g,Fs="\\ud800-\\udfff",Zg="\\u0300-\\u036f",Xg="\\ufe20-\\ufe2f",ef="\\u20d0-\\u20ff",Co=Zg+Xg+ef,So="\\u2700-\\u27bf",xo="a-z\\xdf-\\xf6\\xf8-\\xff",tf="\\xac\\xb1\\xd7\\xf7",sf="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",rf="\\u2000-\\u206f",nf=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Ro="A-Z\\xc0-\\xd6\\xd8-\\xde",To="\\ufe0e\\ufe0f",Oo=tf+sf+rf+nf,sn="['\u2019]",af="["+Fs+"]",Ao="["+Oo+"]",ks="["+Co+"]",qo="\\d+",of="["+So+"]",Do="["+xo+"]",No="[^"+Fs+Oo+qo+So+xo+Ro+"]",rn="\\ud83c[\\udffb-\\udfff]",cf="(?:"+ks+"|"+rn+")",Fo="[^"+Fs+"]",nn="(?:\\ud83c[\\udde6-\\uddff]){2}",an="[\\ud800-\\udbff][\\udc00-\\udfff]",Di="["+Ro+"]",ko="\\u200d",Mo="(?:"+Do+"|"+No+")",hf="(?:"+Di+"|"+No+")",$o="(?:"+sn+"(?:d|ll|m|re|s|t|ve))?",jo="(?:"+sn+"(?:D|LL|M|RE|S|T|VE))?",Lo=cf+"?",zo="["+To+"]?",uf="(?:"+ko+"(?:"+[Fo,nn,an].join("|")+")"+zo+Lo+")*",lf="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",pf="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",Uo=zo+Lo+uf,df="(?:"+[of,nn,an].join("|")+")"+Uo,gf="(?:"+[Fo+ks+"?",ks,nn,an,af].join("|")+")",ff=RegExp(sn,"g"),yf=RegExp(ks,"g"),on=RegExp(rn+"(?="+rn+")|"+gf+Uo,"g"),mf=RegExp([Di+"?"+Do+"+"+$o+"(?="+[Ao,Di,"$"].join("|")+")",hf+"+"+jo+"(?="+[Ao,Di+Mo,"$"].join("|")+")",Di+"?"+Mo+"+"+$o,Di+"+"+jo,pf,lf,qo,df].join("|"),"g"),vf=RegExp("["+ko+Fs+Co+To+"]"),wf=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,_f=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],bf=-1,ve={};ve[Vr]=ve[Br]=ve[Jr]=ve[Gr]=ve[Wr]=ve[Qr]=ve[Yr]=ve[Zr]=ve[Xr]=!0,ve[kt]=ve[xt]=ve[cs]=ve[ft]=ve[qi]=ve[Mt]=ve[hi]=ve[Oi]=ve[Ve]=ve[rs]=ve[$t]=ve[ns]=ve[yt]=ve[as]=ve[os]=!1;var ye={};ye[kt]=ye[xt]=ye[cs]=ye[qi]=ye[ft]=ye[Mt]=ye[Vr]=ye[Br]=ye[Jr]=ye[Gr]=ye[Wr]=ye[Ve]=ye[rs]=ye[$t]=ye[ns]=ye[yt]=ye[as]=ye[Ds]=ye[Qr]=ye[Yr]=ye[Zr]=ye[Xr]=!0,ye[hi]=ye[Oi]=ye[os]=!1;var Ef={\u00C0:"A",\u00C1:"A",\u00C2:"A",\u00C3:"A",\u00C4:"A",\u00C5:"A",\u00E0:"a",\u00E1:"a",\u00E2:"a",\u00E3:"a",\u00E4:"a",\u00E5:"a",\u00C7:"C",\u00E7:"c",\u00D0:"D",\u00F0:"d",\u00C8:"E",\u00C9:"E",\u00CA:"E",\u00CB:"E",\u00E8:"e",\u00E9:"e",\u00EA:"e",\u00EB:"e",\u00CC:"I",\u00CD:"I",\u00CE:"I",\u00CF:"I",\u00EC:"i",\u00ED:"i",\u00EE:"i",\u00EF:"i",\u00D1:"N",\u00F1:"n",\u00D2:"O",\u00D3:"O",\u00D4:"O",\u00D5:"O",\u00D6:"O",\u00D8:"O",\u00F2:"o",\u00F3:"o",\u00F4:"o",\u00F5:"o",\u00F6:"o",\u00F8:"o",\u00D9:"U",\u00DA:"U",\u00DB:"U",\u00DC:"U",\u00F9:"u",\u00FA:"u",\u00FB:"u",\u00FC:"u",\u00DD:"Y",\u00FD:"y",\u00FF:"y",\u00C6:"Ae",\u00E6:"ae",\u00DE:"Th",\u00FE:"th",\u00DF:"ss",\u0100:"A",\u0102:"A",\u0104:"A",\u0101:"a",\u0103:"a",\u0105:"a",\u0106:"C",\u0108:"C",\u010A:"C",\u010C:"C",\u0107:"c",\u0109:"c",\u010B:"c",\u010D:"c",\u010E:"D",\u0110:"D",\u010F:"d",\u0111:"d",\u0112:"E",\u0114:"E",\u0116:"E",\u0118:"E",\u011A:"E",\u0113:"e",\u0115:"e",\u0117:"e",\u0119:"e",\u011B:"e",\u011C:"G",\u011E:"G",\u0120:"G",\u0122:"G",\u011D:"g",\u011F:"g",\u0121:"g",\u0123:"g",\u0124:"H",\u0126:"H",\u0125:"h",\u0127:"h",\u0128:"I",\u012A:"I",\u012C:"I",\u012E:"I",\u0130:"I",\u0129:"i",\u012B:"i",\u012D:"i",\u012F:"i",\u0131:"i",\u0134:"J",\u0135:"j",\u0136:"K",\u0137:"k",\u0138:"k",\u0139:"L",\u013B:"L",\u013D:"L",\u013F:"L",\u0141:"L",\u013A:"l",\u013C:"l",\u013E:"l",\u0140:"l",\u0142:"l",\u0143:"N",\u0145:"N",\u0147:"N",\u014A:"N",\u0144:"n",\u0146:"n",\u0148:"n",\u014B:"n",\u014C:"O",\u014E:"O",\u0150:"O",\u014D:"o",\u014F:"o",\u0151:"o",\u0154:"R",\u0156:"R",\u0158:"R",\u0155:"r",\u0157:"r",\u0159:"r",\u015A:"S",\u015C:"S",\u015E:"S",\u0160:"S",\u015B:"s",\u015D:"s",\u015F:"s",\u0161:"s",\u0162:"T",\u0164:"T",\u0166:"T",\u0163:"t",\u0165:"t",\u0167:"t",\u0168:"U",\u016A:"U",\u016C:"U",\u016E:"U",\u0170:"U",\u0172:"U",\u0169:"u",\u016B:"u",\u016D:"u",\u016F:"u",\u0171:"u",\u0173:"u",\u0174:"W",\u0175:"w",\u0176:"Y",\u0177:"y",\u0178:"Y",\u0179:"Z",\u017B:"Z",\u017D:"Z",\u017A:"z",\u017C:"z",\u017E:"z",\u0132:"IJ",\u0133:"ij",\u0152:"Oe",\u0153:"oe",\u0149:"'n",\u017F:"s"},If={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Pf={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Cf={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Sf=parseFloat,xf=parseInt,Ho=typeof Xi=="object"&&Xi&&Xi.Object===Object&&Xi,Rf=typeof self=="object"&&self&&self.Object===Object&&self,qe=Ho||Rf||Function("return this")(),cn=r&&!r.nodeType&&r,ui=cn&&!0&&y&&!y.nodeType&&y,Ko=ui&&ui.exports===cn,hn=Ko&&Ho.process,et=function(){try{var b=ui&&ui.require&&ui.require("util").types;return b||hn&&hn.binding&&hn.binding("util")}catch{}}(),Vo=et&&et.isArrayBuffer,Bo=et&&et.isDate,Jo=et&&et.isMap,Go=et&&et.isRegExp,Wo=et&&et.isSet,Qo=et&&et.isTypedArray;function Be(b,C,P){switch(P.length){case 0:return b.call(C);case 1:return b.call(C,P[0]);case 2:return b.call(C,P[0],P[1]);case 3:return b.call(C,P[0],P[1],P[2])}return b.apply(C,P)}function Tf(b,C,P,k){for(var W=-1,ce=b==null?0:b.length;++W<ce;){var xe=b[W];C(k,xe,P(xe),b)}return k}function tt(b,C){for(var P=-1,k=b==null?0:b.length;++P<k&&C(b[P],P,b)!==!1;);return b}function Of(b,C){for(var P=b==null?0:b.length;P--&&C(b[P],P,b)!==!1;);return b}function Yo(b,C){for(var P=-1,k=b==null?0:b.length;++P<k;)if(!C(b[P],P,b))return!1;return!0}function Gt(b,C){for(var P=-1,k=b==null?0:b.length,W=0,ce=[];++P<k;){var xe=b[P];C(xe,P,b)&&(ce[W++]=xe)}return ce}function Ms(b,C){var P=b==null?0:b.length;return!!P&&Ni(b,C,0)>-1}function un(b,C,P){for(var k=-1,W=b==null?0:b.length;++k<W;)if(P(C,b[k]))return!0;return!1}function we(b,C){for(var P=-1,k=b==null?0:b.length,W=Array(k);++P<k;)W[P]=C(b[P],P,b);return W}function Wt(b,C){for(var P=-1,k=C.length,W=b.length;++P<k;)b[W+P]=C[P];return b}function ln(b,C,P,k){var W=-1,ce=b==null?0:b.length;for(k&&ce&&(P=b[++W]);++W<ce;)P=C(P,b[W],W,b);return P}function Af(b,C,P,k){var W=b==null?0:b.length;for(k&&W&&(P=b[--W]);W--;)P=C(P,b[W],W,b);return P}function pn(b,C){for(var P=-1,k=b==null?0:b.length;++P<k;)if(C(b[P],P,b))return!0;return!1}var qf=dn("length");function Df(b){return b.split("")}function Nf(b){return b.match(zg)||[]}function Zo(b,C,P){var k;return P(b,function(W,ce,xe){if(C(W,ce,xe))return k=ce,!1}),k}function $s(b,C,P,k){for(var W=b.length,ce=P+(k?1:-1);k?ce--:++ce<W;)if(C(b[ce],ce,b))return ce;return-1}function Ni(b,C,P){return C===C?Bf(b,C,P):$s(b,Xo,P)}function Ff(b,C,P,k){for(var W=P-1,ce=b.length;++W<ce;)if(k(b[W],C))return W;return-1}function Xo(b){return b!==b}function ec(b,C){var P=b==null?0:b.length;return P?fn(b,C)/P:Nt}function dn(b){return function(C){return C==null?s:C[b]}}function gn(b){return function(C){return b==null?s:b[C]}}function tc(b,C,P,k,W){return W(b,function(ce,xe,ge){P=k?(k=!1,ce):C(P,ce,xe,ge)}),P}function kf(b,C){var P=b.length;for(b.sort(C);P--;)b[P]=b[P].value;return b}function fn(b,C){for(var P,k=-1,W=b.length;++k<W;){var ce=C(b[k]);ce!==s&&(P=P===s?ce:P+ce)}return P}function yn(b,C){for(var P=-1,k=Array(b);++P<b;)k[P]=C(P);return k}function Mf(b,C){return we(C,function(P){return[P,b[P]]})}function ic(b){return b&&b.slice(0,ac(b)+1).replace(tn,"")}function Je(b){return function(C){return b(C)}}function mn(b,C){return we(C,function(P){return b[P]})}function hs(b,C){return b.has(C)}function sc(b,C){for(var P=-1,k=b.length;++P<k&&Ni(C,b[P],0)>-1;);return P}function rc(b,C){for(var P=b.length;P--&&Ni(C,b[P],0)>-1;);return P}function $f(b,C){for(var P=b.length,k=0;P--;)b[P]===C&&++k;return k}var jf=gn(Ef),Lf=gn(If);function zf(b){return"\\"+Cf[b]}function Uf(b,C){return b==null?s:b[C]}function Fi(b){return vf.test(b)}function Hf(b){return wf.test(b)}function Kf(b){for(var C,P=[];!(C=b.next()).done;)P.push(C.value);return P}function vn(b){var C=-1,P=Array(b.size);return b.forEach(function(k,W){P[++C]=[W,k]}),P}function nc(b,C){return function(P){return b(C(P))}}function Qt(b,C){for(var P=-1,k=b.length,W=0,ce=[];++P<k;){var xe=b[P];(xe===C||xe===T)&&(b[P]=T,ce[W++]=P)}return ce}function js(b){var C=-1,P=Array(b.size);return b.forEach(function(k){P[++C]=k}),P}function Vf(b){var C=-1,P=Array(b.size);return b.forEach(function(k){P[++C]=[k,k]}),P}function Bf(b,C,P){for(var k=P-1,W=b.length;++k<W;)if(b[k]===C)return k;return-1}function Jf(b,C,P){for(var k=P+1;k--;)if(b[k]===C)return k;return k}function ki(b){return Fi(b)?Wf(b):qf(b)}function mt(b){return Fi(b)?Qf(b):Df(b)}function ac(b){for(var C=b.length;C--&&Mg.test(b.charAt(C)););return C}var Gf=gn(Pf);function Wf(b){for(var C=on.lastIndex=0;on.test(b);)++C;return C}function Qf(b){return b.match(on)||[]}function Yf(b){return b.match(mf)||[]}var Zf=function b(C){C=C==null?qe:Mi.defaults(qe.Object(),C,Mi.pick(qe,_f));var P=C.Array,k=C.Date,W=C.Error,ce=C.Function,xe=C.Math,ge=C.Object,wn=C.RegExp,Xf=C.String,it=C.TypeError,Ls=P.prototype,ey=ce.prototype,$i=ge.prototype,zs=C["__core-js_shared__"],Us=ey.toString,le=$i.hasOwnProperty,ty=0,oc=function(){var e=/[^.]+$/.exec(zs&&zs.keys&&zs.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),Hs=$i.toString,iy=Us.call(ge),sy=qe._,ry=wn("^"+Us.call(le).replace(en,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ks=Ko?C.Buffer:s,Yt=C.Symbol,Vs=C.Uint8Array,cc=Ks?Ks.allocUnsafe:s,Bs=nc(ge.getPrototypeOf,ge),hc=ge.create,uc=$i.propertyIsEnumerable,Js=Ls.splice,lc=Yt?Yt.isConcatSpreadable:s,us=Yt?Yt.iterator:s,li=Yt?Yt.toStringTag:s,Gs=function(){try{var e=yi(ge,"defineProperty");return e({},"",{}),e}catch{}}(),ny=C.clearTimeout!==qe.clearTimeout&&C.clearTimeout,ay=k&&k.now!==qe.Date.now&&k.now,oy=C.setTimeout!==qe.setTimeout&&C.setTimeout,Ws=xe.ceil,Qs=xe.floor,_n=ge.getOwnPropertySymbols,cy=Ks?Ks.isBuffer:s,pc=C.isFinite,hy=Ls.join,uy=nc(ge.keys,ge),Re=xe.max,Ne=xe.min,ly=k.now,py=C.parseInt,dc=xe.random,dy=Ls.reverse,bn=yi(C,"DataView"),ls=yi(C,"Map"),En=yi(C,"Promise"),ji=yi(C,"Set"),ps=yi(C,"WeakMap"),ds=yi(ge,"create"),Ys=ps&&new ps,Li={},gy=mi(bn),fy=mi(ls),yy=mi(En),my=mi(ji),vy=mi(ps),Zs=Yt?Yt.prototype:s,gs=Zs?Zs.valueOf:s,gc=Zs?Zs.toString:s;function g(e){if(Ie(e)&&!Q(e)&&!(e instanceof ie)){if(e instanceof st)return e;if(le.call(e,"__wrapped__"))return fh(e)}return new st(e)}var zi=function(){function e(){}return function(t){if(!be(t))return{};if(hc)return hc(t);e.prototype=t;var n=new e;return e.prototype=s,n}}();function Xs(){}function st(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=s}g.templateSettings={escape:Ag,evaluate:qg,interpolate:Io,variable:"",imports:{_:g}},g.prototype=Xs.prototype,g.prototype.constructor=g,st.prototype=zi(Xs.prototype),st.prototype.constructor=st;function ie(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Ke,this.__views__=[]}function wy(){var e=new ie(this.__wrapped__);return e.__actions__=Le(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=Le(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=Le(this.__views__),e}function _y(){if(this.__filtered__){var e=new ie(this);e.__dir__=-1,e.__filtered__=!0}else e=this.clone(),e.__dir__*=-1;return e}function by(){var e=this.__wrapped__.value(),t=this.__dir__,n=Q(e),h=t<0,p=n?e.length:0,f=Dm(0,p,this.__views__),v=f.start,w=f.end,E=w-v,S=h?w:v-1,x=this.__iteratees__,R=x.length,D=0,L=Ne(E,this.__takeCount__);if(!n||!h&&p==E&&L==E)return $c(e,this.__actions__);var U=[];e:for(;E--&&D<L;){S+=t;for(var Z=-1,H=e[S];++Z<R;){var ee=x[Z],ne=ee.iteratee,Qe=ee.type,je=ne(H);if(Qe==Dt)H=je;else if(!je){if(Qe==Ri)continue e;break e}}U[D++]=H}return U}ie.prototype=zi(Xs.prototype),ie.prototype.constructor=ie;function pi(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var h=e[t];this.set(h[0],h[1])}}function Ey(){this.__data__=ds?ds(null):{},this.size=0}function Iy(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}function Py(e){var t=this.__data__;if(ds){var n=t[e];return n===_?s:n}return le.call(t,e)?t[e]:s}function Cy(e){var t=this.__data__;return ds?t[e]!==s:le.call(t,e)}function Sy(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=ds&&t===s?_:t,this}pi.prototype.clear=Ey,pi.prototype.delete=Iy,pi.prototype.get=Py,pi.prototype.has=Cy,pi.prototype.set=Sy;function jt(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var h=e[t];this.set(h[0],h[1])}}function xy(){this.__data__=[],this.size=0}function Ry(e){var t=this.__data__,n=er(t,e);if(n<0)return!1;var h=t.length-1;return n==h?t.pop():Js.call(t,n,1),--this.size,!0}function Ty(e){var t=this.__data__,n=er(t,e);return n<0?s:t[n][1]}function Oy(e){return er(this.__data__,e)>-1}function Ay(e,t){var n=this.__data__,h=er(n,e);return h<0?(++this.size,n.push([e,t])):n[h][1]=t,this}jt.prototype.clear=xy,jt.prototype.delete=Ry,jt.prototype.get=Ty,jt.prototype.has=Oy,jt.prototype.set=Ay;function Lt(e){var t=-1,n=e==null?0:e.length;for(this.clear();++t<n;){var h=e[t];this.set(h[0],h[1])}}function qy(){this.size=0,this.__data__={hash:new pi,map:new(ls||jt),string:new pi}}function Dy(e){var t=pr(this,e).delete(e);return this.size-=t?1:0,t}function Ny(e){return pr(this,e).get(e)}function Fy(e){return pr(this,e).has(e)}function ky(e,t){var n=pr(this,e),h=n.size;return n.set(e,t),this.size+=n.size==h?0:1,this}Lt.prototype.clear=qy,Lt.prototype.delete=Dy,Lt.prototype.get=Ny,Lt.prototype.has=Fy,Lt.prototype.set=ky;function di(e){var t=-1,n=e==null?0:e.length;for(this.__data__=new Lt;++t<n;)this.add(e[t])}function My(e){return this.__data__.set(e,_),this}function $y(e){return this.__data__.has(e)}di.prototype.add=di.prototype.push=My,di.prototype.has=$y;function vt(e){var t=this.__data__=new jt(e);this.size=t.size}function jy(){this.__data__=new jt,this.size=0}function Ly(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}function zy(e){return this.__data__.get(e)}function Uy(e){return this.__data__.has(e)}function Hy(e,t){var n=this.__data__;if(n instanceof jt){var h=n.__data__;if(!ls||h.length<o-1)return h.push([e,t]),this.size=++n.size,this;n=this.__data__=new Lt(h)}return n.set(e,t),this.size=n.size,this}vt.prototype.clear=jy,vt.prototype.delete=Ly,vt.prototype.get=zy,vt.prototype.has=Uy,vt.prototype.set=Hy;function fc(e,t){var n=Q(e),h=!n&&vi(e),p=!n&&!h&&ii(e),f=!n&&!h&&!p&&Vi(e),v=n||h||p||f,w=v?yn(e.length,Xf):[],E=w.length;for(var S in e)(t||le.call(e,S))&&!(v&&(S=="length"||p&&(S=="offset"||S=="parent")||f&&(S=="buffer"||S=="byteLength"||S=="byteOffset")||Kt(S,E)))&&w.push(S);return w}function yc(e){var t=e.length;return t?e[Dn(0,t-1)]:s}function Ky(e,t){return dr(Le(e),gi(t,0,e.length))}function Vy(e){return dr(Le(e))}function In(e,t,n){(n!==s&&!wt(e[t],n)||n===s&&!(t in e))&&zt(e,t,n)}function fs(e,t,n){var h=e[t];(!(le.call(e,t)&&wt(h,n))||n===s&&!(t in e))&&zt(e,t,n)}function er(e,t){for(var n=e.length;n--;)if(wt(e[n][0],t))return n;return-1}function By(e,t,n,h){return Zt(e,function(p,f,v){t(h,p,n(p),v)}),h}function mc(e,t){return e&&Tt(t,Oe(t),e)}function Jy(e,t){return e&&Tt(t,Ue(t),e)}function zt(e,t,n){t=="__proto__"&&Gs?Gs(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}function Pn(e,t){for(var n=-1,h=t.length,p=P(h),f=e==null;++n<h;)p[n]=f?s:ra(e,t[n]);return p}function gi(e,t,n){return e===e&&(n!==s&&(e=e<=n?e:n),t!==s&&(e=e>=t?e:t)),e}function rt(e,t,n,h,p,f){var v,w=t&O,E=t&q,S=t&A;if(n&&(v=p?n(e,h,p,f):n(e)),v!==s)return v;if(!be(e))return e;var x=Q(e);if(x){if(v=Fm(e),!w)return Le(e,v)}else{var R=Fe(e),D=R==Oi||R==Ai;if(ii(e))return zc(e,w);if(R==$t||R==kt||D&&!p){if(v=E||D?{}:ah(e),!w)return E?Pm(e,Jy(v,e)):Im(e,mc(v,e))}else{if(!ye[R])return p?e:{};v=km(e,R,w)}}f||(f=new vt);var L=f.get(e);if(L)return L;f.set(e,v),Fh(e)?e.forEach(function(H){v.add(rt(H,t,n,H,e,f))}):Dh(e)&&e.forEach(function(H,ee){v.set(ee,rt(H,t,n,ee,e,f))});var U=S?E?Kn:Hn:E?Ue:Oe,Z=x?s:U(e);return tt(Z||e,function(H,ee){Z&&(ee=H,H=e[ee]),fs(v,ee,rt(H,t,n,ee,e,f))}),v}function Gy(e){var t=Oe(e);return function(n){return vc(n,e,t)}}function vc(e,t,n){var h=n.length;if(e==null)return!h;for(e=ge(e);h--;){var p=n[h],f=t[p],v=e[p];if(v===s&&!(p in e)||!f(v))return!1}return!0}function wc(e,t,n){if(typeof e!="function")throw new it(l);return Es(function(){e.apply(s,n)},t)}function ys(e,t,n,h){var p=-1,f=Ms,v=!0,w=e.length,E=[],S=t.length;if(!w)return E;n&&(t=we(t,Je(n))),h?(f=un,v=!1):t.length>=o&&(f=hs,v=!1,t=new di(t));e:for(;++p<w;){var x=e[p],R=n==null?x:n(x);if(x=h||x!==0?x:0,v&&R===R){for(var D=S;D--;)if(t[D]===R)continue e;E.push(x)}else f(t,R,h)||E.push(x)}return E}var Zt=Bc(Rt),_c=Bc(Sn,!0);function Wy(e,t){var n=!0;return Zt(e,function(h,p,f){return n=!!t(h,p,f),n}),n}function tr(e,t,n){for(var h=-1,p=e.length;++h<p;){var f=e[h],v=t(f);if(v!=null&&(w===s?v===v&&!We(v):n(v,w)))var w=v,E=f}return E}function Qy(e,t,n,h){var p=e.length;for(n=Y(n),n<0&&(n=-n>p?0:p+n),h=h===s||h>p?p:Y(h),h<0&&(h+=p),h=n>h?0:Mh(h);n<h;)e[n++]=t;return e}function bc(e,t){var n=[];return Zt(e,function(h,p,f){t(h,p,f)&&n.push(h)}),n}function De(e,t,n,h,p){var f=-1,v=e.length;for(n||(n=$m),p||(p=[]);++f<v;){var w=e[f];t>0&&n(w)?t>1?De(w,t-1,n,h,p):Wt(p,w):h||(p[p.length]=w)}return p}var Cn=Jc(),Ec=Jc(!0);function Rt(e,t){return e&&Cn(e,t,Oe)}function Sn(e,t){return e&&Ec(e,t,Oe)}function ir(e,t){return Gt(t,function(n){return Vt(e[n])})}function fi(e,t){t=ei(t,e);for(var n=0,h=t.length;e!=null&&n<h;)e=e[Ot(t[n++])];return n&&n==h?e:s}function Ic(e,t,n){var h=t(e);return Q(e)?h:Wt(h,n(e))}function Me(e){return e==null?e===s?Pg:Eg:li&&li in ge(e)?qm(e):Vm(e)}function xn(e,t){return e>t}function Yy(e,t){return e!=null&&le.call(e,t)}function Zy(e,t){return e!=null&&t in ge(e)}function Xy(e,t,n){return e>=Ne(t,n)&&e<Re(t,n)}function Rn(e,t,n){for(var h=n?un:Ms,p=e[0].length,f=e.length,v=f,w=P(f),E=1/0,S=[];v--;){var x=e[v];v&&t&&(x=we(x,Je(t))),E=Ne(x.length,E),w[v]=!n&&(t||p>=120&&x.length>=120)?new di(v&&x):s}x=e[0];var R=-1,D=w[0];e:for(;++R<p&&S.length<E;){var L=x[R],U=t?t(L):L;if(L=n||L!==0?L:0,!(D?hs(D,U):h(S,U,n))){for(v=f;--v;){var Z=w[v];if(!(Z?hs(Z,U):h(e[v],U,n)))continue e}D&&D.push(U),S.push(L)}}return S}function em(e,t,n,h){return Rt(e,function(p,f,v){t(h,n(p),f,v)}),h}function ms(e,t,n){t=ei(t,e),e=uh(e,t);var h=e==null?e:e[Ot(at(t))];return h==null?s:Be(h,e,n)}function Pc(e){return Ie(e)&&Me(e)==kt}function tm(e){return Ie(e)&&Me(e)==cs}function im(e){return Ie(e)&&Me(e)==Mt}function vs(e,t,n,h,p){return e===t?!0:e==null||t==null||!Ie(e)&&!Ie(t)?e!==e&&t!==t:sm(e,t,n,h,vs,p)}function sm(e,t,n,h,p,f){var v=Q(e),w=Q(t),E=v?xt:Fe(e),S=w?xt:Fe(t);E=E==kt?$t:E,S=S==kt?$t:S;var x=E==$t,R=S==$t,D=E==S;if(D&&ii(e)){if(!ii(t))return!1;v=!0,x=!1}if(D&&!x)return f||(f=new vt),v||Vi(e)?sh(e,t,n,h,p,f):Om(e,t,E,n,h,p,f);if(!(n&N)){var L=x&&le.call(e,"__wrapped__"),U=R&&le.call(t,"__wrapped__");if(L||U){var Z=L?e.value():e,H=U?t.value():t;return f||(f=new vt),p(Z,H,n,h,f)}}return D?(f||(f=new vt),Am(e,t,n,h,p,f)):!1}function rm(e){return Ie(e)&&Fe(e)==Ve}function Tn(e,t,n,h){var p=n.length,f=p,v=!h;if(e==null)return!f;for(e=ge(e);p--;){var w=n[p];if(v&&w[2]?w[1]!==e[w[0]]:!(w[0]in e))return!1}for(;++p<f;){w=n[p];var E=w[0],S=e[E],x=w[1];if(v&&w[2]){if(S===s&&!(E in e))return!1}else{var R=new vt;if(h)var D=h(S,x,E,e,t,R);if(!(D===s?vs(x,S,N|j,h,R):D))return!1}}return!0}function Cc(e){if(!be(e)||Lm(e))return!1;var t=Vt(e)?ry:Jg;return t.test(mi(e))}function nm(e){return Ie(e)&&Me(e)==ns}function am(e){return Ie(e)&&Fe(e)==yt}function om(e){return Ie(e)&&wr(e.length)&&!!ve[Me(e)]}function Sc(e){return typeof e=="function"?e:e==null?He:typeof e=="object"?Q(e)?Tc(e[0],e[1]):Rc(e):Gh(e)}function On(e){if(!bs(e))return uy(e);var t=[];for(var n in ge(e))le.call(e,n)&&n!="constructor"&&t.push(n);return t}function cm(e){if(!be(e))return Km(e);var t=bs(e),n=[];for(var h in e)h=="constructor"&&(t||!le.call(e,h))||n.push(h);return n}function An(e,t){return e<t}function xc(e,t){var n=-1,h=ze(e)?P(e.length):[];return Zt(e,function(p,f,v){h[++n]=t(p,f,v)}),h}function Rc(e){var t=Bn(e);return t.length==1&&t[0][2]?ch(t[0][0],t[0][1]):function(n){return n===e||Tn(n,e,t)}}function Tc(e,t){return Gn(e)&&oh(t)?ch(Ot(e),t):function(n){var h=ra(n,e);return h===s&&h===t?na(n,e):vs(t,h,N|j)}}function sr(e,t,n,h,p){e!==t&&Cn(t,function(f,v){if(p||(p=new vt),be(f))hm(e,t,v,n,sr,h,p);else{var w=h?h(Qn(e,v),f,v+"",e,t,p):s;w===s&&(w=f),In(e,v,w)}},Ue)}function hm(e,t,n,h,p,f,v){var w=Qn(e,n),E=Qn(t,n),S=v.get(E);if(S){In(e,n,S);return}var x=f?f(w,E,n+"",e,t,v):s,R=x===s;if(R){var D=Q(E),L=!D&&ii(E),U=!D&&!L&&Vi(E);x=E,D||L||U?Q(w)?x=w:Pe(w)?x=Le(w):L?(R=!1,x=zc(E,!0)):U?(R=!1,x=Uc(E,!0)):x=[]:Is(E)||vi(E)?(x=w,vi(w)?x=$h(w):(!be(w)||Vt(w))&&(x=ah(E))):R=!1}R&&(v.set(E,x),p(x,E,h,f,v),v.delete(E)),In(e,n,x)}function Oc(e,t){var n=e.length;if(n)return t+=t<0?n:0,Kt(t,n)?e[t]:s}function Ac(e,t,n){t.length?t=we(t,function(f){return Q(f)?function(v){return fi(v,f.length===1?f[0]:f)}:f}):t=[He];var h=-1;t=we(t,Je(z()));var p=xc(e,function(f,v,w){var E=we(t,function(S){return S(f)});return{criteria:E,index:++h,value:f}});return kf(p,function(f,v){return Em(f,v,n)})}function um(e,t){return qc(e,t,function(n,h){return na(e,h)})}function qc(e,t,n){for(var h=-1,p=t.length,f={};++h<p;){var v=t[h],w=fi(e,v);n(w,v)&&ws(f,ei(v,e),w)}return f}function lm(e){return function(t){return fi(t,e)}}function qn(e,t,n,h){var p=h?Ff:Ni,f=-1,v=t.length,w=e;for(e===t&&(t=Le(t)),n&&(w=we(e,Je(n)));++f<v;)for(var E=0,S=t[f],x=n?n(S):S;(E=p(w,x,E,h))>-1;)w!==e&&Js.call(w,E,1),Js.call(e,E,1);return e}function Dc(e,t){for(var n=e?t.length:0,h=n-1;n--;){var p=t[n];if(n==h||p!==f){var f=p;Kt(p)?Js.call(e,p,1):kn(e,p)}}return e}function Dn(e,t){return e+Qs(dc()*(t-e+1))}function pm(e,t,n,h){for(var p=-1,f=Re(Ws((t-e)/(n||1)),0),v=P(f);f--;)v[h?f:++p]=e,e+=n;return v}function Nn(e,t){var n="";if(!e||t<1||t>_e)return n;do t%2&&(n+=e),t=Qs(t/2),t&&(e+=e);while(t);return n}function X(e,t){return Yn(hh(e,t,He),e+"")}function dm(e){return yc(Bi(e))}function gm(e,t){var n=Bi(e);return dr(n,gi(t,0,n.length))}function ws(e,t,n,h){if(!be(e))return e;t=ei(t,e);for(var p=-1,f=t.length,v=f-1,w=e;w!=null&&++p<f;){var E=Ot(t[p]),S=n;if(E==="__proto__"||E==="constructor"||E==="prototype")return e;if(p!=v){var x=w[E];S=h?h(x,E,w):s,S===s&&(S=be(x)?x:Kt(t[p+1])?[]:{})}fs(w,E,S),w=w[E]}return e}var Nc=Ys?function(e,t){return Ys.set(e,t),e}:He,fm=Gs?function(e,t){return Gs(e,"toString",{configurable:!0,enumerable:!1,value:oa(t),writable:!0})}:He;function ym(e){return dr(Bi(e))}function nt(e,t,n){var h=-1,p=e.length;t<0&&(t=-t>p?0:p+t),n=n>p?p:n,n<0&&(n+=p),p=t>n?0:n-t>>>0,t>>>=0;for(var f=P(p);++h<p;)f[h]=e[h+t];return f}function mm(e,t){var n;return Zt(e,function(h,p,f){return n=t(h,p,f),!n}),!!n}function rr(e,t,n){var h=0,p=e==null?h:e.length;if(typeof t=="number"&&t===t&&p<=Ft){for(;h<p;){var f=h+p>>>1,v=e[f];v!==null&&!We(v)&&(n?v<=t:v<t)?h=f+1:p=f}return p}return Fn(e,t,He,n)}function Fn(e,t,n,h){var p=0,f=e==null?0:e.length;if(f===0)return 0;t=n(t);for(var v=t!==t,w=t===null,E=We(t),S=t===s;p<f;){var x=Qs((p+f)/2),R=n(e[x]),D=R!==s,L=R===null,U=R===R,Z=We(R);if(v)var H=h||U;else S?H=U&&(h||D):w?H=U&&D&&(h||!L):E?H=U&&D&&!L&&(h||!Z):L||Z?H=!1:H=h?R<=t:R<t;H?p=x+1:f=x}return Ne(f,qs)}function Fc(e,t){for(var n=-1,h=e.length,p=0,f=[];++n<h;){var v=e[n],w=t?t(v):v;if(!n||!wt(w,E)){var E=w;f[p++]=v===0?0:v}}return f}function kc(e){return typeof e=="number"?e:We(e)?Nt:+e}function Ge(e){if(typeof e=="string")return e;if(Q(e))return we(e,Ge)+"";if(We(e))return gc?gc.call(e):"";var t=e+"";return t=="0"&&1/e==-St?"-0":t}function Xt(e,t,n){var h=-1,p=Ms,f=e.length,v=!0,w=[],E=w;if(n)v=!1,p=un;else if(f>=o){var S=t?null:Rm(e);if(S)return js(S);v=!1,p=hs,E=new di}else E=t?[]:w;e:for(;++h<f;){var x=e[h],R=t?t(x):x;if(x=n||x!==0?x:0,v&&R===R){for(var D=E.length;D--;)if(E[D]===R)continue e;t&&E.push(R),w.push(x)}else p(E,R,n)||(E!==w&&E.push(R),w.push(x))}return w}function kn(e,t){return t=ei(t,e),e=uh(e,t),e==null||delete e[Ot(at(t))]}function Mc(e,t,n,h){return ws(e,t,n(fi(e,t)),h)}function nr(e,t,n,h){for(var p=e.length,f=h?p:-1;(h?f--:++f<p)&&t(e[f],f,e););return n?nt(e,h?0:f,h?f+1:p):nt(e,h?f+1:0,h?p:f)}function $c(e,t){var n=e;return n instanceof ie&&(n=n.value()),ln(t,function(h,p){return p.func.apply(p.thisArg,Wt([h],p.args))},n)}function Mn(e,t,n){var h=e.length;if(h<2)return h?Xt(e[0]):[];for(var p=-1,f=P(h);++p<h;)for(var v=e[p],w=-1;++w<h;)w!=p&&(f[p]=ys(f[p]||v,e[w],t,n));return Xt(De(f,1),t,n)}function jc(e,t,n){for(var h=-1,p=e.length,f=t.length,v={};++h<p;){var w=h<f?t[h]:s;n(v,e[h],w)}return v}function $n(e){return Pe(e)?e:[]}function jn(e){return typeof e=="function"?e:He}function ei(e,t){return Q(e)?e:Gn(e,t)?[e]:gh(ue(e))}var vm=X;function ti(e,t,n){var h=e.length;return n=n===s?h:n,!t&&n>=h?e:nt(e,t,n)}var Lc=ny||function(e){return qe.clearTimeout(e)};function zc(e,t){if(t)return e.slice();var n=e.length,h=cc?cc(n):new e.constructor(n);return e.copy(h),h}function Ln(e){var t=new e.constructor(e.byteLength);return new Vs(t).set(new Vs(e)),t}function wm(e,t){var n=t?Ln(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}function _m(e){var t=new e.constructor(e.source,Po.exec(e));return t.lastIndex=e.lastIndex,t}function bm(e){return gs?ge(gs.call(e)):{}}function Uc(e,t){var n=t?Ln(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}function Hc(e,t){if(e!==t){var n=e!==s,h=e===null,p=e===e,f=We(e),v=t!==s,w=t===null,E=t===t,S=We(t);if(!w&&!S&&!f&&e>t||f&&v&&E&&!w&&!S||h&&v&&E||!n&&E||!p)return 1;if(!h&&!f&&!S&&e<t||S&&n&&p&&!h&&!f||w&&n&&p||!v&&p||!E)return-1}return 0}function Em(e,t,n){for(var h=-1,p=e.criteria,f=t.criteria,v=p.length,w=n.length;++h<v;){var E=Hc(p[h],f[h]);if(E){if(h>=w)return E;var S=n[h];return E*(S=="desc"?-1:1)}}return e.index-t.index}function Kc(e,t,n,h){for(var p=-1,f=e.length,v=n.length,w=-1,E=t.length,S=Re(f-v,0),x=P(E+S),R=!h;++w<E;)x[w]=t[w];for(;++p<v;)(R||p<f)&&(x[n[p]]=e[p]);for(;S--;)x[w++]=e[p++];return x}function Vc(e,t,n,h){for(var p=-1,f=e.length,v=-1,w=n.length,E=-1,S=t.length,x=Re(f-w,0),R=P(x+S),D=!h;++p<x;)R[p]=e[p];for(var L=p;++E<S;)R[L+E]=t[E];for(;++v<w;)(D||p<f)&&(R[L+n[v]]=e[p++]);return R}function Le(e,t){var n=-1,h=e.length;for(t||(t=P(h));++n<h;)t[n]=e[n];return t}function Tt(e,t,n,h){var p=!n;n||(n={});for(var f=-1,v=t.length;++f<v;){var w=t[f],E=h?h(n[w],e[w],w,n,e):s;E===s&&(E=e[w]),p?zt(n,w,E):fs(n,w,E)}return n}function Im(e,t){return Tt(e,Jn(e),t)}function Pm(e,t){return Tt(e,rh(e),t)}function ar(e,t){return function(n,h){var p=Q(n)?Tf:By,f=t?t():{};return p(n,e,z(h,2),f)}}function Ui(e){return X(function(t,n){var h=-1,p=n.length,f=p>1?n[p-1]:s,v=p>2?n[2]:s;for(f=e.length>3&&typeof f=="function"?(p--,f):s,v&&$e(n[0],n[1],v)&&(f=p<3?s:f,p=1),t=ge(t);++h<p;){var w=n[h];w&&e(t,w,h,f)}return t})}function Bc(e,t){return function(n,h){if(n==null)return n;if(!ze(n))return e(n,h);for(var p=n.length,f=t?p:-1,v=ge(n);(t?f--:++f<p)&&h(v[f],f,v)!==!1;);return n}}function Jc(e){return function(t,n,h){for(var p=-1,f=ge(t),v=h(t),w=v.length;w--;){var E=v[e?w:++p];if(n(f[E],E,f)===!1)break}return t}}function Cm(e,t,n){var h=t&M,p=_s(e);function f(){var v=this&&this!==qe&&this instanceof f?p:e;return v.apply(h?n:this,arguments)}return f}function Gc(e){return function(t){t=ue(t);var n=Fi(t)?mt(t):s,h=n?n[0]:t.charAt(0),p=n?ti(n,1).join(""):t.slice(1);return h[e]()+p}}function Hi(e){return function(t){return ln(Bh(Vh(t).replace(ff,"")),e,"")}}function _s(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var n=zi(e.prototype),h=e.apply(n,t);return be(h)?h:n}}function Sm(e,t,n){var h=_s(e);function p(){for(var f=arguments.length,v=P(f),w=f,E=Ki(p);w--;)v[w]=arguments[w];var S=f<3&&v[0]!==E&&v[f-1]!==E?[]:Qt(v,E);if(f-=S.length,f<n)return Xc(e,t,or,p.placeholder,s,v,S,s,s,n-f);var x=this&&this!==qe&&this instanceof p?h:e;return Be(x,this,v)}return p}function Wc(e){return function(t,n,h){var p=ge(t);if(!ze(t)){var f=z(n,3);t=Oe(t),n=function(w){return f(p[w],w,p)}}var v=e(t,n,h);return v>-1?p[f?t[v]:v]:s}}function Qc(e){return Ht(function(t){var n=t.length,h=n,p=st.prototype.thru;for(e&&t.reverse();h--;){var f=t[h];if(typeof f!="function")throw new it(l);if(p&&!v&&lr(f)=="wrapper")var v=new st([],!0)}for(h=v?h:n;++h<n;){f=t[h];var w=lr(f),E=w=="wrapper"?Vn(f):s;E&&Wn(E[0])&&E[1]==(de|ae|J|oe)&&!E[4].length&&E[9]==1?v=v[lr(E[0])].apply(v,E[3]):v=f.length==1&&Wn(f)?v[w]():v.thru(f)}return function(){var S=arguments,x=S[0];if(v&&S.length==1&&Q(x))return v.plant(x).value();for(var R=0,D=n?t[R].apply(this,S):x;++R<n;)D=t[R].call(this,D);return D}})}function or(e,t,n,h,p,f,v,w,E,S){var x=t&de,R=t&M,D=t&$,L=t&(ae|B),U=t&gt,Z=D?s:_s(e);function H(){for(var ee=arguments.length,ne=P(ee),Qe=ee;Qe--;)ne[Qe]=arguments[Qe];if(L)var je=Ki(H),Ye=$f(ne,je);if(h&&(ne=Kc(ne,h,p,L)),f&&(ne=Vc(ne,f,v,L)),ee-=Ye,L&&ee<S){var Ce=Qt(ne,je);return Xc(e,t,or,H.placeholder,n,ne,Ce,w,E,S-ee)}var _t=R?n:this,Jt=D?_t[e]:e;return ee=ne.length,w?ne=Bm(ne,w):U&&ee>1&&ne.reverse(),x&&E<ee&&(ne.length=E),this&&this!==qe&&this instanceof H&&(Jt=Z||_s(Jt)),Jt.apply(_t,ne)}return H}function Yc(e,t){return function(n,h){return em(n,e,t(h),{})}}function cr(e,t){return function(n,h){var p;if(n===s&&h===s)return t;if(n!==s&&(p=n),h!==s){if(p===s)return h;typeof n=="string"||typeof h=="string"?(n=Ge(n),h=Ge(h)):(n=kc(n),h=kc(h)),p=e(n,h)}return p}}function zn(e){return Ht(function(t){return t=we(t,Je(z())),X(function(n){var h=this;return e(t,function(p){return Be(p,h,n)})})})}function hr(e,t){t=t===s?" ":Ge(t);var n=t.length;if(n<2)return n?Nn(t,e):t;var h=Nn(t,Ws(e/ki(t)));return Fi(t)?ti(mt(h),0,e).join(""):h.slice(0,e)}function xm(e,t,n,h){var p=t&M,f=_s(e);function v(){for(var w=-1,E=arguments.length,S=-1,x=h.length,R=P(x+E),D=this&&this!==qe&&this instanceof v?f:e;++S<x;)R[S]=h[S];for(;E--;)R[S++]=arguments[++w];return Be(D,p?n:this,R)}return v}function Zc(e){return function(t,n,h){return h&&typeof h!="number"&&$e(t,n,h)&&(n=h=s),t=Bt(t),n===s?(n=t,t=0):n=Bt(n),h=h===s?t<n?1:-1:Bt(h),pm(t,n,h,e)}}function ur(e){return function(t,n){return typeof t=="string"&&typeof n=="string"||(t=ot(t),n=ot(n)),e(t,n)}}function Xc(e,t,n,h,p,f,v,w,E,S){var x=t&ae,R=x?v:s,D=x?s:v,L=x?f:s,U=x?s:f;t|=x?J:fe,t&=~(x?fe:J),t&G||(t&=~(M|$));var Z=[e,t,p,L,R,U,D,w,E,S],H=n.apply(s,Z);return Wn(e)&&lh(H,Z),H.placeholder=h,ph(H,e,t)}function Un(e){var t=xe[e];return function(n,h){if(n=ot(n),h=h==null?0:Ne(Y(h),292),h&&pc(n)){var p=(ue(n)+"e").split("e"),f=t(p[0]+"e"+(+p[1]+h));return p=(ue(f)+"e").split("e"),+(p[0]+"e"+(+p[1]-h))}return t(n)}}var Rm=ji&&1/js(new ji([,-0]))[1]==St?function(e){return new ji(e)}:ua;function eh(e){return function(t){var n=Fe(t);return n==Ve?vn(t):n==yt?Vf(t):Mf(t,e(t))}}function Ut(e,t,n,h,p,f,v,w){var E=t&$;if(!E&&typeof e!="function")throw new it(l);var S=h?h.length:0;if(S||(t&=~(J|fe),h=p=s),v=v===s?v:Re(Y(v),0),w=w===s?w:Y(w),S-=p?p.length:0,t&fe){var x=h,R=p;h=p=s}var D=E?s:Vn(e),L=[e,t,n,h,p,x,R,f,v,w];if(D&&Hm(L,D),e=L[0],t=L[1],n=L[2],h=L[3],p=L[4],w=L[9]=L[9]===s?E?0:e.length:Re(L[9]-S,0),!w&&t&(ae|B)&&(t&=~(ae|B)),!t||t==M)var U=Cm(e,t,n);else t==ae||t==B?U=Sm(e,t,w):(t==J||t==(M|J))&&!p.length?U=xm(e,t,n,h):U=or.apply(s,L);var Z=D?Nc:lh;return ph(Z(U,L),e,t)}function th(e,t,n,h){return e===s||wt(e,$i[n])&&!le.call(h,n)?t:e}function ih(e,t,n,h,p,f){return be(e)&&be(t)&&(f.set(t,e),sr(e,t,s,ih,f),f.delete(t)),e}function Tm(e){return Is(e)?s:e}function sh(e,t,n,h,p,f){var v=n&N,w=e.length,E=t.length;if(w!=E&&!(v&&E>w))return!1;var S=f.get(e),x=f.get(t);if(S&&x)return S==t&&x==e;var R=-1,D=!0,L=n&j?new di:s;for(f.set(e,t),f.set(t,e);++R<w;){var U=e[R],Z=t[R];if(h)var H=v?h(Z,U,R,t,e,f):h(U,Z,R,e,t,f);if(H!==s){if(H)continue;D=!1;break}if(L){if(!pn(t,function(ee,ne){if(!hs(L,ne)&&(U===ee||p(U,ee,n,h,f)))return L.push(ne)})){D=!1;break}}else if(!(U===Z||p(U,Z,n,h,f))){D=!1;break}}return f.delete(e),f.delete(t),D}function Om(e,t,n,h,p,f,v){switch(n){case qi:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case cs:return!(e.byteLength!=t.byteLength||!f(new Vs(e),new Vs(t)));case ft:case Mt:case rs:return wt(+e,+t);case hi:return e.name==t.name&&e.message==t.message;case ns:case as:return e==t+"";case Ve:var w=vn;case yt:var E=h&N;if(w||(w=js),e.size!=t.size&&!E)return!1;var S=v.get(e);if(S)return S==t;h|=j,v.set(e,t);var x=sh(w(e),w(t),h,p,f,v);return v.delete(e),x;case Ds:if(gs)return gs.call(e)==gs.call(t)}return!1}function Am(e,t,n,h,p,f){var v=n&N,w=Hn(e),E=w.length,S=Hn(t),x=S.length;if(E!=x&&!v)return!1;for(var R=E;R--;){var D=w[R];if(!(v?D in t:le.call(t,D)))return!1}var L=f.get(e),U=f.get(t);if(L&&U)return L==t&&U==e;var Z=!0;f.set(e,t),f.set(t,e);for(var H=v;++R<E;){D=w[R];var ee=e[D],ne=t[D];if(h)var Qe=v?h(ne,ee,D,t,e,f):h(ee,ne,D,e,t,f);if(!(Qe===s?ee===ne||p(ee,ne,n,h,f):Qe)){Z=!1;break}H||(H=D=="constructor")}if(Z&&!H){var je=e.constructor,Ye=t.constructor;je!=Ye&&"constructor"in e&&"constructor"in t&&!(typeof je=="function"&&je instanceof je&&typeof Ye=="function"&&Ye instanceof Ye)&&(Z=!1)}return f.delete(e),f.delete(t),Z}function Ht(e){return Yn(hh(e,s,vh),e+"")}function Hn(e){return Ic(e,Oe,Jn)}function Kn(e){return Ic(e,Ue,rh)}var Vn=Ys?function(e){return Ys.get(e)}:ua;function lr(e){for(var t=e.name+"",n=Li[t],h=le.call(Li,t)?n.length:0;h--;){var p=n[h],f=p.func;if(f==null||f==e)return p.name}return t}function Ki(e){var t=le.call(g,"placeholder")?g:e;return t.placeholder}function z(){var e=g.iteratee||ca;return e=e===ca?Sc:e,arguments.length?e(arguments[0],arguments[1]):e}function pr(e,t){var n=e.__data__;return jm(t)?n[typeof t=="string"?"string":"hash"]:n.map}function Bn(e){for(var t=Oe(e),n=t.length;n--;){var h=t[n],p=e[h];t[n]=[h,p,oh(p)]}return t}function yi(e,t){var n=Uf(e,t);return Cc(n)?n:s}function qm(e){var t=le.call(e,li),n=e[li];try{e[li]=s;var h=!0}catch{}var p=Hs.call(e);return h&&(t?e[li]=n:delete e[li]),p}var Jn=_n?function(e){return e==null?[]:(e=ge(e),Gt(_n(e),function(t){return uc.call(e,t)}))}:la,rh=_n?function(e){for(var t=[];e;)Wt(t,Jn(e)),e=Bs(e);return t}:la,Fe=Me;(bn&&Fe(new bn(new ArrayBuffer(1)))!=qi||ls&&Fe(new ls)!=Ve||En&&Fe(En.resolve())!=_o||ji&&Fe(new ji)!=yt||ps&&Fe(new ps)!=os)&&(Fe=function(e){var t=Me(e),n=t==$t?e.constructor:s,h=n?mi(n):"";if(h)switch(h){case gy:return qi;case fy:return Ve;case yy:return _o;case my:return yt;case vy:return os}return t});function Dm(e,t,n){for(var h=-1,p=n.length;++h<p;){var f=n[h],v=f.size;switch(f.type){case"drop":e+=v;break;case"dropRight":t-=v;break;case"take":t=Ne(t,e+v);break;case"takeRight":e=Re(e,t-v);break}}return{start:e,end:t}}function Nm(e){var t=e.match(jg);return t?t[1].split(Lg):[]}function nh(e,t,n){t=ei(t,e);for(var h=-1,p=t.length,f=!1;++h<p;){var v=Ot(t[h]);if(!(f=e!=null&&n(e,v)))break;e=e[v]}return f||++h!=p?f:(p=e==null?0:e.length,!!p&&wr(p)&&Kt(v,p)&&(Q(e)||vi(e)))}function Fm(e){var t=e.length,n=new e.constructor(t);return t&&typeof e[0]=="string"&&le.call(e,"index")&&(n.index=e.index,n.input=e.input),n}function ah(e){return typeof e.constructor=="function"&&!bs(e)?zi(Bs(e)):{}}function km(e,t,n){var h=e.constructor;switch(t){case cs:return Ln(e);case ft:case Mt:return new h(+e);case qi:return wm(e,n);case Vr:case Br:case Jr:case Gr:case Wr:case Qr:case Yr:case Zr:case Xr:return Uc(e,n);case Ve:return new h;case rs:case as:return new h(e);case ns:return _m(e);case yt:return new h;case Ds:return bm(e)}}function Mm(e,t){var n=t.length;if(!n)return e;var h=n-1;return t[h]=(n>1?"& ":"")+t[h],t=t.join(n>2?", ":" "),e.replace($g,`{
/* [wrapped with `+t+`] */
`)}function $m(e){return Q(e)||vi(e)||!!(lc&&e&&e[lc])}function Kt(e,t){var n=typeof e;return t=t??_e,!!t&&(n=="number"||n!="symbol"&&Wg.test(e))&&e>-1&&e%1==0&&e<t}function $e(e,t,n){if(!be(n))return!1;var h=typeof t;return(h=="number"?ze(n)&&Kt(t,n.length):h=="string"&&t in n)?wt(n[t],e):!1}function Gn(e,t){if(Q(e))return!1;var n=typeof e;return n=="number"||n=="symbol"||n=="boolean"||e==null||We(e)?!0:Ng.test(e)||!Dg.test(e)||t!=null&&e in ge(t)}function jm(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}function Wn(e){var t=lr(e),n=g[t];if(typeof n!="function"||!(t in ie.prototype))return!1;if(e===n)return!0;var h=Vn(n);return!!h&&e===h[0]}function Lm(e){return!!oc&&oc in e}var zm=zs?Vt:pa;function bs(e){var t=e&&e.constructor,n=typeof t=="function"&&t.prototype||$i;return e===n}function oh(e){return e===e&&!be(e)}function ch(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==s||e in ge(n))}}function Um(e){var t=mr(e,function(h){return n.size===I&&n.clear(),h}),n=t.cache;return t}function Hm(e,t){var n=e[1],h=t[1],p=n|h,f=p<(M|$|de),v=h==de&&n==ae||h==de&&n==oe&&e[7].length<=t[8]||h==(de|oe)&&t[7].length<=t[8]&&n==ae;if(!(f||v))return e;h&M&&(e[2]=t[2],p|=n&M?0:G);var w=t[3];if(w){var E=e[3];e[3]=E?Kc(E,w,t[4]):w,e[4]=E?Qt(e[3],T):t[4]}return w=t[5],w&&(E=e[5],e[5]=E?Vc(E,w,t[6]):w,e[6]=E?Qt(e[5],T):t[6]),w=t[7],w&&(e[7]=w),h&de&&(e[8]=e[8]==null?t[8]:Ne(e[8],t[8])),e[9]==null&&(e[9]=t[9]),e[0]=t[0],e[1]=p,e}function Km(e){var t=[];if(e!=null)for(var n in ge(e))t.push(n);return t}function Vm(e){return Hs.call(e)}function hh(e,t,n){return t=Re(t===s?e.length-1:t,0),function(){for(var h=arguments,p=-1,f=Re(h.length-t,0),v=P(f);++p<f;)v[p]=h[t+p];p=-1;for(var w=P(t+1);++p<t;)w[p]=h[p];return w[t]=n(v),Be(e,this,w)}}function uh(e,t){return t.length<2?e:fi(e,nt(t,0,-1))}function Bm(e,t){for(var n=e.length,h=Ne(t.length,n),p=Le(e);h--;){var f=t[h];e[h]=Kt(f,n)?p[f]:s}return e}function Qn(e,t){if(!(t==="constructor"&&typeof e[t]=="function")&&t!="__proto__")return e[t]}var lh=dh(Nc),Es=oy||function(e,t){return qe.setTimeout(e,t)},Yn=dh(fm);function ph(e,t,n){var h=t+"";return Yn(e,Mm(h,Jm(Nm(h),n)))}function dh(e){var t=0,n=0;return function(){var h=ly(),p=xi-(h-n);if(n=h,p>0){if(++t>=es)return arguments[0]}else t=0;return e.apply(s,arguments)}}function dr(e,t){var n=-1,h=e.length,p=h-1;for(t=t===s?h:t;++n<t;){var f=Dn(n,p),v=e[f];e[f]=e[n],e[n]=v}return e.length=t,e}var gh=Um(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(Fg,function(n,h,p,f){t.push(p?f.replace(Hg,"$1"):h||n)}),t});function Ot(e){if(typeof e=="string"||We(e))return e;var t=e+"";return t=="0"&&1/e==-St?"-0":t}function mi(e){if(e!=null){try{return Us.call(e)}catch{}try{return e+""}catch{}}return""}function Jm(e,t){return tt(is,function(n){var h="_."+n[0];t&n[1]&&!Ms(e,h)&&e.push(h)}),e.sort()}function fh(e){if(e instanceof ie)return e.clone();var t=new st(e.__wrapped__,e.__chain__);return t.__actions__=Le(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}function Gm(e,t,n){(n?$e(e,t,n):t===s)?t=1:t=Re(Y(t),0);var h=e==null?0:e.length;if(!h||t<1)return[];for(var p=0,f=0,v=P(Ws(h/t));p<h;)v[f++]=nt(e,p,p+=t);return v}function Wm(e){for(var t=-1,n=e==null?0:e.length,h=0,p=[];++t<n;){var f=e[t];f&&(p[h++]=f)}return p}function Qm(){var e=arguments.length;if(!e)return[];for(var t=P(e-1),n=arguments[0],h=e;h--;)t[h-1]=arguments[h];return Wt(Q(n)?Le(n):[n],De(t,1))}var Ym=X(function(e,t){return Pe(e)?ys(e,De(t,1,Pe,!0)):[]}),Zm=X(function(e,t){var n=at(t);return Pe(n)&&(n=s),Pe(e)?ys(e,De(t,1,Pe,!0),z(n,2)):[]}),Xm=X(function(e,t){var n=at(t);return Pe(n)&&(n=s),Pe(e)?ys(e,De(t,1,Pe,!0),s,n):[]});function ev(e,t,n){var h=e==null?0:e.length;return h?(t=n||t===s?1:Y(t),nt(e,t<0?0:t,h)):[]}function tv(e,t,n){var h=e==null?0:e.length;return h?(t=n||t===s?1:Y(t),t=h-t,nt(e,0,t<0?0:t)):[]}function iv(e,t){return e&&e.length?nr(e,z(t,3),!0,!0):[]}function sv(e,t){return e&&e.length?nr(e,z(t,3),!0):[]}function rv(e,t,n,h){var p=e==null?0:e.length;return p?(n&&typeof n!="number"&&$e(e,t,n)&&(n=0,h=p),Qy(e,t,n,h)):[]}function yh(e,t,n){var h=e==null?0:e.length;if(!h)return-1;var p=n==null?0:Y(n);return p<0&&(p=Re(h+p,0)),$s(e,z(t,3),p)}function mh(e,t,n){var h=e==null?0:e.length;if(!h)return-1;var p=h-1;return n!==s&&(p=Y(n),p=n<0?Re(h+p,0):Ne(p,h-1)),$s(e,z(t,3),p,!0)}function vh(e){var t=e==null?0:e.length;return t?De(e,1):[]}function nv(e){var t=e==null?0:e.length;return t?De(e,St):[]}function av(e,t){var n=e==null?0:e.length;return n?(t=t===s?1:Y(t),De(e,t)):[]}function ov(e){for(var t=-1,n=e==null?0:e.length,h={};++t<n;){var p=e[t];h[p[0]]=p[1]}return h}function wh(e){return e&&e.length?e[0]:s}function cv(e,t,n){var h=e==null?0:e.length;if(!h)return-1;var p=n==null?0:Y(n);return p<0&&(p=Re(h+p,0)),Ni(e,t,p)}function hv(e){var t=e==null?0:e.length;return t?nt(e,0,-1):[]}var uv=X(function(e){var t=we(e,$n);return t.length&&t[0]===e[0]?Rn(t):[]}),lv=X(function(e){var t=at(e),n=we(e,$n);return t===at(n)?t=s:n.pop(),n.length&&n[0]===e[0]?Rn(n,z(t,2)):[]}),pv=X(function(e){var t=at(e),n=we(e,$n);return t=typeof t=="function"?t:s,t&&n.pop(),n.length&&n[0]===e[0]?Rn(n,s,t):[]});function dv(e,t){return e==null?"":hy.call(e,t)}function at(e){var t=e==null?0:e.length;return t?e[t-1]:s}function gv(e,t,n){var h=e==null?0:e.length;if(!h)return-1;var p=h;return n!==s&&(p=Y(n),p=p<0?Re(h+p,0):Ne(p,h-1)),t===t?Jf(e,t,p):$s(e,Xo,p,!0)}function fv(e,t){return e&&e.length?Oc(e,Y(t)):s}var yv=X(_h);function _h(e,t){return e&&e.length&&t&&t.length?qn(e,t):e}function mv(e,t,n){return e&&e.length&&t&&t.length?qn(e,t,z(n,2)):e}function vv(e,t,n){return e&&e.length&&t&&t.length?qn(e,t,s,n):e}var wv=Ht(function(e,t){var n=e==null?0:e.length,h=Pn(e,t);return Dc(e,we(t,function(p){return Kt(p,n)?+p:p}).sort(Hc)),h});function _v(e,t){var n=[];if(!(e&&e.length))return n;var h=-1,p=[],f=e.length;for(t=z(t,3);++h<f;){var v=e[h];t(v,h,e)&&(n.push(v),p.push(h))}return Dc(e,p),n}function Zn(e){return e==null?e:dy.call(e)}function bv(e,t,n){var h=e==null?0:e.length;return h?(n&&typeof n!="number"&&$e(e,t,n)?(t=0,n=h):(t=t==null?0:Y(t),n=n===s?h:Y(n)),nt(e,t,n)):[]}function Ev(e,t){return rr(e,t)}function Iv(e,t,n){return Fn(e,t,z(n,2))}function Pv(e,t){var n=e==null?0:e.length;if(n){var h=rr(e,t);if(h<n&&wt(e[h],t))return h}return-1}function Cv(e,t){return rr(e,t,!0)}function Sv(e,t,n){return Fn(e,t,z(n,2),!0)}function xv(e,t){var n=e==null?0:e.length;if(n){var h=rr(e,t,!0)-1;if(wt(e[h],t))return h}return-1}function Rv(e){return e&&e.length?Fc(e):[]}function Tv(e,t){return e&&e.length?Fc(e,z(t,2)):[]}function Ov(e){var t=e==null?0:e.length;return t?nt(e,1,t):[]}function Av(e,t,n){return e&&e.length?(t=n||t===s?1:Y(t),nt(e,0,t<0?0:t)):[]}function qv(e,t,n){var h=e==null?0:e.length;return h?(t=n||t===s?1:Y(t),t=h-t,nt(e,t<0?0:t,h)):[]}function Dv(e,t){return e&&e.length?nr(e,z(t,3),!1,!0):[]}function Nv(e,t){return e&&e.length?nr(e,z(t,3)):[]}var Fv=X(function(e){return Xt(De(e,1,Pe,!0))}),kv=X(function(e){var t=at(e);return Pe(t)&&(t=s),Xt(De(e,1,Pe,!0),z(t,2))}),Mv=X(function(e){var t=at(e);return t=typeof t=="function"?t:s,Xt(De(e,1,Pe,!0),s,t)});function $v(e){return e&&e.length?Xt(e):[]}function jv(e,t){return e&&e.length?Xt(e,z(t,2)):[]}function Lv(e,t){return t=typeof t=="function"?t:s,e&&e.length?Xt(e,s,t):[]}function Xn(e){if(!(e&&e.length))return[];var t=0;return e=Gt(e,function(n){if(Pe(n))return t=Re(n.length,t),!0}),yn(t,function(n){return we(e,dn(n))})}function bh(e,t){if(!(e&&e.length))return[];var n=Xn(e);return t==null?n:we(n,function(h){return Be(t,s,h)})}var zv=X(function(e,t){return Pe(e)?ys(e,t):[]}),Uv=X(function(e){return Mn(Gt(e,Pe))}),Hv=X(function(e){var t=at(e);return Pe(t)&&(t=s),Mn(Gt(e,Pe),z(t,2))}),Kv=X(function(e){var t=at(e);return t=typeof t=="function"?t:s,Mn(Gt(e,Pe),s,t)}),Vv=X(Xn);function Bv(e,t){return jc(e||[],t||[],fs)}function Jv(e,t){return jc(e||[],t||[],ws)}var Gv=X(function(e){var t=e.length,n=t>1?e[t-1]:s;return n=typeof n=="function"?(e.pop(),n):s,bh(e,n)});function Eh(e){var t=g(e);return t.__chain__=!0,t}function Wv(e,t){return t(e),e}function gr(e,t){return t(e)}var Qv=Ht(function(e){var t=e.length,n=t?e[0]:0,h=this.__wrapped__,p=function(f){return Pn(f,e)};return t>1||this.__actions__.length||!(h instanceof ie)||!Kt(n)?this.thru(p):(h=h.slice(n,+n+(t?1:0)),h.__actions__.push({func:gr,args:[p],thisArg:s}),new st(h,this.__chain__).thru(function(f){return t&&!f.length&&f.push(s),f}))});function Yv(){return Eh(this)}function Zv(){return new st(this.value(),this.__chain__)}function Xv(){this.__values__===s&&(this.__values__=kh(this.value()));var e=this.__index__>=this.__values__.length,t=e?s:this.__values__[this.__index__++];return{done:e,value:t}}function e0(){return this}function t0(e){for(var t,n=this;n instanceof Xs;){var h=fh(n);h.__index__=0,h.__values__=s,t?p.__wrapped__=h:t=h;var p=h;n=n.__wrapped__}return p.__wrapped__=e,t}function i0(){var e=this.__wrapped__;if(e instanceof ie){var t=e;return this.__actions__.length&&(t=new ie(this)),t=t.reverse(),t.__actions__.push({func:gr,args:[Zn],thisArg:s}),new st(t,this.__chain__)}return this.thru(Zn)}function s0(){return $c(this.__wrapped__,this.__actions__)}var r0=ar(function(e,t,n){le.call(e,n)?++e[n]:zt(e,n,1)});function n0(e,t,n){var h=Q(e)?Yo:Wy;return n&&$e(e,t,n)&&(t=s),h(e,z(t,3))}function a0(e,t){var n=Q(e)?Gt:bc;return n(e,z(t,3))}var o0=Wc(yh),c0=Wc(mh);function h0(e,t){return De(fr(e,t),1)}function u0(e,t){return De(fr(e,t),St)}function l0(e,t,n){return n=n===s?1:Y(n),De(fr(e,t),n)}function Ih(e,t){var n=Q(e)?tt:Zt;return n(e,z(t,3))}function Ph(e,t){var n=Q(e)?Of:_c;return n(e,z(t,3))}var p0=ar(function(e,t,n){le.call(e,n)?e[n].push(t):zt(e,n,[t])});function d0(e,t,n,h){e=ze(e)?e:Bi(e),n=n&&!h?Y(n):0;var p=e.length;return n<0&&(n=Re(p+n,0)),_r(e)?n<=p&&e.indexOf(t,n)>-1:!!p&&Ni(e,t,n)>-1}var g0=X(function(e,t,n){var h=-1,p=typeof t=="function",f=ze(e)?P(e.length):[];return Zt(e,function(v){f[++h]=p?Be(t,v,n):ms(v,t,n)}),f}),f0=ar(function(e,t,n){zt(e,n,t)});function fr(e,t){var n=Q(e)?we:xc;return n(e,z(t,3))}function y0(e,t,n,h){return e==null?[]:(Q(t)||(t=t==null?[]:[t]),n=h?s:n,Q(n)||(n=n==null?[]:[n]),Ac(e,t,n))}var m0=ar(function(e,t,n){e[n?0:1].push(t)},function(){return[[],[]]});function v0(e,t,n){var h=Q(e)?ln:tc,p=arguments.length<3;return h(e,z(t,4),n,p,Zt)}function w0(e,t,n){var h=Q(e)?Af:tc,p=arguments.length<3;return h(e,z(t,4),n,p,_c)}function _0(e,t){var n=Q(e)?Gt:bc;return n(e,vr(z(t,3)))}function b0(e){var t=Q(e)?yc:dm;return t(e)}function E0(e,t,n){(n?$e(e,t,n):t===s)?t=1:t=Y(t);var h=Q(e)?Ky:gm;return h(e,t)}function I0(e){var t=Q(e)?Vy:ym;return t(e)}function P0(e){if(e==null)return 0;if(ze(e))return _r(e)?ki(e):e.length;var t=Fe(e);return t==Ve||t==yt?e.size:On(e).length}function C0(e,t,n){var h=Q(e)?pn:mm;return n&&$e(e,t,n)&&(t=s),h(e,z(t,3))}var S0=X(function(e,t){if(e==null)return[];var n=t.length;return n>1&&$e(e,t[0],t[1])?t=[]:n>2&&$e(t[0],t[1],t[2])&&(t=[t[0]]),Ac(e,De(t,1),[])}),yr=ay||function(){return qe.Date.now()};function x0(e,t){if(typeof t!="function")throw new it(l);return e=Y(e),function(){if(--e<1)return t.apply(this,arguments)}}function Ch(e,t,n){return t=n?s:t,t=e&&t==null?e.length:t,Ut(e,de,s,s,s,s,t)}function Sh(e,t){var n;if(typeof t!="function")throw new it(l);return e=Y(e),function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=s),n}}var ea=X(function(e,t,n){var h=M;if(n.length){var p=Qt(n,Ki(ea));h|=J}return Ut(e,h,t,n,p)}),xh=X(function(e,t,n){var h=M|$;if(n.length){var p=Qt(n,Ki(xh));h|=J}return Ut(t,h,e,n,p)});function Rh(e,t,n){t=n?s:t;var h=Ut(e,ae,s,s,s,s,s,t);return h.placeholder=Rh.placeholder,h}function Th(e,t,n){t=n?s:t;var h=Ut(e,B,s,s,s,s,s,t);return h.placeholder=Th.placeholder,h}function Oh(e,t,n){var h,p,f,v,w,E,S=0,x=!1,R=!1,D=!0;if(typeof e!="function")throw new it(l);t=ot(t)||0,be(n)&&(x=!!n.leading,R="maxWait"in n,f=R?Re(ot(n.maxWait)||0,t):f,D="trailing"in n?!!n.trailing:D);function L(Ce){var _t=h,Jt=p;return h=p=s,S=Ce,v=e.apply(Jt,_t),v}function U(Ce){return S=Ce,w=Es(ee,t),x?L(Ce):v}function Z(Ce){var _t=Ce-E,Jt=Ce-S,Wh=t-_t;return R?Ne(Wh,f-Jt):Wh}function H(Ce){var _t=Ce-E,Jt=Ce-S;return E===s||_t>=t||_t<0||R&&Jt>=f}function ee(){var Ce=yr();if(H(Ce))return ne(Ce);w=Es(ee,Z(Ce))}function ne(Ce){return w=s,D&&h?L(Ce):(h=p=s,v)}function Qe(){w!==s&&Lc(w),S=0,h=E=p=w=s}function je(){return w===s?v:ne(yr())}function Ye(){var Ce=yr(),_t=H(Ce);if(h=arguments,p=this,E=Ce,_t){if(w===s)return U(E);if(R)return Lc(w),w=Es(ee,t),L(E)}return w===s&&(w=Es(ee,t)),v}return Ye.cancel=Qe,Ye.flush=je,Ye}var R0=X(function(e,t){return wc(e,1,t)}),T0=X(function(e,t,n){return wc(e,ot(t)||0,n)});function O0(e){return Ut(e,gt)}function mr(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new it(l);var n=function(){var h=arguments,p=t?t.apply(this,h):h[0],f=n.cache;if(f.has(p))return f.get(p);var v=e.apply(this,h);return n.cache=f.set(p,v)||f,v};return n.cache=new(mr.Cache||Lt),n}mr.Cache=Lt;function vr(e){if(typeof e!="function")throw new it(l);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}function A0(e){return Sh(2,e)}var q0=vm(function(e,t){t=t.length==1&&Q(t[0])?we(t[0],Je(z())):we(De(t,1),Je(z()));var n=t.length;return X(function(h){for(var p=-1,f=Ne(h.length,n);++p<f;)h[p]=t[p].call(this,h[p]);return Be(e,this,h)})}),ta=X(function(e,t){var n=Qt(t,Ki(ta));return Ut(e,J,s,t,n)}),Ah=X(function(e,t){var n=Qt(t,Ki(Ah));return Ut(e,fe,s,t,n)}),D0=Ht(function(e,t){return Ut(e,oe,s,s,s,t)});function N0(e,t){if(typeof e!="function")throw new it(l);return t=t===s?t:Y(t),X(e,t)}function F0(e,t){if(typeof e!="function")throw new it(l);return t=t==null?0:Re(Y(t),0),X(function(n){var h=n[t],p=ti(n,0,t);return h&&Wt(p,h),Be(e,this,p)})}function k0(e,t,n){var h=!0,p=!0;if(typeof e!="function")throw new it(l);return be(n)&&(h="leading"in n?!!n.leading:h,p="trailing"in n?!!n.trailing:p),Oh(e,t,{leading:h,maxWait:t,trailing:p})}function M0(e){return Ch(e,1)}function $0(e,t){return ta(jn(t),e)}function j0(){if(!arguments.length)return[];var e=arguments[0];return Q(e)?e:[e]}function L0(e){return rt(e,A)}function z0(e,t){return t=typeof t=="function"?t:s,rt(e,A,t)}function U0(e){return rt(e,O|A)}function H0(e,t){return t=typeof t=="function"?t:s,rt(e,O|A,t)}function K0(e,t){return t==null||vc(e,t,Oe(t))}function wt(e,t){return e===t||e!==e&&t!==t}var V0=ur(xn),B0=ur(function(e,t){return e>=t}),vi=Pc(function(){return arguments}())?Pc:function(e){return Ie(e)&&le.call(e,"callee")&&!uc.call(e,"callee")},Q=P.isArray,J0=Vo?Je(Vo):tm;function ze(e){return e!=null&&wr(e.length)&&!Vt(e)}function Pe(e){return Ie(e)&&ze(e)}function G0(e){return e===!0||e===!1||Ie(e)&&Me(e)==ft}var ii=cy||pa,W0=Bo?Je(Bo):im;function Q0(e){return Ie(e)&&e.nodeType===1&&!Is(e)}function Y0(e){if(e==null)return!0;if(ze(e)&&(Q(e)||typeof e=="string"||typeof e.splice=="function"||ii(e)||Vi(e)||vi(e)))return!e.length;var t=Fe(e);if(t==Ve||t==yt)return!e.size;if(bs(e))return!On(e).length;for(var n in e)if(le.call(e,n))return!1;return!0}function Z0(e,t){return vs(e,t)}function X0(e,t,n){n=typeof n=="function"?n:s;var h=n?n(e,t):s;return h===s?vs(e,t,s,n):!!h}function ia(e){if(!Ie(e))return!1;var t=Me(e);return t==hi||t==ss||typeof e.message=="string"&&typeof e.name=="string"&&!Is(e)}function ew(e){return typeof e=="number"&&pc(e)}function Vt(e){if(!be(e))return!1;var t=Me(e);return t==Oi||t==Ai||t==Ti||t==Ig}function qh(e){return typeof e=="number"&&e==Y(e)}function wr(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=_e}function be(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}function Ie(e){return e!=null&&typeof e=="object"}var Dh=Jo?Je(Jo):rm;function tw(e,t){return e===t||Tn(e,t,Bn(t))}function iw(e,t,n){return n=typeof n=="function"?n:s,Tn(e,t,Bn(t),n)}function sw(e){return Nh(e)&&e!=+e}function rw(e){if(zm(e))throw new W(u);return Cc(e)}function nw(e){return e===null}function aw(e){return e==null}function Nh(e){return typeof e=="number"||Ie(e)&&Me(e)==rs}function Is(e){if(!Ie(e)||Me(e)!=$t)return!1;var t=Bs(e);if(t===null)return!0;var n=le.call(t,"constructor")&&t.constructor;return typeof n=="function"&&n instanceof n&&Us.call(n)==iy}var sa=Go?Je(Go):nm;function ow(e){return qh(e)&&e>=-_e&&e<=_e}var Fh=Wo?Je(Wo):am;function _r(e){return typeof e=="string"||!Q(e)&&Ie(e)&&Me(e)==as}function We(e){return typeof e=="symbol"||Ie(e)&&Me(e)==Ds}var Vi=Qo?Je(Qo):om;function cw(e){return e===s}function hw(e){return Ie(e)&&Fe(e)==os}function uw(e){return Ie(e)&&Me(e)==Cg}var lw=ur(An),pw=ur(function(e,t){return e<=t});function kh(e){if(!e)return[];if(ze(e))return _r(e)?mt(e):Le(e);if(us&&e[us])return Kf(e[us]());var t=Fe(e),n=t==Ve?vn:t==yt?js:Bi;return n(e)}function Bt(e){if(!e)return e===0?e:0;if(e=ot(e),e===St||e===-St){var t=e<0?-1:1;return t*Se}return e===e?e:0}function Y(e){var t=Bt(e),n=t%1;return t===t?n?t-n:t:0}function Mh(e){return e?gi(Y(e),0,Ke):0}function ot(e){if(typeof e=="number")return e;if(We(e))return Nt;if(be(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=be(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=ic(e);var n=Bg.test(e);return n||Gg.test(e)?xf(e.slice(2),n?2:8):Vg.test(e)?Nt:+e}function $h(e){return Tt(e,Ue(e))}function dw(e){return e?gi(Y(e),-_e,_e):e===0?e:0}function ue(e){return e==null?"":Ge(e)}var gw=Ui(function(e,t){if(bs(t)||ze(t)){Tt(t,Oe(t),e);return}for(var n in t)le.call(t,n)&&fs(e,n,t[n])}),jh=Ui(function(e,t){Tt(t,Ue(t),e)}),br=Ui(function(e,t,n,h){Tt(t,Ue(t),e,h)}),fw=Ui(function(e,t,n,h){Tt(t,Oe(t),e,h)}),yw=Ht(Pn);function mw(e,t){var n=zi(e);return t==null?n:mc(n,t)}var vw=X(function(e,t){e=ge(e);var n=-1,h=t.length,p=h>2?t[2]:s;for(p&&$e(t[0],t[1],p)&&(h=1);++n<h;)for(var f=t[n],v=Ue(f),w=-1,E=v.length;++w<E;){var S=v[w],x=e[S];(x===s||wt(x,$i[S])&&!le.call(e,S))&&(e[S]=f[S])}return e}),ww=X(function(e){return e.push(s,ih),Be(Lh,s,e)});function _w(e,t){return Zo(e,z(t,3),Rt)}function bw(e,t){return Zo(e,z(t,3),Sn)}function Ew(e,t){return e==null?e:Cn(e,z(t,3),Ue)}function Iw(e,t){return e==null?e:Ec(e,z(t,3),Ue)}function Pw(e,t){return e&&Rt(e,z(t,3))}function Cw(e,t){return e&&Sn(e,z(t,3))}function Sw(e){return e==null?[]:ir(e,Oe(e))}function xw(e){return e==null?[]:ir(e,Ue(e))}function ra(e,t,n){var h=e==null?s:fi(e,t);return h===s?n:h}function Rw(e,t){return e!=null&&nh(e,t,Yy)}function na(e,t){return e!=null&&nh(e,t,Zy)}var Tw=Yc(function(e,t,n){t!=null&&typeof t.toString!="function"&&(t=Hs.call(t)),e[t]=n},oa(He)),Ow=Yc(function(e,t,n){t!=null&&typeof t.toString!="function"&&(t=Hs.call(t)),le.call(e,t)?e[t].push(n):e[t]=[n]},z),Aw=X(ms);function Oe(e){return ze(e)?fc(e):On(e)}function Ue(e){return ze(e)?fc(e,!0):cm(e)}function qw(e,t){var n={};return t=z(t,3),Rt(e,function(h,p,f){zt(n,t(h,p,f),h)}),n}function Dw(e,t){var n={};return t=z(t,3),Rt(e,function(h,p,f){zt(n,p,t(h,p,f))}),n}var Nw=Ui(function(e,t,n){sr(e,t,n)}),Lh=Ui(function(e,t,n,h){sr(e,t,n,h)}),Fw=Ht(function(e,t){var n={};if(e==null)return n;var h=!1;t=we(t,function(f){return f=ei(f,e),h||(h=f.length>1),f}),Tt(e,Kn(e),n),h&&(n=rt(n,O|q|A,Tm));for(var p=t.length;p--;)kn(n,t[p]);return n});function kw(e,t){return zh(e,vr(z(t)))}var Mw=Ht(function(e,t){return e==null?{}:um(e,t)});function zh(e,t){if(e==null)return{};var n=we(Kn(e),function(h){return[h]});return t=z(t),qc(e,n,function(h,p){return t(h,p[0])})}function $w(e,t,n){t=ei(t,e);var h=-1,p=t.length;for(p||(p=1,e=s);++h<p;){var f=e==null?s:e[Ot(t[h])];f===s&&(h=p,f=n),e=Vt(f)?f.call(e):f}return e}function jw(e,t,n){return e==null?e:ws(e,t,n)}function Lw(e,t,n,h){return h=typeof h=="function"?h:s,e==null?e:ws(e,t,n,h)}var Uh=eh(Oe),Hh=eh(Ue);function zw(e,t,n){var h=Q(e),p=h||ii(e)||Vi(e);if(t=z(t,4),n==null){var f=e&&e.constructor;p?n=h?new f:[]:be(e)?n=Vt(f)?zi(Bs(e)):{}:n={}}return(p?tt:Rt)(e,function(v,w,E){return t(n,v,w,E)}),n}function Uw(e,t){return e==null?!0:kn(e,t)}function Hw(e,t,n){return e==null?e:Mc(e,t,jn(n))}function Kw(e,t,n,h){return h=typeof h=="function"?h:s,e==null?e:Mc(e,t,jn(n),h)}function Bi(e){return e==null?[]:mn(e,Oe(e))}function Vw(e){return e==null?[]:mn(e,Ue(e))}function Bw(e,t,n){return n===s&&(n=t,t=s),n!==s&&(n=ot(n),n=n===n?n:0),t!==s&&(t=ot(t),t=t===t?t:0),gi(ot(e),t,n)}function Jw(e,t,n){return t=Bt(t),n===s?(n=t,t=0):n=Bt(n),e=ot(e),Xy(e,t,n)}function Gw(e,t,n){if(n&&typeof n!="boolean"&&$e(e,t,n)&&(t=n=s),n===s&&(typeof t=="boolean"?(n=t,t=s):typeof e=="boolean"&&(n=e,e=s)),e===s&&t===s?(e=0,t=1):(e=Bt(e),t===s?(t=e,e=0):t=Bt(t)),e>t){var h=e;e=t,t=h}if(n||e%1||t%1){var p=dc();return Ne(e+p*(t-e+Sf("1e-"+((p+"").length-1))),t)}return Dn(e,t)}var Ww=Hi(function(e,t,n){return t=t.toLowerCase(),e+(n?Kh(t):t)});function Kh(e){return aa(ue(e).toLowerCase())}function Vh(e){return e=ue(e),e&&e.replace(Qg,jf).replace(yf,"")}function Qw(e,t,n){e=ue(e),t=Ge(t);var h=e.length;n=n===s?h:gi(Y(n),0,h);var p=n;return n-=t.length,n>=0&&e.slice(n,p)==t}function Yw(e){return e=ue(e),e&&Og.test(e)?e.replace(Eo,Lf):e}function Zw(e){return e=ue(e),e&&kg.test(e)?e.replace(en,"\\$&"):e}var Xw=Hi(function(e,t,n){return e+(n?"-":"")+t.toLowerCase()}),e_=Hi(function(e,t,n){return e+(n?" ":"")+t.toLowerCase()}),t_=Gc("toLowerCase");function i_(e,t,n){e=ue(e),t=Y(t);var h=t?ki(e):0;if(!t||h>=t)return e;var p=(t-h)/2;return hr(Qs(p),n)+e+hr(Ws(p),n)}function s_(e,t,n){e=ue(e),t=Y(t);var h=t?ki(e):0;return t&&h<t?e+hr(t-h,n):e}function r_(e,t,n){e=ue(e),t=Y(t);var h=t?ki(e):0;return t&&h<t?hr(t-h,n)+e:e}function n_(e,t,n){return n||t==null?t=0:t&&(t=+t),py(ue(e).replace(tn,""),t||0)}function a_(e,t,n){return(n?$e(e,t,n):t===s)?t=1:t=Y(t),Nn(ue(e),t)}function o_(){var e=arguments,t=ue(e[0]);return e.length<3?t:t.replace(e[1],e[2])}var c_=Hi(function(e,t,n){return e+(n?"_":"")+t.toLowerCase()});function h_(e,t,n){return n&&typeof n!="number"&&$e(e,t,n)&&(t=n=s),n=n===s?Ke:n>>>0,n?(e=ue(e),e&&(typeof t=="string"||t!=null&&!sa(t))&&(t=Ge(t),!t&&Fi(e))?ti(mt(e),0,n):e.split(t,n)):[]}var u_=Hi(function(e,t,n){return e+(n?" ":"")+aa(t)});function l_(e,t,n){return e=ue(e),n=n==null?0:gi(Y(n),0,e.length),t=Ge(t),e.slice(n,n+t.length)==t}function p_(e,t,n){var h=g.templateSettings;n&&$e(e,t,n)&&(t=s),e=ue(e),t=br({},t,h,th);var p=br({},t.imports,h.imports,th),f=Oe(p),v=mn(p,f),w,E,S=0,x=t.interpolate||Ns,R="__p += '",D=wn((t.escape||Ns).source+"|"+x.source+"|"+(x===Io?Kg:Ns).source+"|"+(t.evaluate||Ns).source+"|$","g"),L="//# sourceURL="+(le.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++bf+"]")+`
`;e.replace(D,function(H,ee,ne,Qe,je,Ye){return ne||(ne=Qe),R+=e.slice(S,Ye).replace(Yg,zf),ee&&(w=!0,R+=`' +
__e(`+ee+`) +
'`),je&&(E=!0,R+=`';
`+je+`;
__p += '`),ne&&(R+=`' +
((__t = (`+ne+`)) == null ? '' : __t) +
'`),S=Ye+H.length,H}),R+=`';
`;var U=le.call(t,"variable")&&t.variable;if(!U)R=`with (obj) {
`+R+`
}
`;else if(Ug.test(U))throw new W(m);R=(E?R.replace(Sg,""):R).replace(xg,"$1").replace(Rg,"$1;"),R="function("+(U||"obj")+`) {
`+(U?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(w?", __e = _.escape":"")+(E?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+R+`return __p
}`;var Z=Jh(function(){return ce(f,L+"return "+R).apply(s,v)});if(Z.source=R,ia(Z))throw Z;return Z}function d_(e){return ue(e).toLowerCase()}function g_(e){return ue(e).toUpperCase()}function f_(e,t,n){if(e=ue(e),e&&(n||t===s))return ic(e);if(!e||!(t=Ge(t)))return e;var h=mt(e),p=mt(t),f=sc(h,p),v=rc(h,p)+1;return ti(h,f,v).join("")}function y_(e,t,n){if(e=ue(e),e&&(n||t===s))return e.slice(0,ac(e)+1);if(!e||!(t=Ge(t)))return e;var h=mt(e),p=rc(h,mt(t))+1;return ti(h,0,p).join("")}function m_(e,t,n){if(e=ue(e),e&&(n||t===s))return e.replace(tn,"");if(!e||!(t=Ge(t)))return e;var h=mt(e),p=sc(h,mt(t));return ti(h,p).join("")}function v_(e,t){var n=Kr,h=As;if(be(t)){var p="separator"in t?t.separator:p;n="length"in t?Y(t.length):n,h="omission"in t?Ge(t.omission):h}e=ue(e);var f=e.length;if(Fi(e)){var v=mt(e);f=v.length}if(n>=f)return e;var w=n-ki(h);if(w<1)return h;var E=v?ti(v,0,w).join(""):e.slice(0,w);if(p===s)return E+h;if(v&&(w+=E.length-w),sa(p)){if(e.slice(w).search(p)){var S,x=E;for(p.global||(p=wn(p.source,ue(Po.exec(p))+"g")),p.lastIndex=0;S=p.exec(x);)var R=S.index;E=E.slice(0,R===s?w:R)}}else if(e.indexOf(Ge(p),w)!=w){var D=E.lastIndexOf(p);D>-1&&(E=E.slice(0,D))}return E+h}function w_(e){return e=ue(e),e&&Tg.test(e)?e.replace(bo,Gf):e}var __=Hi(function(e,t,n){return e+(n?" ":"")+t.toUpperCase()}),aa=Gc("toUpperCase");function Bh(e,t,n){return e=ue(e),t=n?s:t,t===s?Hf(e)?Yf(e):Nf(e):e.match(t)||[]}var Jh=X(function(e,t){try{return Be(e,s,t)}catch(n){return ia(n)?n:new W(n)}}),b_=Ht(function(e,t){return tt(t,function(n){n=Ot(n),zt(e,n,ea(e[n],e))}),e});function E_(e){var t=e==null?0:e.length,n=z();return e=t?we(e,function(h){if(typeof h[1]!="function")throw new it(l);return[n(h[0]),h[1]]}):[],X(function(h){for(var p=-1;++p<t;){var f=e[p];if(Be(f[0],this,h))return Be(f[1],this,h)}})}function I_(e){return Gy(rt(e,O))}function oa(e){return function(){return e}}function P_(e,t){return e==null||e!==e?t:e}var C_=Qc(),S_=Qc(!0);function He(e){return e}function ca(e){return Sc(typeof e=="function"?e:rt(e,O))}function x_(e){return Rc(rt(e,O))}function R_(e,t){return Tc(e,rt(t,O))}var T_=X(function(e,t){return function(n){return ms(n,e,t)}}),O_=X(function(e,t){return function(n){return ms(e,n,t)}});function ha(e,t,n){var h=Oe(t),p=ir(t,h);n==null&&!(be(t)&&(p.length||!h.length))&&(n=t,t=e,e=this,p=ir(t,Oe(t)));var f=!(be(n)&&"chain"in n)||!!n.chain,v=Vt(e);return tt(p,function(w){var E=t[w];e[w]=E,v&&(e.prototype[w]=function(){var S=this.__chain__;if(f||S){var x=e(this.__wrapped__),R=x.__actions__=Le(this.__actions__);return R.push({func:E,args:arguments,thisArg:e}),x.__chain__=S,x}return E.apply(e,Wt([this.value()],arguments))})}),e}function A_(){return qe._===this&&(qe._=sy),this}function ua(){}function q_(e){return e=Y(e),X(function(t){return Oc(t,e)})}var D_=zn(we),N_=zn(Yo),F_=zn(pn);function Gh(e){return Gn(e)?dn(Ot(e)):lm(e)}function k_(e){return function(t){return e==null?s:fi(e,t)}}var M_=Zc(),$_=Zc(!0);function la(){return[]}function pa(){return!1}function j_(){return{}}function L_(){return""}function z_(){return!0}function U_(e,t){if(e=Y(e),e<1||e>_e)return[];var n=Ke,h=Ne(e,Ke);t=z(t),e-=Ke;for(var p=yn(h,t);++n<e;)t(n);return p}function H_(e){return Q(e)?we(e,Ot):We(e)?[e]:Le(gh(ue(e)))}function K_(e){var t=++ty;return ue(e)+t}var V_=cr(function(e,t){return e+t},0),B_=Un("ceil"),J_=cr(function(e,t){return e/t},1),G_=Un("floor");function W_(e){return e&&e.length?tr(e,He,xn):s}function Q_(e,t){return e&&e.length?tr(e,z(t,2),xn):s}function Y_(e){return ec(e,He)}function Z_(e,t){return ec(e,z(t,2))}function X_(e){return e&&e.length?tr(e,He,An):s}function eb(e,t){return e&&e.length?tr(e,z(t,2),An):s}var tb=cr(function(e,t){return e*t},1),ib=Un("round"),sb=cr(function(e,t){return e-t},0);function rb(e){return e&&e.length?fn(e,He):0}function nb(e,t){return e&&e.length?fn(e,z(t,2)):0}return g.after=x0,g.ary=Ch,g.assign=gw,g.assignIn=jh,g.assignInWith=br,g.assignWith=fw,g.at=yw,g.before=Sh,g.bind=ea,g.bindAll=b_,g.bindKey=xh,g.castArray=j0,g.chain=Eh,g.chunk=Gm,g.compact=Wm,g.concat=Qm,g.cond=E_,g.conforms=I_,g.constant=oa,g.countBy=r0,g.create=mw,g.curry=Rh,g.curryRight=Th,g.debounce=Oh,g.defaults=vw,g.defaultsDeep=ww,g.defer=R0,g.delay=T0,g.difference=Ym,g.differenceBy=Zm,g.differenceWith=Xm,g.drop=ev,g.dropRight=tv,g.dropRightWhile=iv,g.dropWhile=sv,g.fill=rv,g.filter=a0,g.flatMap=h0,g.flatMapDeep=u0,g.flatMapDepth=l0,g.flatten=vh,g.flattenDeep=nv,g.flattenDepth=av,g.flip=O0,g.flow=C_,g.flowRight=S_,g.fromPairs=ov,g.functions=Sw,g.functionsIn=xw,g.groupBy=p0,g.initial=hv,g.intersection=uv,g.intersectionBy=lv,g.intersectionWith=pv,g.invert=Tw,g.invertBy=Ow,g.invokeMap=g0,g.iteratee=ca,g.keyBy=f0,g.keys=Oe,g.keysIn=Ue,g.map=fr,g.mapKeys=qw,g.mapValues=Dw,g.matches=x_,g.matchesProperty=R_,g.memoize=mr,g.merge=Nw,g.mergeWith=Lh,g.method=T_,g.methodOf=O_,g.mixin=ha,g.negate=vr,g.nthArg=q_,g.omit=Fw,g.omitBy=kw,g.once=A0,g.orderBy=y0,g.over=D_,g.overArgs=q0,g.overEvery=N_,g.overSome=F_,g.partial=ta,g.partialRight=Ah,g.partition=m0,g.pick=Mw,g.pickBy=zh,g.property=Gh,g.propertyOf=k_,g.pull=yv,g.pullAll=_h,g.pullAllBy=mv,g.pullAllWith=vv,g.pullAt=wv,g.range=M_,g.rangeRight=$_,g.rearg=D0,g.reject=_0,g.remove=_v,g.rest=N0,g.reverse=Zn,g.sampleSize=E0,g.set=jw,g.setWith=Lw,g.shuffle=I0,g.slice=bv,g.sortBy=S0,g.sortedUniq=Rv,g.sortedUniqBy=Tv,g.split=h_,g.spread=F0,g.tail=Ov,g.take=Av,g.takeRight=qv,g.takeRightWhile=Dv,g.takeWhile=Nv,g.tap=Wv,g.throttle=k0,g.thru=gr,g.toArray=kh,g.toPairs=Uh,g.toPairsIn=Hh,g.toPath=H_,g.toPlainObject=$h,g.transform=zw,g.unary=M0,g.union=Fv,g.unionBy=kv,g.unionWith=Mv,g.uniq=$v,g.uniqBy=jv,g.uniqWith=Lv,g.unset=Uw,g.unzip=Xn,g.unzipWith=bh,g.update=Hw,g.updateWith=Kw,g.values=Bi,g.valuesIn=Vw,g.without=zv,g.words=Bh,g.wrap=$0,g.xor=Uv,g.xorBy=Hv,g.xorWith=Kv,g.zip=Vv,g.zipObject=Bv,g.zipObjectDeep=Jv,g.zipWith=Gv,g.entries=Uh,g.entriesIn=Hh,g.extend=jh,g.extendWith=br,ha(g,g),g.add=V_,g.attempt=Jh,g.camelCase=Ww,g.capitalize=Kh,g.ceil=B_,g.clamp=Bw,g.clone=L0,g.cloneDeep=U0,g.cloneDeepWith=H0,g.cloneWith=z0,g.conformsTo=K0,g.deburr=Vh,g.defaultTo=P_,g.divide=J_,g.endsWith=Qw,g.eq=wt,g.escape=Yw,g.escapeRegExp=Zw,g.every=n0,g.find=o0,g.findIndex=yh,g.findKey=_w,g.findLast=c0,g.findLastIndex=mh,g.findLastKey=bw,g.floor=G_,g.forEach=Ih,g.forEachRight=Ph,g.forIn=Ew,g.forInRight=Iw,g.forOwn=Pw,g.forOwnRight=Cw,g.get=ra,g.gt=V0,g.gte=B0,g.has=Rw,g.hasIn=na,g.head=wh,g.identity=He,g.includes=d0,g.indexOf=cv,g.inRange=Jw,g.invoke=Aw,g.isArguments=vi,g.isArray=Q,g.isArrayBuffer=J0,g.isArrayLike=ze,g.isArrayLikeObject=Pe,g.isBoolean=G0,g.isBuffer=ii,g.isDate=W0,g.isElement=Q0,g.isEmpty=Y0,g.isEqual=Z0,g.isEqualWith=X0,g.isError=ia,g.isFinite=ew,g.isFunction=Vt,g.isInteger=qh,g.isLength=wr,g.isMap=Dh,g.isMatch=tw,g.isMatchWith=iw,g.isNaN=sw,g.isNative=rw,g.isNil=aw,g.isNull=nw,g.isNumber=Nh,g.isObject=be,g.isObjectLike=Ie,g.isPlainObject=Is,g.isRegExp=sa,g.isSafeInteger=ow,g.isSet=Fh,g.isString=_r,g.isSymbol=We,g.isTypedArray=Vi,g.isUndefined=cw,g.isWeakMap=hw,g.isWeakSet=uw,g.join=dv,g.kebabCase=Xw,g.last=at,g.lastIndexOf=gv,g.lowerCase=e_,g.lowerFirst=t_,g.lt=lw,g.lte=pw,g.max=W_,g.maxBy=Q_,g.mean=Y_,g.meanBy=Z_,g.min=X_,g.minBy=eb,g.stubArray=la,g.stubFalse=pa,g.stubObject=j_,g.stubString=L_,g.stubTrue=z_,g.multiply=tb,g.nth=fv,g.noConflict=A_,g.noop=ua,g.now=yr,g.pad=i_,g.padEnd=s_,g.padStart=r_,g.parseInt=n_,g.random=Gw,g.reduce=v0,g.reduceRight=w0,g.repeat=a_,g.replace=o_,g.result=$w,g.round=ib,g.runInContext=b,g.sample=b0,g.size=P0,g.snakeCase=c_,g.some=C0,g.sortedIndex=Ev,g.sortedIndexBy=Iv,g.sortedIndexOf=Pv,g.sortedLastIndex=Cv,g.sortedLastIndexBy=Sv,g.sortedLastIndexOf=xv,g.startCase=u_,g.startsWith=l_,g.subtract=sb,g.sum=rb,g.sumBy=nb,g.template=p_,g.times=U_,g.toFinite=Bt,g.toInteger=Y,g.toLength=Mh,g.toLower=d_,g.toNumber=ot,g.toSafeInteger=dw,g.toString=ue,g.toUpper=g_,g.trim=f_,g.trimEnd=y_,g.trimStart=m_,g.truncate=v_,g.unescape=w_,g.uniqueId=K_,g.upperCase=__,g.upperFirst=aa,g.each=Ih,g.eachRight=Ph,g.first=wh,ha(g,function(){var e={};return Rt(g,function(t,n){le.call(g.prototype,n)||(e[n]=t)}),e}(),{chain:!1}),g.VERSION=a,tt(["bind","bindKey","curry","curryRight","partial","partialRight"],function(e){g[e].placeholder=g}),tt(["drop","take"],function(e,t){ie.prototype[e]=function(n){n=n===s?1:Re(Y(n),0);var h=this.__filtered__&&!t?new ie(this):this.clone();return h.__filtered__?h.__takeCount__=Ne(n,h.__takeCount__):h.__views__.push({size:Ne(n,Ke),type:e+(h.__dir__<0?"Right":"")}),h},ie.prototype[e+"Right"]=function(n){return this.reverse()[e](n).reverse()}}),tt(["filter","map","takeWhile"],function(e,t){var n=t+1,h=n==Ri||n==ci;ie.prototype[e]=function(p){var f=this.clone();return f.__iteratees__.push({iteratee:z(p,3),type:n}),f.__filtered__=f.__filtered__||h,f}}),tt(["head","last"],function(e,t){var n="take"+(t?"Right":"");ie.prototype[e]=function(){return this[n](1).value()[0]}}),tt(["initial","tail"],function(e,t){var n="drop"+(t?"":"Right");ie.prototype[e]=function(){return this.__filtered__?new ie(this):this[n](1)}}),ie.prototype.compact=function(){return this.filter(He)},ie.prototype.find=function(e){return this.filter(e).head()},ie.prototype.findLast=function(e){return this.reverse().find(e)},ie.prototype.invokeMap=X(function(e,t){return typeof e=="function"?new ie(this):this.map(function(n){return ms(n,e,t)})}),ie.prototype.reject=function(e){return this.filter(vr(z(e)))},ie.prototype.slice=function(e,t){e=Y(e);var n=this;return n.__filtered__&&(e>0||t<0)?new ie(n):(e<0?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==s&&(t=Y(t),n=t<0?n.dropRight(-t):n.take(t-e)),n)},ie.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},ie.prototype.toArray=function(){return this.take(Ke)},Rt(ie.prototype,function(e,t){var n=/^(?:filter|find|map|reject)|While$/.test(t),h=/^(?:head|last)$/.test(t),p=g[h?"take"+(t=="last"?"Right":""):t],f=h||/^find/.test(t);p&&(g.prototype[t]=function(){var v=this.__wrapped__,w=h?[1]:arguments,E=v instanceof ie,S=w[0],x=E||Q(v),R=function(ee){var ne=p.apply(g,Wt([ee],w));return h&&D?ne[0]:ne};x&&n&&typeof S=="function"&&S.length!=1&&(E=x=!1);var D=this.__chain__,L=!!this.__actions__.length,U=f&&!D,Z=E&&!L;if(!f&&x){v=Z?v:new ie(this);var H=e.apply(v,w);return H.__actions__.push({func:gr,args:[R],thisArg:s}),new st(H,D)}return U&&Z?e.apply(this,w):(H=this.thru(R),U?h?H.value()[0]:H.value():H)})}),tt(["pop","push","shift","sort","splice","unshift"],function(e){var t=Ls[e],n=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",h=/^(?:pop|shift)$/.test(e);g.prototype[e]=function(){var p=arguments;if(h&&!this.__chain__){var f=this.value();return t.apply(Q(f)?f:[],p)}return this[n](function(v){return t.apply(Q(v)?v:[],p)})}}),Rt(ie.prototype,function(e,t){var n=g[t];if(n){var h=n.name+"";le.call(Li,h)||(Li[h]=[]),Li[h].push({name:t,func:n})}}),Li[or(s,$).name]=[{name:"wrapper",func:s}],ie.prototype.clone=wy,ie.prototype.reverse=_y,ie.prototype.value=by,g.prototype.at=Qv,g.prototype.chain=Yv,g.prototype.commit=Zv,g.prototype.next=Xv,g.prototype.plant=t0,g.prototype.reverse=i0,g.prototype.toJSON=g.prototype.valueOf=g.prototype.value=s0,g.prototype.first=g.prototype.head,us&&(g.prototype[us]=e0),g},Mi=Zf();ui?((ui.exports=Mi)._=Mi,cn._=Mi):qe._=Mi}).call(Xi)})(Nr,Nr.exports);var Nd=Object.defineProperty,Fd=Object.defineProperties,kd=Object.getOwnPropertyDescriptors,no=Object.getOwnPropertySymbols,Md=Object.prototype.hasOwnProperty,$d=Object.prototype.propertyIsEnumerable,ao=(y,r,s)=>r in y?Nd(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,xs=(y,r)=>{for(var s in r||(r={}))Md.call(r,s)&&ao(y,s,r[s]);if(no)for(var s of no(r))$d.call(r,s)&&ao(y,s,r[s]);return y},jd=(y,r)=>Fd(y,kd(r));function dt(y,r,s){var a;const o=(0,d.DQe)(y);return((a=r.rpcMap)==null?void 0:a[o.reference])||`${Dd}?chainId=${o.namespace}:${o.reference}&projectId=${s}`}function oi(y){return y.includes(":")?y.split(":")[1]:y}function oo(y){return y.map(r=>`${r.split(":")[0]}:${r.split(":")[1]}`)}function Ld(y,r){const s=Object.keys(r.namespaces).filter(o=>o.includes(y));if(!s.length)return[];const a=[];return s.forEach(o=>{const u=r.namespaces[o].accounts;a.push(...u)}),a}function Fr(y={},r={}){const s=co(y),a=co(r);return Nr.exports.merge(s,a)}function co(y){var r,s,a,o;const u={};if(!(0,d.L5o)(y))return u;for(const[l,m]of Object.entries(y)){const _=(0,d.gpE)(l)?[l]:m.chains,I=m.methods||[],T=m.events||[],O=m.rpcMap||{},q=(0,d.Maj)(l);u[q]=jd(xs(xs({},u[q]),m),{chains:(0,d.eGA)(_,(r=u[q])==null?void 0:r.chains),methods:(0,d.eGA)(I,(s=u[q])==null?void 0:s.methods),events:(0,d.eGA)(T,(a=u[q])==null?void 0:a.events),rpcMap:xs(xs({},O),(o=u[q])==null?void 0:o.rpcMap)})}return u}function zd(y){return y.includes(":")?y.split(":")[2]:y}function ho(y){const r={};for(const[s,a]of Object.entries(y)){const o=a.methods||[],u=a.events||[],l=a.accounts||[],m=(0,d.gpE)(s)?[s]:a.chains?a.chains:oo(a.accounts);r[s]={chains:m,methods:o,events:u,accounts:l}}return r}function kr(y){return typeof y=="number"?y:y.includes("0x")?parseInt(y,16):(y=y.includes(":")?y.split(":")[1]:y,isNaN(Number(y))?y:Number(y))}const uo={},he=y=>uo[y],Mr=(y,r)=>{uo[y]=r};class Ud{constructor(r){this.name="polkadot",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${r}`)}getAccounts(){const r=this.namespace.accounts;return r?r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2])||[]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;const o=oi(s);r[o]=this.createHttpProvider(o,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}var Hd=Object.defineProperty,Kd=Object.defineProperties,Vd=Object.getOwnPropertyDescriptors,lo=Object.getOwnPropertySymbols,Bd=Object.prototype.hasOwnProperty,Jd=Object.prototype.propertyIsEnumerable,po=(y,r,s)=>r in y?Hd(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,go=(y,r)=>{for(var s in r||(r={}))Bd.call(r,s)&&po(y,s,r[s]);if(lo)for(var s of lo(r))Jd.call(r,s)&&po(y,s,r[s]);return y},fo=(y,r)=>Kd(y,Vd(r));class Gd{constructor(r){this.name="eip155",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain())}async request(r){switch(r.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(r);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(r)}return this.namespace.methods.includes(r.request.method)?await this.client.request(r):this.getHttpProvider().request(r.request)}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(parseInt(r),s),this.chainId=parseInt(r),this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${r}`)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}createHttpProvider(r,s){const a=s||dt(`${this.name}:${r}`,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.k(a,he("disableProviderPing")))}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;const o=parseInt(oi(s));r[o]=this.createHttpProvider(o,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}getHttpProvider(){const r=this.chainId,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}async handleSwitchChain(r){var s,a;let o=r.request.params?(s=r.request.params[0])==null?void 0:s.chainId:"0x0";o=o.startsWith("0x")?o:`0x${o}`;const u=parseInt(o,16);if(this.isChainApproved(u))this.setDefaultChain(`${u}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:r.topic,request:{method:r.request.method,params:[{chainId:o}]},chainId:(a=this.namespace.chains)==null?void 0:a[0]}),this.setDefaultChain(`${u}`);else throw new Error(`Failed to switch to chain 'eip155:${u}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(r){return this.namespace.chains.includes(`${this.name}:${r}`)}async getCapabilities(r){var s,a,o;const u=(a=(s=r.request)==null?void 0:s.params)==null?void 0:a[0];if(!u)throw new Error("Missing address parameter in `wallet_getCapabilities` request");const l=this.client.session.get(r.topic),m=((o=l==null?void 0:l.sessionProperties)==null?void 0:o.capabilities)||{};if(m!=null&&m[u])return m==null?void 0:m[u];const _=await this.client.request(r);try{await this.client.session.update(r.topic,{sessionProperties:fo(go({},l.sessionProperties||{}),{capabilities:fo(go({},m||{}),{[u]:_})})})}catch(I){console.warn("Failed to update session with capabilities",I)}return _}}class Wd{constructor(r){this.name="solana",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${r}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;const o=oi(s);r[o]=this.createHttpProvider(o,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class Qd{constructor(r){this.name="cosmos",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;const o=oi(s);r[o]=this.createHttpProvider(o,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class Yd{constructor(r){this.name="algorand",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){if(!this.httpProviders[r]){const a=s||dt(`${this.name}:${r}`,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);this.setHttpProvider(r,a)}this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;r[s]=this.createHttpProvider(s,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);return typeof a>"u"?void 0:new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class Zd{constructor(r){this.name="cip34",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{const a=this.getCardanoRPCUrl(s),o=oi(s);r[o]=this.createHttpProvider(o,a)}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}getCardanoRPCUrl(r){const s=this.namespace.rpcMap;if(s)return s[r]}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||this.getCardanoRPCUrl(r);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class Xd{constructor(r){this.name="elrond",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${r}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;const o=oi(s);r[o]=this.createHttpProvider(o,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class eg{constructor(r){this.name="multiversx",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${r}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;const o=oi(s);r[o]=this.createHttpProvider(o,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class tg{constructor(r){this.name="near",this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace=Object.assign(this.namespace,r)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider().request(r.request)}setDefaultChain(r,s){if(this.chainId=r,!this.httpProviders[r]){const a=s||dt(`${this.name}:${r}`,this.namespace);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);this.setHttpProvider(r,a)}this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const r=this.namespace.accounts;return r?r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2])||[]:[]}createHttpProviders(){const r={};return this.namespace.chains.forEach(s=>{var a;r[s]=this.createHttpProvider(s,(a=this.namespace.rpcMap)==null?void 0:a[s])}),r}getHttpProvider(){const r=`${this.name}:${this.chainId}`,s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace);return typeof a>"u"?void 0:new ct.r(new Ct.Z(a,he("disableProviderPing")))}}class ig{constructor(r){this.name=Ci,this.namespace=r.namespace,this.events=he("events"),this.client=he("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(r){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(r.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(r.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(r.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(r.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(r){return this.namespace.methods.includes(r.request.method)?this.client.request(r):this.getHttpProvider(r.chainId).request(r.request)}setDefaultChain(r,s){this.httpProviders[r]||this.setHttpProvider(r,s),this.chainId=r,this.events.emit(pt.DEFAULT_CHAIN_CHANGED,`${this.name}:${r}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const r=this.namespace.chains[0];if(!r)throw new Error("ChainId not found");return r.split(":")[1]}getAccounts(){const r=this.namespace.accounts;return r?[...new Set(r.filter(s=>s.split(":")[1]===this.chainId.toString()).map(s=>s.split(":")[2]))]:[]}createHttpProviders(){var r,s;const a={};return(s=(r=this.namespace)==null?void 0:r.accounts)==null||s.forEach(o=>{const u=(0,d.DQe)(o);a[`${u.namespace}:${u.reference}`]=this.createHttpProvider(o)}),a}getHttpProvider(r){const s=this.httpProviders[r];if(typeof s>"u")throw new Error(`JSON-RPC provider for ${r} not found`);return s}setHttpProvider(r,s){const a=this.createHttpProvider(r,s);a&&(this.httpProviders[r]=a)}createHttpProvider(r,s){const a=s||dt(r,this.namespace,this.client.core.projectId);if(!a)throw new Error(`No RPC url provided for chainId: ${r}`);return new ct.r(new Ct.Z(a,he("disableProviderPing")))}}var sg=Object.defineProperty,rg=Object.defineProperties,ng=Object.getOwnPropertyDescriptors,yo=Object.getOwnPropertySymbols,ag=Object.prototype.hasOwnProperty,og=Object.prototype.propertyIsEnumerable,mo=(y,r,s)=>r in y?sg(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Rs=(y,r)=>{for(var s in r||(r={}))ag.call(r,s)&&mo(y,s,r[s]);if(yo)for(var s of yo(r))og.call(r,s)&&mo(y,s,r[s]);return y},$r=(y,r)=>rg(y,ng(r));class jr{constructor(r){this.events=new(Er()),this.rpcProviders={},this.shouldAbortPairingAttempt=!1,this.maxPairingAttempts=10,this.disableProviderPing=!1,this.providerOpts=r,this.logger=typeof(r==null?void 0:r.logger)<"u"&&typeof(r==null?void 0:r.logger)!="string"?r.logger:(0,te.gw)((0,te.jI)({level:(r==null?void 0:r.logger)||so})),this.disableProviderPing=(r==null?void 0:r.disableProviderPing)||!1}static async init(r){const s=new jr(r);return await s.initialize(),s}async request(r,s,a){const[o,u]=this.validateChain(s);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(o).request({request:Rs({},r),chainId:`${o}:${u}`,topic:this.session.topic,expiry:a})}sendAsync(r,s,a,o){const u=new Date().getTime();this.request(r,a,o).then(l=>s(null,(0,K.formatJsonRpcResult)(u,l))).catch(l=>s(l,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties}),await this.requestAccounts()}async disconnect(){var r;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(r=this.session)==null?void 0:r.topic,reason:(0,d.D6H)("USER_DISCONNECTED")}),await this.cleanup()}async connect(r){if(!this.client)throw new Error("Sign Client not initialized");if(this.setNamespaces(r),await this.cleanupPendingPairings(),!r.skipPairing)return await this.pair(r.pairingTopic)}async authenticate(r,s){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(r),await this.cleanupPendingPairings();const{uri:a,response:o}=await this.client.authenticate(r,s);a&&(this.uri=a,this.events.emit("display_uri",a));const u=await o();if(this.session=u.session,this.session){const l=ho(this.session.namespaces);this.namespaces=Fr(this.namespaces,l),this.persist("namespaces",this.namespaces),this.onConnect()}return u}on(r,s){this.events.on(r,s)}once(r,s){this.events.once(r,s)}removeListener(r,s){this.events.removeListener(r,s)}off(r,s){this.events.off(r,s)}get isWalletConnect(){return!0}async pair(r){this.shouldAbortPairingAttempt=!1;let s=0;do{if(this.shouldAbortPairingAttempt)throw new Error("Pairing aborted");if(s>=this.maxPairingAttempts)throw new Error("Max auto pairing attempts reached");const{uri:a,approval:o}=await this.client.connect({pairingTopic:r,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties});a&&(this.uri=a,this.events.emit("display_uri",a)),await o().then(u=>{this.session=u;const l=ho(u.namespaces);this.namespaces=Fr(this.namespaces,l),this.persist("namespaces",this.namespaces)}).catch(u=>{if(u.message!==eo)throw u;s++})}while(!this.session);return this.onConnect(),this.session}setDefaultChain(r,s){try{if(!this.session)return;const[a,o]=this.validateChain(r),u=this.getProvider(a);u.name===Ci?u.setDefaultChain(`${a}:${o}`,s):u.setDefaultChain(o,s)}catch(a){if(!/Please call connect/.test(a.message))throw a}}async cleanupPendingPairings(r={}){this.logger.info("Cleaning up inactive pairings...");const s=this.client.pairing.getAll();if((0,d.qt8)(s)){for(const a of s)r.deletePairings?this.client.core.expirer.set(a.topic,0):await this.client.core.relayer.subscriber.unsubscribe(a.topic);this.logger.info(`Inactive pairings cleared: ${s.length}`)}}abortPairingAttempt(){this.shouldAbortPairingAttempt=!0}async checkStorage(){if(this.namespaces=await this.getFromStore("namespaces"),this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.client.session.length){const r=this.client.session.keys.length-1;this.session=this.client.session.get(this.client.session.keys[r]),this.createProviders()}}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){this.client=this.providerOpts.client||await Dr.init({core:this.providerOpts.core,logger:this.providerOpts.logger||so,relayUrl:this.providerOpts.relayUrl||Od,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");const r=[...new Set(Object.keys(this.session.namespaces).map(s=>(0,d.Maj)(s)))];Mr("client",this.client),Mr("events",this.events),Mr("disableProviderPing",this.disableProviderPing),r.forEach(s=>{if(!this.session)return;const a=Ld(s,this.session),o=oo(a),u=Fr(this.namespaces,this.optionalNamespaces),l=$r(Rs({},u[s]),{accounts:a,chains:o});switch(s){case"eip155":this.rpcProviders[s]=new Gd({namespace:l});break;case"algorand":this.rpcProviders[s]=new Yd({namespace:l});break;case"solana":this.rpcProviders[s]=new Wd({namespace:l});break;case"cosmos":this.rpcProviders[s]=new Qd({namespace:l});break;case"polkadot":this.rpcProviders[s]=new Ud({namespace:l});break;case"cip34":this.rpcProviders[s]=new Zd({namespace:l});break;case"elrond":this.rpcProviders[s]=new Xd({namespace:l});break;case"multiversx":this.rpcProviders[s]=new eg({namespace:l});break;case"near":this.rpcProviders[s]=new tg({namespace:l});break;default:this.rpcProviders[Ci]?this.rpcProviders[Ci].updateNamespace(l):this.rpcProviders[Ci]=new ig({namespace:l})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",r=>{this.events.emit("session_ping",r)}),this.client.on("session_event",r=>{const{params:s}=r,{event:a}=s;if(a.name==="accountsChanged"){const o=a.data;o&&(0,d.qt8)(o)&&this.events.emit("accountsChanged",o.map(zd))}else if(a.name==="chainChanged"){const o=s.chainId,u=s.event.data,l=(0,d.Maj)(o),m=kr(o)!==kr(u)?`${l}:${kr(u)}`:o;this.onChainChanged(m)}else this.events.emit(a.name,a.data);this.events.emit("session_event",r)}),this.client.on("session_update",({topic:r,params:s})=>{var a;const{namespaces:o}=s,u=(a=this.client)==null?void 0:a.session.get(r);this.session=$r(Rs({},u),{namespaces:o}),this.onSessionUpdate(),this.events.emit("session_update",{topic:r,params:s})}),this.client.on("session_delete",async r=>{await this.cleanup(),this.events.emit("session_delete",r),this.events.emit("disconnect",$r(Rs({},(0,d.D6H)("USER_DISCONNECTED")),{data:r.topic}))}),this.on(pt.DEFAULT_CHAIN_CHANGED,r=>{this.onChainChanged(r,!0)})}getProvider(r){return this.rpcProviders[r]||this.rpcProviders[Ci]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(r=>{var s;this.getProvider(r).updateNamespace((s=this.session)==null?void 0:s.namespaces[r])})}setNamespaces(r){const{namespaces:s,optionalNamespaces:a,sessionProperties:o}=r;s&&Object.keys(s).length&&(this.namespaces=s),a&&Object.keys(a).length&&(this.optionalNamespaces=a),this.sessionProperties=o,this.persist("namespaces",s),this.persist("optionalNamespaces",a)}validateChain(r){const[s,a]=(r==null?void 0:r.split(":"))||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[s,a];if(s&&!Object.keys(this.namespaces||{}).map(l=>(0,d.Maj)(l)).includes(s))throw new Error(`Namespace '${s}' is not configured. Please call connect() first with namespace config.`);if(s&&a)return[s,a];const o=(0,d.Maj)(Object.keys(this.namespaces)[0]),u=this.rpcProviders[o].getDefaultChain();return[o,u]}async requestAccounts(){const[r]=this.validateChain();return await this.getProvider(r).requestAccounts()}onChainChanged(r,s=!1){if(!this.namespaces)return;const[a,o]=this.validateChain(r);o&&(s||this.getProvider(a).setDefaultChain(o),this.namespaces[a]?this.namespaces[a].defaultChain=o:this.namespaces[`${a}:${o}`]?this.namespaces[`${a}:${o}`].defaultChain=o:this.namespaces[`${a}:${o}`]={defaultChain:o},this.persist("namespaces",this.namespaces),this.events.emit("chainChanged",o))}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.session=void 0,this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,this.persist("namespaces",void 0),this.persist("optionalNamespaces",void 0),this.persist("sessionProperties",void 0),await this.cleanupPendingPairings({deletePairings:!0})}persist(r,s){this.client.core.storage.setItem(`${ro}/${r}`,s)}async getFromStore(r){return await this.client.core.storage.getItem(`${ro}/${r}`)}}const cg=jr,hg="wc",ug="ethereum_provider",lg=`${hg}@2:${ug}:`,pg="https://rpc.walletconnect.com/v1/",Lr=["eth_sendTransaction","personal_sign"],dg=["eth_accounts","eth_requestAccounts","eth_sendRawTransaction","eth_sign","eth_signTransaction","eth_signTypedData","eth_signTypedData_v3","eth_signTypedData_v4","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode","wallet_sendCalls","wallet_getCapabilities","wallet_getCallsStatus","wallet_showCallsStatus"],zr=["chainChanged","accountsChanged"],gg=["chainChanged","accountsChanged","message","disconnect","connect"];var fg=Object.defineProperty,yg=Object.defineProperties,mg=Object.getOwnPropertyDescriptors,vo=Object.getOwnPropertySymbols,vg=Object.prototype.hasOwnProperty,wg=Object.prototype.propertyIsEnumerable,wo=(y,r,s)=>r in y?fg(y,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):y[r]=s,Si=(y,r)=>{for(var s in r||(r={}))vg.call(r,s)&&wo(y,s,r[s]);if(vo)for(var s of vo(r))wg.call(r,s)&&wo(y,s,r[s]);return y},Ur=(y,r)=>yg(y,mg(r));function Ts(y){return Number(y[0].split(":")[1])}function Os(y){return`0x${y.toString(16)}`}function _g(y){const{chains:r,optionalChains:s,methods:a,optionalMethods:o,events:u,optionalEvents:l,rpcMap:m}=y;if(!(0,d.qt8)(r))throw new Error("Invalid chains");const _={chains:r,methods:a||Lr,events:u||zr,rpcMap:Si({},r.length?{[Ts(r)]:m[Ts(r)]}:{})},I=u==null?void 0:u.filter(A=>!zr.includes(A)),T=a==null?void 0:a.filter(A=>!Lr.includes(A));if(!s&&!l&&!o&&!(I!=null&&I.length)&&!(T!=null&&T.length))return{required:r.length?_:void 0};const O=(I==null?void 0:I.length)&&(T==null?void 0:T.length)||!s,q={chains:[...new Set(O?_.chains.concat(s||[]):s)],methods:[...new Set(_.methods.concat(o!=null&&o.length?o:dg))],events:[...new Set(_.events.concat(l!=null&&l.length?l:gg))],rpcMap:m};return{required:r.length?_:void 0,optional:s.length?q:void 0}}class Hr{constructor(){this.events=new At.EventEmitter,this.namespace="eip155",this.accounts=[],this.chainId=1,this.STORAGE_KEY=lg,this.on=(r,s)=>(this.events.on(r,s),this),this.once=(r,s)=>(this.events.once(r,s),this),this.removeListener=(r,s)=>(this.events.removeListener(r,s),this),this.off=(r,s)=>(this.events.off(r,s),this),this.parseAccount=r=>this.isCompatibleChainId(r)?this.parseAccountId(r).address:r,this.signer={},this.rpc={}}static async init(r){const s=new Hr;return await s.initialize(r),s}async request(r,s){return await this.signer.request(r,this.formatChainId(this.chainId),s)}sendAsync(r,s,a){this.signer.sendAsync(r,s,this.formatChainId(this.chainId),a)}get connected(){return this.signer.client?this.signer.client.core.relayer.connected:!1}get connecting(){return this.signer.client?this.signer.client.core.relayer.connecting:!1}async enable(){return this.session||await this.connect(),await this.request({method:"eth_requestAccounts"})}async connect(r){if(!this.signer.client)throw new Error("Provider not initialized. Call init() first");this.loadConnectOpts(r);const{required:s,optional:a}=_g(this.rpc);try{const o=await new Promise(async(l,m)=>{var _;this.rpc.showQrModal&&((_=this.modal)==null||_.subscribeModal(I=>{!I.open&&!this.signer.session&&(this.signer.abortPairingAttempt(),m(new Error("Connection request reset. Please try again.")))})),await this.signer.connect(Ur(Si({namespaces:Si({},s&&{[this.namespace]:s})},a&&{optionalNamespaces:{[this.namespace]:a}}),{pairingTopic:r==null?void 0:r.pairingTopic})).then(I=>{l(I)}).catch(I=>{m(new Error(I.message))})});if(!o)return;const u=(0,d.guN)(o.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:u),this.setAccounts(u),this.events.emit("connect",{chainId:Os(this.chainId)})}catch(o){throw this.signer.logger.error(o),o}finally{this.modal&&this.modal.closeModal()}}async authenticate(r,s){if(!this.signer.client)throw new Error("Provider not initialized. Call init() first");this.loadConnectOpts({chains:r==null?void 0:r.chains});try{const a=await new Promise(async(u,l)=>{var m;this.rpc.showQrModal&&((m=this.modal)==null||m.subscribeModal(_=>{!_.open&&!this.signer.session&&(this.signer.abortPairingAttempt(),l(new Error("Connection request reset. Please try again.")))})),await this.signer.authenticate(Ur(Si({},r),{chains:this.rpc.chains}),s).then(_=>{u(_)}).catch(_=>{l(new Error(_.message))})}),o=a.session;if(o){const u=(0,d.guN)(o.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:u),this.setAccounts(u),this.events.emit("connect",{chainId:Os(this.chainId)})}return a}catch(a){throw this.signer.logger.error(a),a}finally{this.modal&&this.modal.closeModal()}}async disconnect(){this.session&&await this.signer.disconnect(),this.reset()}get isWalletConnect(){return!0}get session(){return this.signer.session}registerEventListeners(){this.signer.on("session_event",r=>{const{params:s}=r,{event:a}=s;a.name==="accountsChanged"?(this.accounts=this.parseAccounts(a.data),this.events.emit("accountsChanged",this.accounts)):a.name==="chainChanged"?this.setChainId(this.formatChainId(a.data)):this.events.emit(a.name,a.data),this.events.emit("session_event",r)}),this.signer.on("chainChanged",r=>{const s=parseInt(r);this.chainId=s,this.events.emit("chainChanged",Os(this.chainId)),this.persist()}),this.signer.on("session_update",r=>{this.events.emit("session_update",r)}),this.signer.on("session_delete",r=>{this.reset(),this.events.emit("session_delete",r),this.events.emit("disconnect",Ur(Si({},(0,d.D6H)("USER_DISCONNECTED")),{data:r.topic,name:"USER_DISCONNECTED"}))}),this.signer.on("display_uri",r=>{var s,a;this.rpc.showQrModal&&((s=this.modal)==null||s.closeModal(),(a=this.modal)==null||a.openModal({uri:r})),this.events.emit("display_uri",r)})}switchEthereumChain(r){this.request({method:"wallet_switchEthereumChain",params:[{chainId:r.toString(16)}]})}isCompatibleChainId(r){return typeof r=="string"?r.startsWith(`${this.namespace}:`):!1}formatChainId(r){return`${this.namespace}:${r}`}parseChainId(r){return Number(r.split(":")[1])}setChainIds(r){const s=r.filter(a=>this.isCompatibleChainId(a)).map(a=>this.parseChainId(a));s.length&&(this.chainId=s[0],this.events.emit("chainChanged",Os(this.chainId)),this.persist())}setChainId(r){if(this.isCompatibleChainId(r)){const s=this.parseChainId(r);this.chainId=s,this.switchEthereumChain(s)}}parseAccountId(r){const[s,a,o]=r.split(":");return{chainId:`${s}:${a}`,address:o}}setAccounts(r){this.accounts=r.filter(s=>this.parseChainId(this.parseAccountId(s).chainId)===this.chainId).map(s=>this.parseAccountId(s).address),this.events.emit("accountsChanged",this.accounts)}getRpcConfig(r){var s,a;const o=(s=r==null?void 0:r.chains)!=null?s:[],u=(a=r==null?void 0:r.optionalChains)!=null?a:[],l=o.concat(u);if(!l.length)throw new Error("No chains specified in either `chains` or `optionalChains`");const m=o.length?(r==null?void 0:r.methods)||Lr:[],_=o.length?(r==null?void 0:r.events)||zr:[],I=(r==null?void 0:r.optionalMethods)||[],T=(r==null?void 0:r.optionalEvents)||[],O=(r==null?void 0:r.rpcMap)||this.buildRpcMap(l,r.projectId),q=(r==null?void 0:r.qrModalOptions)||void 0;return{chains:o==null?void 0:o.map(A=>this.formatChainId(A)),optionalChains:u.map(A=>this.formatChainId(A)),methods:m,events:_,optionalMethods:I,optionalEvents:T,rpcMap:O,showQrModal:!!(r!=null&&r.showQrModal),qrModalOptions:q,projectId:r.projectId,metadata:r.metadata}}buildRpcMap(r,s){const a={};return r.forEach(o=>{a[o]=this.getRpcUrl(o,s)}),a}async initialize(r){if(this.rpc=this.getRpcConfig(r),this.chainId=this.rpc.chains.length?Ts(this.rpc.chains):Ts(this.rpc.optionalChains),this.signer=await cg.init({projectId:this.rpc.projectId,metadata:this.rpc.metadata,disableProviderPing:r.disableProviderPing,relayUrl:r.relayUrl,storageOptions:r.storageOptions,customStoragePrefix:r.customStoragePrefix,telemetryEnabled:r.telemetryEnabled}),this.registerEventListeners(),await this.loadPersistedSession(),this.rpc.showQrModal){let s;try{const{WalletConnectModal:a}=await se.e(9877).then(se.bind(se,9877));s=a}catch{throw new Error("To use QR modal, please install @walletconnect/modal package")}if(s)try{this.modal=new s(Si({projectId:this.rpc.projectId},this.rpc.qrModalOptions))}catch(a){throw this.signer.logger.error(a),new Error("Could not generate WalletConnectModal Instance")}}}loadConnectOpts(r){if(!r)return;const{chains:s,optionalChains:a,rpcMap:o}=r;s&&(0,d.qt8)(s)&&(this.rpc.chains=s.map(u=>this.formatChainId(u)),s.forEach(u=>{this.rpc.rpcMap[u]=(o==null?void 0:o[u])||this.getRpcUrl(u)})),a&&(0,d.qt8)(a)&&(this.rpc.optionalChains=[],this.rpc.optionalChains=a==null?void 0:a.map(u=>this.formatChainId(u)),a.forEach(u=>{this.rpc.rpcMap[u]=(o==null?void 0:o[u])||this.getRpcUrl(u)}))}getRpcUrl(r,s){var a;return((a=this.rpc.rpcMap)==null?void 0:a[r])||`${pg}?chainId=eip155:${r}&projectId=${s||this.rpc.projectId}`}async loadPersistedSession(){if(this.session)try{const r=await this.signer.client.core.storage.getItem(`${this.STORAGE_KEY}/chainId`),s=this.session.namespaces[`${this.namespace}:${r}`]?this.session.namespaces[`${this.namespace}:${r}`]:this.session.namespaces[this.namespace];this.setChainIds(r?[this.formatChainId(r)]:s==null?void 0:s.accounts),this.setAccounts(s==null?void 0:s.accounts)}catch(r){this.signer.logger.error("Failed to load persisted session, clearing state..."),this.signer.logger.error(r),await this.disconnect().catch(s=>this.signer.logger.warn(s))}}reset(){this.chainId=1,this.accounts=[]}persist(){this.session&&this.signer.client.core.storage.setItem(`${this.STORAGE_KEY}/chainId`,this.chainId)}parseAccounts(r){return typeof r=="string"||r instanceof String?[this.parseAccount(r)]:r.map(s=>this.parseAccount(s))}}const bg=Hr}}]);
